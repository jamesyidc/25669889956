<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tooltipç»Ÿè®¡éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
        }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .highlight {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š Tooltip ç´¯ç§¯ç»Ÿè®¡é€»è¾‘éªŒè¯</h1>
    
    <div class="test-result info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤é¡µé¢éªŒè¯tooltipä¸­æ˜¾ç¤ºçš„ä¸Šæ¶¨å æ¯”ç»Ÿè®¡æ˜¯å¦ä¸º<strong>ç´¯ç§¯ç»Ÿè®¡</strong>ï¼ˆä»00:30åˆ°å½“å‰æ‚¬åœæ—¶é—´ç‚¹ï¼‰</p>
        <p>âœ… æ­£ç¡®è¡Œä¸ºï¼šæ¯ä¸ªæ—¶é—´ç‚¹çš„ç»Ÿè®¡å€¼åº”è¯¥ä¸åŒ</p>
        <p>âŒ é”™è¯¯è¡Œä¸ºï¼šæ‰€æœ‰æ—¶é—´ç‚¹æ˜¾ç¤ºç›¸åŒçš„ç»Ÿè®¡å€¼ï¼ˆå…¨å¤©ç»Ÿè®¡ï¼‰</p>
    </div>

    <div id="results"></div>

    <script>
        async function runTest() {
            const resultsDiv = document.getElementById('results');
            
            try {
                // è·å–ä»Šå¤©çš„å†å²æ•°æ®
                const response = await fetch('/api/coin-change-tracker/history?limit=1440');
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    resultsDiv.innerHTML = '<div class="test-result" style="background: #f8d7da; border-left: 4px solid #dc3545;">âŒ æ— æ³•åŠ è½½æ•°æ®</div>';
                    return;
                }
                
                const historyData = result.data;
                
                // æ¨¡æ‹Ÿtooltipçš„ç´¯ç§¯ç»Ÿè®¡é€»è¾‘
                const testPoints = [
                    { index: 5, label: 'ç¬¬6ä¸ªæ•°æ®ç‚¹ (çº¦00:36)' },
                    { index: 50, label: 'ç¬¬51ä¸ªæ•°æ®ç‚¹ (çº¦02:00)' },
                    { index: 200, label: 'ç¬¬201ä¸ªæ•°æ®ç‚¹ (çº¦05:00)' },
                    { index: 400, label: 'ç¬¬401ä¸ªæ•°æ®ç‚¹ (çº¦10:00)' },
                    { index: historyData.length - 1, label: 'æœ€åä¸€ä¸ªæ•°æ®ç‚¹ (å½“å‰æ—¶é—´)' }
                ];
                
                let tableHTML = '<h2>æµ‹è¯•ç»“æœ</h2><table><thead><tr><th>æµ‹è¯•ç‚¹</th><th>æ—¶é—´</th><th>å½“å‰ä¸Šæ¶¨å æ¯”</th><th>å¹³å‡å€¼</th><th>æœ€å°å€¼</th><th>æœ€å¤§å€¼</th><th>æ•°æ®ç‚¹æ•°</th></tr></thead><tbody>';
                
                for (const testPoint of testPoints) {
                    const dataIndex = Math.min(testPoint.index, historyData.length - 1);
                    const currentData = historyData[dataIndex];
                    
                    // è®¡ç®—æˆªæ­¢åˆ°å½“å‰æ—¶é—´ç‚¹çš„ç´¯ç§¯ç»Ÿè®¡
                    const upRatiosUpToNow = [];
                    
                    for (let i = 0; i <= dataIndex; i++) {
                        if (historyData[i]) {
                            let ratio = null;
                            
                            // ä¼˜å…ˆä½¿ç”¨up_ratioå­—æ®µ
                            if (historyData[i].up_ratio !== undefined) {
                                ratio = historyData[i].up_ratio;
                            } else if (historyData[i].changes) {
                                // å¦åˆ™ä»changesè®¡ç®—
                                const changes = historyData[i].changes;
                                const changesArray = Object.values(changes);
                                const upCoins = changesArray.filter(coin => coin.change_pct > 0).length;
                                const totalCoins = changesArray.length;
                                if (totalCoins > 0) {
                                    ratio = (upCoins / totalCoins * 100);
                                }
                            }
                            
                            // åªç»Ÿè®¡æ—¶é—´>=00:30çš„æ•°æ®
                            let timeStr = '';
                            if (historyData[i].beijing_time) {
                                timeStr = historyData[i].beijing_time.split(' ')[1] || '';
                            } else if (historyData[i].time) {
                                timeStr = historyData[i].time;
                            }
                            
                            if (ratio !== null && timeStr >= '00:30:00') {
                                upRatiosUpToNow.push(ratio);
                            }
                        }
                    }
                    
                    // è®¡ç®—ç»Ÿè®¡å€¼
                    let avgUpRatio = null;
                    let minUpRatio = null;
                    let maxUpRatio = null;
                    
                    if (upRatiosUpToNow.length > 0) {
                        avgUpRatio = upRatiosUpToNow.reduce((sum, v) => sum + v, 0) / upRatiosUpToNow.length;
                        minUpRatio = Math.min(...upRatiosUpToNow);
                        maxUpRatio = Math.max(...upRatiosUpToNow);
                    }
                    
                    const currentUpRatio = currentData.up_ratio || '--';
                    const timeStr = currentData.beijing_time || currentData.time || '--';
                    
                    tableHTML += `<tr>
                        <td>${testPoint.label}</td>
                        <td>${timeStr}</td>
                        <td class="highlight">${currentUpRatio}%</td>
                        <td class="highlight">${avgUpRatio !== null ? avgUpRatio.toFixed(1) : '--'}%</td>
                        <td class="highlight">${minUpRatio !== null ? minUpRatio.toFixed(1) : '--'}%</td>
                        <td class="highlight">${maxUpRatio !== null ? maxUpRatio.toFixed(1) : '--'}%</td>
                        <td>${upRatiosUpToNow.length}</td>
                    </tr>`;
                }
                
                tableHTML += '</tbody></table>';
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¹³å‡å€¼éƒ½ç›¸åŒï¼ˆé”™è¯¯æƒ…å†µï¼‰
                const avgValues = testPoints.map((tp, idx) => {
                    const dataIndex = Math.min(tp.index, historyData.length - 1);
                    const upRatiosUpToNow = [];
                    
                    for (let i = 0; i <= dataIndex; i++) {
                        if (historyData[i]) {
                            let ratio = historyData[i].up_ratio;
                            let timeStr = historyData[i].beijing_time ? historyData[i].beijing_time.split(' ')[1] : historyData[i].time;
                            if (ratio !== null && ratio !== undefined && timeStr >= '00:30:00') {
                                upRatiosUpToNow.push(ratio);
                            }
                        }
                    }
                    
                    if (upRatiosUpToNow.length > 0) {
                        return upRatiosUpToNow.reduce((sum, v) => sum + v, 0) / upRatiosUpToNow.length;
                    }
                    return null;
                });
                
                const allSame = avgValues.every((v, i, arr) => v === arr[0]);
                
                if (allSame) {
                    resultsDiv.innerHTML = '<div class="test-result" style="background: #f8d7da; border-left: 4px solid #dc3545;"><h3>âŒ æµ‹è¯•å¤±è´¥</h3><p>æ‰€æœ‰æ—¶é—´ç‚¹çš„å¹³å‡å€¼éƒ½ç›¸åŒï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼</p><p>åº”è¯¥æ˜¾ç¤ºç´¯ç§¯ç»Ÿè®¡ï¼Œæ¯ä¸ªæ—¶é—´ç‚¹çš„ç»Ÿè®¡å€¼åº”è¯¥ä¸åŒã€‚</p></div>' + tableHTML;
                } else {
                    resultsDiv.innerHTML = '<div class="test-result success"><h3>âœ… æµ‹è¯•é€šè¿‡</h3><p>ä¸åŒæ—¶é—´ç‚¹çš„ç»Ÿè®¡å€¼ä¸åŒï¼Œç´¯ç§¯ç»Ÿè®¡é€»è¾‘æ­£ç¡®ï¼</p></div>' + tableHTML;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result" style="background: #f8d7da; border-left: 4px solid #dc3545;">âŒ æµ‹è¯•å‡ºé”™: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        window.addEventListener('load', runTest);
    </script>
</body>
</html>
