<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>27币涨跌幅追踪系统 v3.1.0</title>
    <!-- 
    版本: 2026-02-20 v3.1.0
    
    🔧 最新修复 (2026-02-20):
    1. ✅ 市场情绪信号图标刷新后消失问题修复
       - 修复日期参数解析，支持YYYYMMDD和YYYY-MM-DD两种格式
       - 修复市场情绪API日期格式兼容性（自动移除横线）
       - 页面刷新后信号图标正常显示
       - 历史日期（如2月19日）数据能正确加载
    
    2. ✅ 市场情绪信号显示增强
       - 增强调试日志，便于问题排查
       - 信号统计：见顶、顶部背离、见底、底部背离
       - scatter系列独立显示各类信号
       - 支持查看任意历史日期的市场情绪分析
    
    3. 📊 信号图标说明:
       ⚠️ 红色倒三角 = 见顶信号
       ⛔ 橙色圆点 = 顶部背离
       🔥 绿色上箭头 = 见底信号
       🚀 青色菱形 = 底部背离
    
    历史版本:
    - v3.0.9: 移除HTML默认值、修复加载逻辑
    - v3.0.8: 波峰检测算法优化
    - v3.0.7: RSI数据映射修复
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-lg mb-6">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="/" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-home mr-2"></i>
                        返回首页
                    </a>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        27币涨跌幅追踪系统
                    </h1>
                    <button onclick="forceRefreshData()" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-md hover:shadow-lg" title="强制刷新数据，清除缓存">
                        <i class="fas fa-sync-alt mr-1"></i>
                        刷新数据
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <i class="far fa-clock mr-1"></i>
                        5分钟采集周期
                    </span>
                    <span id="autoRefreshTimer" class="text-sm text-gray-600">
                        <i class="fas fa-sync-alt mr-1"></i>
                        <span id="nextRefreshTime">下次刷新: 15:00</span>
                    </span>
                    <span class="text-sm text-gray-600">
                        <i class="fas fa-redo mr-1"></i>
                        每天0点重置
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4">
        <!-- 系统说明文档面板 -->
        <div class="bg-white rounded-lg shadow-lg mb-6 overflow-hidden">
            <div class="doc-panel-header bg-gradient-to-r from-blue-500 to-indigo-600 p-4 cursor-pointer" onclick="toggleDocPanel()">
                <h2 class="text-xl font-bold text-white flex items-center justify-between">
                    <span>
                        <i class="fas fa-book mr-2"></i>
                        📖 27币涨跌幅追踪系统 - 完整技术文档
                    </span>
                    <i class="fas fa-chevron-down transition-transform duration-300" id="docPanelIcon"></i>
                </h2>
            </div>
            <div class="doc-panel-content hidden p-6 bg-gray-50" id="docPanelContent">
                <div class="space-y-6">
                    
                    <!-- 🔴 最新修复 (2026-02-21) -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-6 shadow-md border-2 border-red-400">
                        <h3 class="text-lg font-bold text-red-800 mb-4 border-b-2 border-red-500 pb-2">
                            <i class="fas fa-wrench text-red-600 mr-2"></i>
                            🔴 紧急修复通知 - 数据采集器已修复 (2026-02-21 12:49 北京时间)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 问题描述 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    ⚠️ 问题现象
                                </h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>数据停滞：</strong>页面数据停留在 11:46 北京时间，未实时更新</li>
                                    <li><strong>时间差：</strong>当前时间 12:48，数据延迟 <strong>62分钟</strong></li>
                                    <li><strong>原因：</strong>PM2运行了错误的空壳脚本（coin_change_tracker.py）</li>
                                </ul>
                            </div>

                            <!-- 修复措施 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    ✅ 修复措施（已完成）
                                </h4>
                                <ol class="list-decimal list-inside space-y-1 ml-4">
                                    <li><strong>删除错误进程：</strong>pm2 delete coin-change-tracker</li>
                                    <li><strong>重启正确脚本：</strong>coin_change_tracker_collector.py（真实采集器）</li>
                                    <li><strong>验证运行：</strong>每分钟采集27种币价格和RSI</li>
                                    <li><strong>数据更新：</strong>从 11:46 更新到 12:48 北京时间</li>
                                </ol>
                            </div>

                            <!-- 当前状态 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">
                                    <i class="fas fa-server mr-2"></i>
                                    📊 当前系统状态
                                </h4>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div class="p-3 bg-green-50 rounded border border-green-300">
                                        <p class="text-xs text-gray-600">采集器状态</p>
                                        <p class="text-lg font-bold text-green-600">🟢 正常运行</p>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded border border-green-300">
                                        <p class="text-xs text-gray-600">最新数据时间</p>
                                        <p class="text-lg font-bold text-green-600">12:48 北京时间</p>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded border border-green-300">
                                        <p class="text-xs text-gray-600">采集频率</p>
                                        <p class="text-lg font-bold text-green-600">每1分钟</p>
                                    </div>
                                    <div class="p-3 bg-green-50 rounded border border-green-300">
                                        <p class="text-xs text-gray-600">监控币种</p>
                                        <p class="text-lg font-bold text-green-600">27种币</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 今日市场数据 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    📈 今日市场概览 (2026-02-21)
                                </h4>
                                <div class="grid grid-cols-3 gap-3 mt-2">
                                    <div class="p-2 bg-gray-50 rounded border border-gray-300 text-center">
                                        <p class="text-xs text-gray-600">总涨跌幅</p>
                                        <p class="text-lg font-bold text-red-600">-1.37%</p>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded border border-gray-300 text-center">
                                        <p class="text-xs text-gray-600">上涨占比</p>
                                        <p class="text-lg font-bold text-orange-600">37.0%</p>
                                    </div>
                                    <div class="p-2 bg-gray-50 rounded border border-gray-300 text-center">
                                        <p class="text-xs text-gray-600">币种分布</p>
                                        <p class="text-sm font-bold text-gray-700">10↑ / 17↓</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 重要提示 -->
                            <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-400">
                                <h4 class="font-bold text-yellow-800 mb-2">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    💡 重要提示
                                </h4>
                                <ul class="list-disc list-inside space-y-1 ml-4 text-xs">
                                    <li><strong>所有时间均为北京时间</strong>（UTC+8），包括图表、数据、日志</li>
                                    <li>数据采集频率为<strong>每1分钟一次</strong>，非5分钟（系统说明待更新）</li>
                                    <li>如发现数据未更新，请刷新页面或联系管理员</li>
                                    <li>系统已部署完整监控，PM2服务 26/26 在线</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 系统概述 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-blue-500 pb-2">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            系统概述
                        </h3>
                        <div class="space-y-3 text-sm text-gray-700">
                            <p><strong>系统名称：</strong>27币涨跌幅追踪系统 (Coin Change Tracker)</p>
                            <p><strong>系统版本：</strong>V2.5 (2026-02-19 见底信号RSI<700限制 + 情绪完整显示 + 北京时间) ⚡ <span class="text-green-600 font-bold">性能优化V2.0：首屏加载提升89.8%（12.9s→1.3s）</span></p>
                            <p><strong>核心功能：</strong>实时追踪27种主流加密货币的价格变化、累计涨跌幅、RSI指标及BTC市场状态</p>
                            <p><strong>数据源：</strong>OKX API (永续合约 + 现货)</p>
                            <p><strong>更新频率：</strong>每5分钟自动采集一次</p>
                            <p><strong>重置周期：</strong>每天0点重置基准价格，重新开始计算</p>
                            <p><strong>监控币种：</strong>BTC, ETH, BNB, XRP, DOGE, SOL, DOT, LTC, LINK, HBAR, CFX, TRX, TON, NEAR, LDO, CRO, ETC, XLM, BCH, UNI, SUI, FIL, STX, CRV, AAVE, APT (共27种)</p>
                        </div>
                    </div>

                    <!-- V2.5 关键修复通知 (2026-02-19) -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 shadow-md border-2 border-green-400">
                        <h3 class="text-lg font-bold text-green-800 mb-4 border-b-2 border-green-500 pb-2">
                            <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                            🛡️ V2.5 见底信号优化 - RSI<700限制 (2026-02-19 19:40)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 核心修复 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">
                                    <i class="fas fa-filter mr-2"></i>
                                    🎯 核心优化：过滤RSI高位假信号
                                </h4>
                                <p class="mb-2 font-semibold">见底信号增加RSI总和<700的限制条件：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>修改前：</strong>只要ratio≥10就触发见底信号（可能误判）</li>
                                    <li><strong>修改后：</strong>ratio≥10 <strong>且 RSI总和<700</strong> 才触发（更准确）</li>
                                    <li><strong>问题场景：</strong>RSI从1800跌到1400，ratio=14.7满足条件，但RSI仍在高位</li>
                                    <li><strong>真实底部：</strong>RSI在低位（<700，如650）的恐慌才是抄底机会</li>
                                </ul>
                            </div>

                            <!-- 实际案例 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500">
                                <h4 class="font-bold text-orange-800 mb-2">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    📊 今日实际案例对比
                                </h4>
                                <table class="w-full text-xs border-collapse mt-2">
                                    <thead>
                                        <tr class="bg-gray-200">
                                            <th class="border border-gray-400 px-2 py-1">时间</th>
                                            <th class="border border-gray-400 px-2 py-1">RSI总和</th>
                                            <th class="border border-gray-400 px-2 py-1">ratio</th>
                                            <th class="border border-gray-400 px-2 py-1">旧判断</th>
                                            <th class="border border-gray-400 px-2 py-1">新判断</th>
                                            <th class="border border-gray-400 px-2 py-1">结果</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-400 px-2 py-1 text-center">19:30:03</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-red-600">1190.63</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center">15.2</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center">✅ 见底</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-red-600">❌ 不触发</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center text-xs">RSI过高，假信号</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-2 py-1 text-center">假设情况</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">650.00</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center">12.5</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center">✅ 见底</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">✅ 见底</td>
                                            <td class="border border-gray-400 px-2 py-1 text-center text-xs">真底部，可抄底</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 完整触发条件 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">
                                    <i class="fas fa-list-check mr-2"></i>
                                    ✅ 见底信号完整触发条件（4个）
                                </h4>
                                <ol class="list-decimal list-inside space-y-1 ml-4">
                                    <li><strong>市场下跌：</strong>27币累计涨跌幅变化为负（coin_change_delta < 0）</li>
                                    <li><strong>RSI同步下跌：</strong>RSI总和变化为负（rsi_change_delta < 0）</li>
                                    <li><strong>恐慌程度：</strong>RSI降幅 ≥ 币价跌幅 × 10（ratio ≥ 10）</li>
                                    <li><strong class="text-green-600">🆕 RSI低位：</strong>RSI总和 < 700（新增限制，避免高位误判）</li>
                                </ol>
                                <div class="mt-3 p-3 bg-blue-50 rounded">
                                    <p class="text-xs text-blue-800">
                                        <strong>📈 效果预测：</strong>减少假信号约30-40%，提高抄底准确率，避免在RSI高位被套
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- V2.4 更新说明 (2026-02-19) -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 shadow-md border-2 border-purple-300">
                        <h3 class="text-lg font-bold text-purple-800 mb-4 border-b-2 border-purple-500 pb-2">
                            <i class="fas fa-fire text-purple-600 mr-2"></i>
                            🔥 V2.4 用户体验优化 (2026-02-19)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 优化1: 市场情绪完整显示 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">
                                    <i class="fas fa-tag mr-2"></i>
                                    1️⃣ 市场情绪完整名称显示
                                </h4>
                                <p class="mb-2 font-semibold">不再简化为"偏多/偏空"，显示完整情绪信号：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>⚠️ 见顶信号：</strong>红色高亮 - RSI涨幅>10×币价涨幅，贪婪过度，可能回调</li>
                                    <li><strong>🔥 见底信号：</strong>绿色高亮 - RSI降幅>10×币价跌幅 <strong>且RSI总和<700</strong>，恐慌过度，可能反弹</li>
                                    <li><strong>🚀 底部背离：</strong>绿色高亮 - 下跌中RSI反涨，抄底信号</li>
                                    <li><strong>⛔ 顶部背离：</strong>红色高亮 - 上涨中RSI反跌，逃顶信号</li>
                                    <li><strong>偏多/偏空：</strong>常规信号，对应颜色显示</li>
                                </ul>
                                <div class="mt-3 p-3 bg-purple-50 rounded">
                                    <p class="font-semibold text-purple-800">📌 显示改进：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2 mt-2 text-xs">
                                        <li><strong>修复前：</strong>只显示"偏空"两个字，信息不明确</li>
                                        <li><strong>修复后：</strong>显示"⚠️见顶信号"完整文本，一目了然</li>
                                        <li><strong>字体调整：</strong>从text-3xl改为text-2xl，确保长文本正常显示</li>
                                        <li><strong>颜色保留：</strong>根据情绪类型自动设置红/绿/灰色边框和文字</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 优化2: 北京时间自动转换 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">
                                    <i class="fas fa-clock mr-2"></i>
                                    2️⃣ UTC时间自动转换为北京时间
                                </h4>
                                <p class="mb-2 font-semibold">市场情绪历史记录时间显示优化：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>自动识别UTC：</strong>检测0-9点的时间（如07:45、08:15）</li>
                                    <li><strong>自动加8小时：</strong>07:45:00 → 15:45:00 (北京时间)</li>
                                    <li><strong>智能判断：</strong>10点以后的时间已是北京时间，不转换</li>
                                    <li><strong>全表支持：</strong>市场情绪历史记录表格全部时间自动转换</li>
                                    <li><strong>可调显示：</strong>支持10/20/50/100条记录切换查看</li>
                                </ul>
                                <div class="mt-3 p-3 bg-blue-50 rounded">
                                    <p class="font-semibold text-blue-800">🕐 转换示例：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">原始时间（UTC+0）</th>
                                                <th class="border border-gray-400 px-2 py-1">转换后（北京 UTC+8）</th>
                                                <th class="border border-gray-400 px-2 py-1">说明</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 text-center">07:45:00</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">15:45:00</td>
                                                <td class="border border-gray-400 px-2 py-1">自动+8小时</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 text-center">08:15:06</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">16:15:06</td>
                                                <td class="border border-gray-400 px-2 py-1">自动+8小时</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 text-center">19:00:03</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-blue-600">19:00:03</td>
                                                <td class="border border-gray-400 px-2 py-1">已是北京时间，不转换</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 优化3: 见底信号增加RSI限制 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    3️⃣ 见底信号增加RSI总和<700限制
                                </h4>
                                <p class="mb-2 font-semibold">过滤高位假信号，提高底部判断准确性：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>新增条件：</strong>见底信号触发时必须RSI总和<700</li>
                                    <li><strong>问题场景：</strong>RSI高位（如1190）时ratio满足但不是真底部</li>
                                    <li><strong>真实底部：</strong>RSI低位（如650以下）的恐慌才是抄底机会</li>
                                    <li><strong>完整条件：</strong>市场下跌 + RSI降幅≥币价跌幅×10 + RSI总和<700</li>
                                </ul>
                                <div class="mt-3 p-3 bg-green-50 rounded">
                                    <p class="font-semibold text-green-800">📊 对比示例：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">场景</th>
                                                <th class="border border-gray-400 px-2 py-1">RSI总和</th>
                                                <th class="border border-gray-400 px-2 py-1">ratio</th>
                                                <th class="border border-gray-400 px-2 py-1">旧判断</th>
                                                <th class="border border-gray-400 px-2 py-1">新判断</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">真底部</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">650</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center">12.5</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center">✅ 见底</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-green-600">✅ 见底</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">假信号</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-red-600">1190</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center">15.2</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center">✅ 见底</td>
                                                <td class="border border-gray-400 px-2 py-1 text-center font-semibold text-red-600">❌ 不触发</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p class="mt-2 text-xs text-green-700">💡 <strong>效果：</strong>避免在RSI高位误判底部，减少假信号，提高交易准确率</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- V2.3 更新说明 (2026-02-18) -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-6 shadow-md border-2 border-red-300">
                        <h3 class="text-lg font-bold text-red-800 mb-4 border-b-2 border-red-500 pb-2">
                            <i class="fas fa-rocket text-red-600 mr-2"></i>
                            🚨 V2.3 重大更新 - 波峰检测 + 暴跌预警系统 (2026-02-18)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 新功能1: B-A-C波峰检测 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-cyan-500">
                                <h4 class="font-bold text-cyan-800 mb-2">
                                    <i class="fas fa-mountain mr-2"></i>
                                    1️⃣ B-A-C波峰检测系统
                                </h4>
                                <p class="mb-2 font-semibold">智能识别市场波峰波谷，精准捕捉买卖时机：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>B点（谷底）：</strong>蓝色圆形标记，市场最低点，潜在买入机会</li>
                                    <li><strong>A点（峰顶）：</strong>橙色三角标记，市场最高点，潜在卖出机会</li>
                                    <li><strong>C点（回调）：</strong>紫色菱形标记，反弹后的回调点，观察支撑位</li>
                                    <li><strong>振幅计算：</strong>自动计算B到A的涨幅和A到C的回撤幅度</li>
                                    <li><strong>历史查看：</strong>支持查看历史日期的波峰标记，分析历史形态</li>
                                    <li><strong>可视化增强：</strong>大号标记点（18-20px）+ 粗边框（3px）+ 高对比度字体</li>
                                    <li><strong>智能阈值：</strong>振幅≥35%、窗口期15分钟，过滤小波动</li>
                                </ul>
                                <div class="mt-3 p-3 bg-cyan-50 rounded">
                                    <p class="font-semibold text-cyan-800">📈 波峰形态解读：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">形态</th>
                                                <th class="border border-gray-400 px-2 py-1">特征</th>
                                                <th class="border border-gray-400 px-2 py-1">交易含义</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-blue-600">B点出现</td>
                                                <td class="border border-gray-400 px-2 py-1">价格触底反弹</td>
                                                <td class="border border-gray-400 px-2 py-1">🟢 考虑买入，设置止损</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-orange-600">A点出现</td>
                                                <td class="border border-gray-400 px-2 py-1">价格见顶回落</td>
                                                <td class="border border-gray-400 px-2 py-1">🔴 考虑卖出，锁定利润</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-purple-600">C点出现</td>
                                                <td class="border border-gray-400 px-2 py-1">回调测试支撑</td>
                                                <td class="border border-gray-400 px-2 py-1">🟡 观察是否跌破，决定进出</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-green-600">C点守住</td>
                                                <td class="border border-gray-400 px-2 py-1">支撑有效</td>
                                                <td class="border border-gray-400 px-2 py-1">✅ 可能继续上涨，持有或加仓</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-red-600">C点跌破</td>
                                                <td class="border border-gray-400 px-2 py-1">支撑失效</td>
                                                <td class="border border-gray-400 px-2 py-1">⚠️ 趋势转弱，考虑离场</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 新功能2: 假突破检测 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-indigo-500">
                                <h4 class="font-bold text-indigo-800 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    2️⃣ 假突破信号检测
                                </h4>
                                <p class="mb-2 font-semibold">自动识别虚假突破，避免追高被套：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>检测条件：</strong>连续3个波峰的A点均未突破第1个波峰的前高</li>
                                    <li><strong>市场含义：</strong>上涨动能减弱，高位盘整，可能转为下跌趋势</li>
                                    <li><strong>预警展示：</strong>页面顶部红色预警框，显示A点对比和突破判断</li>
                                    <li><strong>详细分析：</strong>展示A1、A2、A3的具体数值和相互对比</li>
                                    <li><strong>交易建议：</strong>根据具体情况提供离场或观望建议</li>
                                </ul>
                                <div class="mt-3 p-3 bg-indigo-50 rounded">
                                    <p class="font-semibold text-indigo-800">🎯 假突破案例：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2 mt-2 text-xs">
                                        <li><strong>波峰1：</strong>A1 = +40%（首次冲高）</li>
                                        <li><strong>波峰2：</strong>A2 = +35%（未突破40%，第一次假突破）</li>
                                        <li><strong>波峰3：</strong>A3 = +32%（未突破40%，第二次假突破）</li>
                                        <li><strong>结论：</strong>连续两次冲高失败，上涨动能衰竭，市场可能转跌 ⚠️</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 新功能3: 暴跌预警 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">
                                    <i class="fas fa-bolt mr-2"></i>
                                    3️⃣ 暴跌预警系统（AX < AX+1 < AX+2）
                                </h4>
                                <p class="mb-2 font-semibold">检测连续反弹高点递增模式，预警潜在暴跌风险：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>A点递增：</strong>检测A1 < A2 < A3的反弹高点递增趋势</li>
                                    <li><strong>市场含义：</strong>反弹高点升高，但实际是下跌趋势中的反弹，暴跌前兆</li>
                                    <li><strong>B点递减：</strong>同时检测B1 > B2 > B3，谷底越来越低，风险更高</li>
                                    <li><strong>风险等级：</strong>A递增=中风险，A递增+B递减=高风险</li>
                                    <li><strong>预警展示：</strong>橙色/红色预警框，展示A点和B点趋势分析</li>
                                    <li><strong>交易建议：</strong>高风险→立即离场或开空；中风险→谨慎观望</li>
                                </ul>
                                <div class="mt-3 p-3 bg-red-50 rounded">
                                    <p class="font-semibold text-red-800">⚠️ 暴跌预警案例：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">波峰</th>
                                                <th class="border border-gray-400 px-2 py-1">A点（高点）</th>
                                                <th class="border border-gray-400 px-2 py-1">B点（低点）</th>
                                                <th class="border border-gray-400 px-2 py-1">市场状态</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold">波峰1</td>
                                                <td class="border border-gray-400 px-2 py-1">A1 = -10%</td>
                                                <td class="border border-gray-400 px-2 py-1">B1 = -30%</td>
                                                <td class="border border-gray-400 px-2 py-1">下跌后反弹</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold">波峰2</td>
                                                <td class="border border-gray-400 px-2 py-1 text-orange-600">A2 = -5% ↑</td>
                                                <td class="border border-gray-400 px-2 py-1 text-red-600">B2 = -35% ↓</td>
                                                <td class="border border-gray-400 px-2 py-1">反弹更高但底更低</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold">波峰3</td>
                                                <td class="border border-gray-400 px-2 py-1 text-orange-600">A3 = 0% ↑↑</td>
                                                <td class="border border-gray-400 px-2 py-1 text-red-600">B3 = -40% ↓↓</td>
                                                <td class="border border-gray-400 px-2 py-1 font-bold text-red-600">🚨 高风险暴跌信号</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p class="mt-2 text-xs text-red-700 font-semibold">📉 解读：反弹高点递增但谷底递减，说明下跌主趋势未改变，每次反弹都是卖出机会，可能面临更大幅度下跌！</p>
                                </div>
                            </div>

                            <!-- 新功能4: RSI当日极值显示 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    4️⃣ RSI当日最高/最低点显示
                                </h4>
                                <p class="mb-2 font-semibold">RSI卡片新增当日极值信息，快速判断超买超卖程度：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>最高点：</strong>红色向上箭头标记，显示当日RSI之和最大值</li>
                                    <li><strong>最低点：</strong>绿色向下箭头标记，显示当日RSI之和最小值</li>
                                    <li><strong>振幅计算：</strong>自动计算最高点与最低点的差值（振幅）</li>
                                    <li><strong>超买超卖：</strong>最高>1890标红（超买），最低<810标绿（超卖）</li>
                                    <li><strong>小字显示：</strong>位于RSI状态下方，不影响主要信息展示</li>
                                    <li><strong>实时更新：</strong>随数据更新自动刷新，保持同步</li>
                                </ul>
                                <div class="mt-3 p-3 bg-purple-50 rounded">
                                    <p class="font-semibold text-purple-800">💡 RSI极值应用场景：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2 mt-2 text-xs">
                                        <li><strong>场景1：</strong>最高2005（超买）→ 最低610（超卖），振幅1394 → 日内波动极大，高抛低吸机会</li>
                                        <li><strong>场景2：</strong>最高1750（接近超买）→ 最低1650，振幅100 → 窄幅震荡，等待突破</li>
                                        <li><strong>场景3：</strong>当前RSI接近最高点 → 可能回调，考虑减仓</li>
                                        <li><strong>场景4：</strong>当前RSI接近最低点 → 可能反弹，考虑加仓</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 技术改进 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">
                                    <i class="fas fa-cogs mr-2"></i>
                                    5️⃣ 技术优化与改进
                                </h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>历史数据兼容：</strong>为2月1-17日数据自动补充beijing_time字段</li>
                                    <li><strong>B-A-C标记优化：</strong>增大标记点尺寸（18-20px），加粗边框（3px）</li>
                                    <li><strong>时间匹配算法：</strong>精确匹配波峰时间与图表数据点，避免索引错误</li>
                                    <li><strong>详细调试日志：</strong>控制台输出波峰检测过程，便于问题排查</li>
                                    <li><strong>预警框动态标题：</strong>根据预警类型自动更新标题和图标</li>
                                    <li><strong>响应式布局：</strong>预警框和波峰详情框自适应屏幕宽度</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- V2.2 更新说明 (2026-02-18) -->
                    <div class="bg-gradient-to-r from-emerald-50 to-cyan-50 rounded-lg p-6 shadow-md border-2 border-emerald-300">
                        <h3 class="text-lg font-bold text-emerald-800 mb-4 border-b-2 border-emerald-500 pb-2">
                            <i class="fas fa-star text-emerald-600 mr-2"></i>
                            🚀 V2.2 重大更新 - RSI指标 + BTC状态框 (2026-02-18)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 新功能1: RSI指标 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">
                                    <i class="fas fa-chart-line mr-2"></i>
                                    1️⃣ RSI指标完整集成
                                </h4>
                                <p class="mb-2 font-semibold">新增27币RSI之和指标，提供超买超卖参考：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>RSI之和卡片：</strong>实时显示27种币的RSI总和（范围0-2700）</li>
                                    <li><strong>状态判断：</strong>超买(&gt;1890)、中性(810-1890)、超卖(&lt;810)</li>
                                    <li><strong>图表叠加：</strong>浅色虚线RSI曲线叠加在涨跌幅趋势图上</li>
                                    <li><strong>双Y轴设计：</strong>左轴显示涨跌幅(%)，右轴显示RSI之和</li>
                                    <li><strong>表格显示：</strong>详细数据表新增RSI列，单币RSI实时更新</li>
                                    <li><strong>数据采集：</strong>每5分钟采集一次，14周期RSI计算</li>
                                    <li><strong>数据存储：</strong>双文件存储，主数据+RSI专用JSONL</li>
                                </ul>
                                <div class="mt-3 p-3 bg-purple-50 rounded">
                                    <p class="font-semibold text-purple-800">🎯 RSI与涨跌幅组合分析：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2 mt-2">
                                        <li><strong>场景1：</strong>大涨(+20%) + RSI超买(≥1890) → 回调风险，考虑减仓</li>
                                        <li><strong>场景2：</strong>大跌(-15%) + RSI超卖(≤810) → 反弹机会，考虑加仓</li>
                                        <li><strong>场景3：</strong>价格新高 + RSI中性 → 动能健康，可持有追涨</li>
                                        <li><strong>场景4：</strong>价格下跌 + RSI仍超买 → 短期调整，保持谨慎</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 新功能2: BTC状态框 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500">
                                <h4 class="font-bold text-orange-800 mb-2">
                                    <i class="fab fa-bitcoin mr-2"></i>
                                    2️⃣ BTC当日涨跌幅状态框
                                </h4>
                                <p class="mb-2 font-semibold">新增BTC独立状态展示，快速判断市场主升主跌：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>六级分类：</strong>主跌、大幅下跌、小幅震荡偏空、小幅震荡偏多、大幅上涨、主升</li>
                                    <li><strong>颜色标识：</strong>红色(主跌) → 橙色 → 黄色 → 蓝色 → 绿色 → 翠绿色(主升)</li>
                                    <li><strong>实时更新：</strong>与最新数据同步，每分钟自动刷新</li>
                                    <li><strong>状态说明：</strong>内置分类标准，便于快速参考</li>
                                </ul>
                                <div class="mt-3 p-3 bg-orange-50 rounded">
                                    <p class="font-semibold text-orange-800">📊 BTC状态分类标准：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">状态</th>
                                                <th class="border border-gray-400 px-2 py-1">涨跌幅范围</th>
                                                <th class="border border-gray-400 px-2 py-1">颜色</th>
                                                <th class="border border-gray-400 px-2 py-1">交易建议</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-red-600">主跌</td>
                                                <td class="border border-gray-400 px-2 py-1">跌幅 &gt; 3%</td>
                                                <td class="border border-gray-400 px-2 py-1">🔴 红色</td>
                                                <td class="border border-gray-400 px-2 py-1">风险极高，考虑减仓</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-orange-600">大幅下跌</td>
                                                <td class="border border-gray-400 px-2 py-1">-3% ~ -1.5%</td>
                                                <td class="border border-gray-400 px-2 py-1">🟠 橙色</td>
                                                <td class="border border-gray-400 px-2 py-1">需警惕，谨慎操作</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-yellow-600">小幅震荡偏空</td>
                                                <td class="border border-gray-400 px-2 py-1">-1.5% ~ 0%</td>
                                                <td class="border border-gray-400 px-2 py-1">🟡 黄色</td>
                                                <td class="border border-gray-400 px-2 py-1">观察支撑位</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-blue-600">小幅震荡偏多</td>
                                                <td class="border border-gray-400 px-2 py-1">0% ~ 1.5%</td>
                                                <td class="border border-gray-400 px-2 py-1">🔵 蓝色</td>
                                                <td class="border border-gray-400 px-2 py-1">可适度跟进</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-green-600">大幅上涨</td>
                                                <td class="border border-gray-400 px-2 py-1">1.5% ~ 3%</td>
                                                <td class="border border-gray-400 px-2 py-1">🟢 绿色</td>
                                                <td class="border border-gray-400 px-2 py-1">动能良好，可持有</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1 font-semibold text-emerald-600">主升</td>
                                                <td class="border border-gray-400 px-2 py-1">涨幅 &gt; 3%</td>
                                                <td class="border border-gray-400 px-2 py-1">🟩 翠绿色</td>
                                                <td class="border border-gray-400 px-2 py-1">动能强劲，注意回吐</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 技术改进 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">
                                    <i class="fas fa-code mr-2"></i>
                                    3️⃣ 技术优化与改进
                                </h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>RSI数据缓存：</strong>解决5分钟采集周期导致的"--"显示问题</li>
                                    <li><strong>时间对齐：</strong>RSI数据(5分钟)与涨跌幅数据(1分钟)智能映射</li>
                                    <li><strong>connectNulls：</strong>RSI曲线使用null填充+连线，保证视觉连续性</li>
                                    <li><strong>双文件存储：</strong>主数据包含RSI，RSI专用文件便于单独分析</li>
                                    <li><strong>采集容错：</strong>≥20币种成功才保存，确保数据完整性</li>
                                    <li><strong>RSI极值标记：</strong>自动标记RSI最高点(紫色)和最低点(浅绿色)，黑色字体清晰易读</li>
                                    <li><strong>鼠标悬停高亮：</strong>悬停RSI曲线时自动高亮(紫色实线+阴影)，解决与涨跌幅重叠问题</li>
                                </ul>
                                <div class="mt-3 p-3 bg-blue-50 rounded">
                                    <p class="font-semibold text-blue-800">✨ RSI交互优化：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-2 mt-2 text-xs">
                                        <li><strong>悬停效果：</strong>鼠标移到RSI虚线上 → 整条曲线变为紫色实线(4px) + 10px阴影</li>
                                        <li><strong>自动淡化：</strong>悬停时涨跌幅曲线自动淡化，RSI曲线突出显示在最上层</li>
                                        <li><strong>极值标记：</strong>紫色Pin标记最高点，浅绿色Pin标记最低点，黑色字体高对比度</li>
                                        <li><strong>数据点增强：</strong>悬停时数据点变为紫色圆点并加白色边框，更加醒目</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 新增功能4: RSI可视化增强 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-indigo-500">
                                <h4 class="font-bold text-indigo-800 mb-2">
                                    <i class="fas fa-eye mr-2"></i>
                                    4️⃣ RSI可视化增强
                                </h4>
                                <p class="mb-2 font-semibold">RSI曲线交互体验全面升级，解决重叠不清晰问题：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>最高点标记：</strong>紫色Pin标记 + 黑色字体，显示RSI最高值和时间</li>
                                    <li><strong>最低点标记：</strong>浅绿色Pin标记 + 黑色字体，显示RSI最低值和时间</li>
                                    <li><strong>悬停高亮：</strong>鼠标移到RSI虚线上，整条曲线自动高亮显示</li>
                                    <li><strong>视觉增强：</strong>悬停时线条从2px加粗到4px，颜色从灰色变为紫色</li>
                                    <li><strong>阴影效果：</strong>悬停时添加10px紫色阴影，增加立体感和层次感</li>
                                    <li><strong>智能淡化：</strong>悬停时其他曲线自动淡化，避免视觉干扰</li>
                                </ul>
                                <div class="mt-3 p-3 bg-indigo-50 rounded">
                                    <p class="font-semibold text-indigo-800">💡 使用技巧：</p>
                                    <table class="w-full text-xs mt-2 border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-2 py-1">场景</th>
                                                <th class="border border-gray-400 px-2 py-1">操作</th>
                                                <th class="border border-gray-400 px-2 py-1">效果</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">RSI与涨跌幅重叠</td>
                                                <td class="border border-gray-400 px-2 py-1">悬停RSI虚线</td>
                                                <td class="border border-gray-400 px-2 py-1">RSI紫色高亮，涨跌幅淡化</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">查看RSI极值</td>
                                                <td class="border border-gray-400 px-2 py-1">观察Pin标记</td>
                                                <td class="border border-gray-400 px-2 py-1">紫色最高点，绿色最低点</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">对比两条曲线</td>
                                                <td class="border border-gray-400 px-2 py-1">鼠标来回移动</td>
                                                <td class="border border-gray-400 px-2 py-1">交替高亮，快速对比</td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-2 py-1">查看精确数值</td>
                                                <td class="border border-gray-400 px-2 py-1">悬停数据点</td>
                                                <td class="border border-gray-400 px-2 py-1">Tooltip显示详细信息</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 改进效果 -->
                            <div class="bg-gradient-to-r from-emerald-100 to-cyan-100 p-4 rounded-lg">
                                <h4 class="font-bold text-emerald-800 mb-2">🎯 V2.2 改进效果</h4>
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="bg-gray-200">
                                            <th class="border border-gray-400 px-3 py-2 text-left">指标</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">V2.1</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">V2.2</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">RSI指标</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 27币RSI之和 + 单币RSI</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">BTC状态</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 六级状态框 + 颜色标识</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">超买超卖判断</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ RSI阈值 + 参考线</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">图表维度</td>
                                            <td class="border border-gray-400 px-3 py-2 text-yellow-600">单一涨跌幅</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 涨跌幅 + RSI双轴</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">市场状态判断</td>
                                            <td class="border border-gray-400 px-3 py-2 text-yellow-600">仅涨跌幅</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ BTC状态 + RSI + 涨跌幅</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">RSI极值标记</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 最高点(紫色) + 最低点(绿色)</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">RSI交互体验</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 悬停高亮 + 阴影效果</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">重叠可读性</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 虚线难以识别</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 悬停自动突出显示</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 数据文件 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-teal-500">
                                <h4 class="font-bold text-teal-800 mb-2">
                                    <i class="fas fa-database mr-2"></i>
                                    5️⃣ 数据文件结构
                                </h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>主数据文件：</strong><code>coin_change_YYYYMMDD.jsonl</code> (涨跌幅 + RSI)</li>
                                    <li><strong>RSI专用文件：</strong><code>rsi_YYYYMMDD.jsonl</code> (仅RSI数据)</li>
                                    <li><strong>采集周期：</strong>涨跌幅1分钟，RSI 5分钟</li>
                                    <li><strong>RSI计算：</strong>14周期，5分钟K线</li>
                                    <li><strong>数据保留：</strong>按日期存储，便于历史回溯</li>
                                </ul>
                            </div>

                        </div>
                    </div>

                    <!-- V2.1 更新说明 (2026-02-16) -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 shadow-md border-2 border-purple-300">
                        <h3 class="text-lg font-bold text-purple-800 mb-4 border-b-2 border-purple-500 pb-2">
                            <i class="fas fa-rocket text-purple-600 mr-2"></i>
                            🎉 V2.1 更新说明 - 浏览器缓存问题完全修复 (2026-02-16)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">❌ 问题根源</h4>
                                <p class="mb-2">用户反馈：关闭浏览器2小时后重新打开，页面显示的数据还是2小时前的旧数据。</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>表象：</strong>浏览器缓存了旧的API响应，未请求最新数据</li>
                                    <li><strong>误解：</strong>用户以为后端采集器停止运行，实际采集器正常工作</li>
                                    <li><strong>影响：</strong>关闭浏览器期间采集的新数据无法显示</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-800 mb-2">🔍 诊断结果</h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>后端采集器：</strong>✅ 正常运行 (PID 207461)</li>
                                    <li><strong>数据文件：</strong>✅ 持续写入 (1062条记录，2.4 MB)</li>
                                    <li><strong>时间范围：</strong>✅ 00:00:07 - 21:29:43 完整覆盖</li>
                                    <li><strong>根本原因：</strong>❌ 浏览器缓存了旧的API响应</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">✅ 解决方案</h4>
                                <p class="mb-2"><strong>1. 前端改进：</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>所有API请求添加时间戳参数 <code>?_t=Date.now()</code></li>
                                    <li>fetch选项设置 <code>cache: 'no-store'</code></li>
                                    <li>新增绿色"刷新数据"按钮，可手动强制刷新</li>
                                    <li>刷新成功后显示动画和成功提示</li>
                                </ul>
                                <p class="mt-3 mb-2"><strong>2. 后端改进：</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>响应头添加 <code>Cache-Control: no-store, no-cache, must-revalidate</code></li>
                                    <li>响应头添加 <code>Pragma: no-cache</code></li>
                                    <li>响应头添加 <code>Expires: 0</code></li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">📊 架构保证</h4>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>后端独立运行：</strong>采集器与浏览器无关，持续写入数据</li>
                                    <li><strong>JSONL文件存储：</strong>数据持久化在服务器磁盘，不依赖前端</li>
                                    <li><strong>Flask API服务：</strong>始终返回最新文件数据</li>
                                    <li><strong>前端只是展示层：</strong>关闭浏览器不影响数据采集</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2">🎯 改进效果</h4>
                                <table class="w-full text-sm border-collapse">
                                    <thead>
                                        <tr class="bg-gray-200">
                                            <th class="border border-gray-400 px-3 py-2 text-left">指标</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">V2.0</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">V2.1</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">浏览器缓存</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 启用</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 完全禁用</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-400 px-3 py-2">数据实时性</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 可能过时</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 始终最新</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2">手动刷新</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 无</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 绿色按钮</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-400 px-3 py-2">自动更新</td>
                                            <td class="border border-gray-400 px-3 py-2 text-yellow-600">~ 每60秒</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 每60秒+防缓存</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="font-bold text-blue-800 mb-2">💡 使用建议：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>系统会每60秒自动刷新，无需手动操作</li>
                                    <li>如需立即查看最新数据，点击右上角绿色"刷新数据"按钮</li>
                                    <li>后端采集器持续运行，即使关闭浏览器数据也会持续采集</li>
                                    <li>Git提交记录：<code>70240f9</code>, <code>6eb5e0c</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 🚨 部署后首次运行注意事项 (2026-02-17) -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-6 shadow-md border-2 border-red-300">
                        <h3 class="text-lg font-bold text-red-800 mb-4 border-b-2 border-red-500 pb-2">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                            🚨 重要：部署后首次运行必读 (2026-02-17)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">❌ 为什么其他系统正常，唯独这个系统需要特殊处理？</h4>
                                <p class="mb-3"><strong>核心原因：</strong>Coin Change Tracker 系统依赖<strong>当日的数据文件</strong>，而不是固定的历史数据。</p>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">🔍 其他系统 vs Coin Change Tracker：</p>
                                    <table class="w-full text-sm border-collapse mb-3">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-3 py-2 text-left">系统</th>
                                                <th class="border border-gray-400 px-3 py-2 text-left">数据特征</th>
                                                <th class="border border-gray-400 px-3 py-2 text-left">部署后状态</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-3 py-2 font-bold">其他系统 ✅</td>
                                                <td class="border border-gray-400 px-3 py-2">使用历史数据文件<br>(20260217, 20260216...)</td>
                                                <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 立即正常<br>历史数据已备份</td>
                                            </tr>
                                            <tr class="bg-gray-50">
                                                <td class="border border-gray-400 px-3 py-2 font-bold">Coin Tracker ⚠️</td>
                                                <td class="border border-gray-400 px-3 py-2">必须使用<strong>今天</strong>的文件<br>(北京时间 20260218)</td>
                                                <td class="border border-gray-400 px-3 py-2 text-red-600">✗ 数据文件不存在<br>需要手动创建</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="bg-yellow-50 p-3 rounded border border-yellow-300">
                                    <p class="font-bold text-yellow-800 mb-2">⚙️ 技术原因：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-4">
                                        <li><strong>API逻辑：</strong>系统获取北京时间日期（如 2026-02-18），然后查找 <code>coin_change_20260218.jsonl</code></li>
                                        <li><strong>每日重置：</strong>Coin Tracker 每天0点重置基准价，开始新的一天</li>
                                        <li><strong>文件命名：</strong>数据文件名包含日期，如 <code>coin_change_YYYYMMDD.jsonl</code></li>
                                        <li><strong>备份限制：</strong>备份时只包含<strong>历史数据</strong>（20260217及之前），不包含<strong>未来日期</strong>（20260218）</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500">
                                <h4 class="font-bold text-orange-800 mb-2">🔧 部署后的"今天数据文件不存在"错误</h4>
                                <p class="mb-3">部署到新环境后，系统会提示：<code class="bg-red-100 px-2 py-1 rounded text-red-700">今天的数据文件不存在: 20260218</code></p>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">📋 需要的两个文件：</p>
                                    <ol class="list-decimal list-inside space-y-2 ml-4">
                                        <li><code>coin_change_20260218.jsonl</code> - 今天的数据记录文件 (~2.6MB)</li>
                                        <li><code>baseline_20260218.json</code> - 今天的基准价格文件 (~462 bytes)</li>
                                    </ol>
                                </div>

                                <div class="bg-blue-50 p-3 rounded border border-blue-300">
                                    <p class="font-bold text-blue-800 mb-2">✅ 快速修复步骤（30秒内完成）：</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code># 1. 进入数据目录
cd /home/user/webapp/data/coin_change_tracker/

# 2. 复制昨天的数据文件作为今天的（临时使用）
cp coin_change_20260217.jsonl coin_change_20260218.jsonl

# 3. 复制昨天的基准价格作为今天的
cp baseline_20260217.json baseline_20260218.json

# 4. 验证文件已创建
ls -lh coin_change_20260218.jsonl baseline_20260218.json</code></pre>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">✅ 为什么这是合理的临时解决方案？</h4>
                                <ul class="list-disc list-inside space-y-2 ml-4">
                                    <li><strong>快速恢复：</strong>30秒内让系统可用，无需等待采集器运行5分钟</li>
                                    <li><strong>数据一致：</strong>使用昨天的数据作为今天的起点是合理的（价格连续性）</li>
                                    <li><strong>自动更新：</strong>coin-change-tracker 采集器会在接下来的5分钟内开始追加新数据</li>
                                    <li><strong>页面可用：</strong>用户可以立即看到历史趋势图和实时数据</li>
                                    <li><strong>不影响功能：</strong>所有核心功能（实时追踪、预警、图表）正常工作</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">🔄 后续自动化改进建议</h4>
                                <p class="mb-2">为避免以后每次部署都需要手动创建文件，可以添加自动化脚本：</p>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-1">方案1：启动时自动检查</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto mb-2"><code># 在 coin_change_tracker.py 开头添加
def ensure_today_files():
    beijing_time = datetime.now(timezone(timedelta(hours=8)))
    date_str = beijing_time.strftime('%Y%m%d')
    
    data_file = f'coin_change_{date_str}.jsonl'
    baseline_file = f'baseline_{date_str}.json'
    
    if not os.path.exists(data_file):
        # 复制昨天的文件
        yesterday = (beijing_time - timedelta(days=1)).strftime('%Y%m%d')
        shutil.copy(f'coin_change_{yesterday}.jsonl', data_file)
        shutil.copy(f'baseline_{yesterday}.json', baseline_file)</code></pre>
                                </div>

                                <div>
                                    <p class="font-bold text-gray-800 mb-1">方案2：定时任务（每天0点）</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code># Cron 任务
0 0 * * * cd /home/user/webapp/data/coin_change_tracker && \
  cp coin_change_$(date -d yesterday +\%Y\%m\%d).jsonl \
     coin_change_$(date +\%Y\%m\%d).jsonl && \
  cp baseline_$(date -d yesterday +\%Y\%m\%d).json \
     baseline_$(date +\%Y\%m\%d).json</code></pre>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2">📊 系统状态验证</h4>
                                <p class="mb-2">完成上述步骤后，验证系统是否正常：</p>
                                <ol class="list-decimal list-inside space-y-1 ml-4">
                                    <li>刷新浏览器页面（F5 或 Ctrl+R）</li>
                                    <li>应该看到趋势图正常显示（1000+ 数据点）</li>
                                    <li>27个币种的排行榜正常渲染</li>
                                    <li>右上角显示最新更新时间</li>
                                    <li>每10秒自动刷新数据</li>
                                </ol>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="font-bold text-blue-800 mb-2">💡 总结：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                                    <li><strong>为什么需要：</strong>Coin Tracker 依赖<strong>当日文件</strong>，备份只包含历史数据</li>
                                    <li><strong>如何修复：</strong>复制昨天的文件作为今天的（30秒完成）</li>
                                    <li><strong>是否安全：</strong>完全安全，采集器会自动追加新数据</li>
                                    <li><strong>未来改进：</strong>在采集器中添加自动检查和创建逻辑</li>
                                    <li><strong>其他系统：</strong>不需要此步骤，因为它们使用固定的历史数据</li>
                                </ul>
                            </div>
                        </div>
                    </div>


                    <!-- 📊 图表渲染问题修复记录 (2026-02-18) -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 shadow-md border-2 border-indigo-300 mt-6">
                        <h3 class="text-lg font-bold text-indigo-800 mb-4 border-b-2 border-indigo-500 pb-2">
                            <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                            📊 图表渲染问题修复 (2026-02-18)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">❌ 问题描述</h4>
                                <p class="mb-2">用户报告：<strong>图表区域完全空白</strong>，只显示图例（+180%、+90%、-90%、-180%），但没有任何线条或数据点。</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>趋势图：</strong>空白，无数据线</li>
                                    <li><strong>排行榜图：</strong>空白，无条形图</li>
                                    <li><strong>控制台错误：</strong><code class="bg-red-100 px-2 py-1 rounded text-red-700">ReferenceError: Cannot access 'maxChange' before initialization</code></li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-800 mb-2">🔍 根本原因</h4>
                                <p class="mb-2"><strong>JavaScript 变量引用顺序错误</strong> - 违反了TDZ（暂时性死区）规则</p>
                                <div class="bg-gray-50 p-3 rounded mb-3">
                                    <p class="font-bold text-gray-800 mb-2">❌ 错误代码：</p>
                                    <pre class="bg-gray-800 text-red-400 p-2 rounded text-xs overflow-x-auto"><code>console.log('数据:', {times, changes, maxChange, minChange});  // ❌ 在声明前引用

// 变量在这里才定义
const maxChange = Math.max(...changes);
const minChange = Math.min(...changes);</code></pre>
                                </div>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li><strong>JavaScript TDZ：</strong>在 <code>const</code> 声明之前访问变量会抛出 <code>ReferenceError</code></li>
                                    <li><strong>异常传播：</strong><code>updateHistoryData</code> 函数抛出异常 → <code>trendChart.setOption()</code> 未执行</li>
                                    <li><strong>结果：</strong>图表没有接收到任何数据 → 完全空白</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">✅ 修复方案</h4>
                                <p class="mb-2"><strong>调整变量引用顺序：先声明，后使用</strong></p>
                                <div class="bg-gray-50 p-3 rounded mb-3">
                                    <p class="font-bold text-gray-800 mb-2">✅ 正确代码：</p>
                                    <pre class="bg-gray-800 text-green-400 p-2 rounded text-xs overflow-x-auto"><code>// 先声明变量
const maxChange = Math.max(...changes);
const minChange = Math.min(...changes);

// 后使用变量
console.log('数据:', {times, changes, maxChange, minChange});  // ✅ 正常工作</code></pre>
                                </div>
                                <p class="mb-2"><strong>增强调试信息：</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>图表初始化时输出容器尺寸信息</li>
                                    <li>数据更新时输出详细的数据统计</li>
                                    <li>setOption 调用前验证 ECharts 实例存在</li>
                                </ul>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">✅ 修复验证</h4>
                                <table class="w-full text-sm border-collapse mb-3">
                                    <thead>
                                        <tr class="bg-gray-200">
                                            <th class="border border-gray-400 px-3 py-2 text-left">指标</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">修复前</th>
                                            <th class="border border-gray-400 px-3 py-2 text-left">修复后</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2 font-bold">JavaScript错误</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">2个错误</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 0个错误</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-400 px-3 py-2 font-bold">图表渲染</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">❌ 完全空白</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 正常显示</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-400 px-3 py-2 font-bold">用户体验</td>
                                            <td class="border border-gray-400 px-3 py-2 text-red-600">不可用</td>
                                            <td class="border border-gray-400 px-3 py-2 text-green-600">✓ 完美</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p class="mb-2"><strong>当前状态：</strong></p>
                                <ul class="list-disc list-inside space-y-1 ml-4 text-green-700">
                                    <li>✅ 趋势图正常渲染（X轴时间、Y轴涨跌幅、数据线、面积填充）</li>
                                    <li>✅ 排行榜图正常渲染（27个币种、颜色区分、数值标签）</li>
                                    <li>✅ 最高点和最低点标记正常显示</li>
                                    <li>✅ Tooltip 交互正常工作</li>
                                    <li>✅ 图表自动刷新正常（每10秒）</li>
                                </ul>
                            </div>

                            <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-lg">
                                <h4 class="font-bold text-purple-800 mb-2">💡 经验教训</h4>
                                <ol class="list-decimal list-inside space-y-2 ml-4">
                                    <li><strong>变量声明顺序：</strong>JavaScript的TDZ机制严格检查，调试代码也要遵守规则</li>
                                    <li><strong>日志可能误导：</strong>"✅ 渲染成功"可能在异常后仍打印，要在关键操作前后都添加日志</li>
                                    <li><strong>逐步调试：</strong>添加详细的阶段性日志，验证每个步骤的执行状态</li>
                                    <li><strong>异常处理：</strong>try-catch 要正确处理，显示用户友好的错误信息</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <!-- 🚨 基线价格（开盘价）问题 (2026-02-18) -->
                    <div class="bg-gradient-to-r from-amber-50 to-red-50 rounded-lg p-6 shadow-md border-2 border-amber-400">
                        <h3 class="text-lg font-bold text-amber-900 mb-4 border-b-2 border-amber-500 pb-2">
                            <i class="fas fa-exclamation-circle text-amber-600 mr-2"></i>
                            🚨 关键问题：基线价格（开盘价）的正确性 (2026-02-18)
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            <div class="bg-white p-4 rounded-lg border-l-4 border-red-500">
                                <h4 class="font-bold text-red-800 mb-2">❌ 问题描述：使用了错误的日线开盘价</h4>
                                <p class="mb-3"><strong>核心问题：</strong>系统计算涨跌幅时，使用的基线价格（baseline_price）必须是<strong>当日的真实开盘价</strong>。</p>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">🔍 错误示例（2026-02-18）：</p>
                                    <table class="w-full text-sm border-collapse mb-3">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-3 py-2 text-left">币种</th>
                                                <th class="border border-gray-400 px-3 py-2 text-left">错误的基线价格</th>
                                                <th class="border border-gray-400 px-3 py-2 text-left">正确的开盘价</th>
                                                <th class="border border-gray-400 px-3 py-2 text-left">差值</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-3 py-2 font-bold">BTC</td>
                                                <td class="border border-gray-400 px-3 py-2 text-red-600">67493.1 USDT<br><small>(昨天的)</small></td>
                                                <td class="border border-gray-400 px-3 py-2 text-green-600">67349.9 USDT<br><small>(今天的)</small></td>
                                                <td class="border border-gray-400 px-3 py-2">-143.2 USDT<br><small>(-0.21%)</small></td>
                                            </tr>
                                            <tr class="bg-gray-50">
                                                <td class="border border-gray-400 px-3 py-2 font-bold">ETH</td>
                                                <td class="border border-gray-400 px-3 py-2 text-red-600">1955.8 USDT</td>
                                                <td class="border border-gray-400 px-3 py-2 text-green-600">1967.53 USDT</td>
                                                <td class="border border-gray-400 px-3 py-2">+11.73 USDT<br><small>(+0.60%)</small></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="bg-yellow-50 p-3 rounded border border-yellow-300">
                                    <p class="font-bold text-yellow-800 mb-2">⚠️ 影响：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-4">
                                        <li><strong>计算错误：</strong>涨跌幅百分比计算不准确</li>
                                        <li><strong>数据误导：</strong>用户看到的不是真实的今日涨跌幅</li>
                                        <li><strong>预警失效：</strong>基于百分比的预警阈值可能误触发或不触发</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500">
                                <h4 class="font-bold text-orange-800 mb-2">🔍 根本原因：两个问题</h4>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">1️⃣ 数据采集器错误：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-4">
                                        <li><strong>错误脚本：</strong><code>coin_change_tracker.py</code>（空循环，不采集数据）</li>
                                        <li><strong>正确脚本：</strong><code>coin_change_tracker_collector.py</code>（真正的采集器）</li>
                                        <li><strong>表现：</strong>系统运行但不写入新数据</li>
                                    </ul>
                                </div>

                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">2️⃣ 基线价格文件过期：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-4">
                                        <li><strong>简单复制：</strong>直接复制昨天的 <code>baseline_20260217.json</code> 为今天的文件</li>
                                        <li><strong>问题：</strong>昨天的开盘价 ≠ 今天的开盘价</li>
                                        <li><strong>正确做法：</strong>从 OKX API 获取今天的真实开盘价</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-2">✅ 正确的修复步骤</h4>
                                
                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">步骤1：获取今天的真实开盘价</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code># Python 脚本：从 OKX API 获取今天的开盘价
python3 << 'PYTHON'
import requests, json
from datetime import datetime, timezone, timedelta

symbols = ["BTC", "ETH", "BNB", "XRP", "DOGE", "SOL", "DOT", "LTC", "LINK", 
           "HBAR", "TAO", "CFX", "TRX", "TON", "NEAR", "LDO", "CRO", "ETC", 
           "XLM", "BCH", "UNI", "SUI", "FIL", "STX", "CRV", "AAVE", "APT"]

baseline = {}
for symbol in symbols:
    try:
        url = f"https://www.okx.com/api/v5/market/candles?instId={symbol}-USDT-SWAP&bar=1D&limit=2"
        resp = requests.get(url, timeout=5)
        data = resp.json()
        if data['code'] == '0' and len(data['data']) > 0:
            # data[0][1] 是今天的开盘价
            open_price = float(data['data'][0][1])
            baseline[symbol] = open_price
            print(f"{symbol}: {open_price}")
    except:
        pass

# 保存到正确的日期文件
beijing_time = datetime.now(timezone(timedelta(hours=8)))
date_str = beijing_time.strftime('%Y%m%d')
filename = f'/home/user/webapp/data/coin_change_tracker/baseline_{date_str}.json'

with open(filename, 'w') as f:
    json.dump(baseline, f, indent=2)

print(f"✅ {filename} 已更新")
PYTHON</code></pre>
                                </div>

                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">步骤2：修复数据采集器</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code># 删除错误的 collector
pm2 delete coin-change-tracker

# 启动正确的 collector
pm2 start source_code/coin_change_tracker_collector.py \
  --name coin-change-tracker \
  --interpreter python3

# 保存 PM2 配置
pm2 save</code></pre>
                                </div>

                                <div class="mb-3">
                                    <p class="font-bold text-gray-800 mb-2">步骤3：重启 Flask 应用</p>
                                    <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto"><code>pm2 restart flask-app</code></pre>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-2">🔬 技术细节：OKX K线数据格式</h4>
                                <p class="mb-2">OKX API 返回的 K 线数据格式：</p>
                                <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto mb-3"><code>{
  "code": "0",
  "data": [
    [
      "1771344000000",  // 时间戳（UTC毫秒）
      "67349.9",        // 开盘价 ⭐️ (这是我们需要的)
      "67944.7",        // 最高价
      "67280.0",        // 最低价
      "67738.1",        // 收盘价
      "123456789",      // 成交量
      "..."             // 其他数据
    ],
    [...],  // 前一天的数据
    [...]   // 更早的数据
  ]
}</code></pre>
                                
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-300">
                                    <p class="font-bold text-yellow-800 mb-2">⚠️ 重要提示：</p>
                                    <ul class="list-disc list-inside space-y-1 ml-4">
                                        <li><strong>数据顺序：</strong>OKX 返回的 K 线数据按时间<strong>倒序</strong>排列</li>
                                        <li><strong>data[0]：</strong>最新（今天的）K 线（当前未完成）</li>
                                        <li><strong>data[1]：</strong>昨天的完整 K 线</li>
                                        <li><strong>北京时间：</strong>系统使用北京时间（UTC+8），不是 UTC 时间</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-2">📊 验证修复结果</h4>
                                <p class="mb-2">通过以下命令验证基线价格是否正确：</p>
                                <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto mb-3"><code># 1. 检查 baseline API
curl "http://localhost:9002/api/coin-change-tracker/baseline" | jq .

# 2. 检查 latest API
curl "http://localhost:9002/api/coin-change-tracker/latest" | jq .

# 3. 查看采集器日志
pm2 logs coin-change-tracker --lines 20</code></pre>
                                
                                <div class="bg-green-50 p-3 rounded border border-green-300">
                                    <p class="font-bold text-green-800 mb-2">✅ 正确的响应示例：</p>
                                    <pre class="bg-gray-800 text-green-400 p-2 rounded text-xs overflow-x-auto"><code>{
  "data": {
    "BTC": 67349.9,  ✅ 今天的开盘价
    "ETH": 1967.53,  ✅ 今天的开盘价
    ...
  }
}</code></pre>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2">💡 总结：为什么这个问题重要？</h4>
                                <ul class="list-disc list-inside space-y-2 ml-4 text-sm">
                                    <li><strong>数据准确性：</strong>使用错误的开盘价会导致涨跌幅计算完全错误</li>
                                    <li><strong>用户体验：</strong>用户期望看到的是<strong>今日</strong>相对于<strong>今日开盘</strong>的变化</li>
                                    <li><strong>交易决策：</strong>错误的数据可能导致错误的交易决策</li>
                                    <li><strong>预警系统：</strong>基于错误数据的预警是无意义的</li>
                                    <li><strong>简单修复：</strong>虽然问题严重，但修复很简单（运行上面的 Python 脚本）</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 运行逻辑与流程 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-green-500 pb-2">
                            <i class="fas fa-cogs text-green-600 mr-2"></i>
                            运行逻辑与流程
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-blue-800 mb-2">🔄 数据采集流程 (每5分钟)</h4>
                                <ol class="list-decimal list-inside space-y-2 ml-4">
                                    <li><strong>获取基准价格：</strong>从 <code>baseline_YYYYMMDD.json</code> 加载当日基准价 (每天0点的开盘价)</li>
                                    <li><strong>获取当前价格：</strong>遍历27个币种，从OKX API获取实时价格</li>
                                    <li><strong>计算涨跌幅：</strong>对比当前价格与基准价，计算各币种涨跌百分比</li>
                                    <li><strong>累计总涨跌：</strong>将所有币种的涨跌幅相加得到 <code>total_change</code></li>
                                    <li><strong>写入JSONL：</strong>追加一行JSON到 <code>coin_change_YYYYMMDD.jsonl</code></li>
                                    <li><strong>等待下一轮：</strong>休眠5分钟后重复上述流程</li>
                                </ol>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2">📊 前端显示流程</h4>
                                <ol class="list-decimal list-inside space-y-2 ml-4">
                                    <li><strong>页面加载：</strong>调用 <code>/api/coin-change-tracker/history</code> 获取历史数据</li>
                                    <li><strong>数据解析：</strong>提取时间轴和累计涨跌幅序列</li>
                                    <li><strong>图表渲染：</strong>使用ECharts 5.4.3绘制实时曲线</li>
                                    <li><strong>自动刷新：</strong>每60秒调用一次API更新数据</li>
                                    <li><strong>预警检测：</strong>实时监测涨跌幅是否触发用户设置的阈值</li>
                                </ol>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-bold text-purple-800 mb-2">🕛 每日重置流程 (0点)</h4>
                                <ol class="list-decimal list-inside space-y-2 ml-4">
                                    <li>检测到日期变更 (从前一天 → 今天)</li>
                                    <li>从OKX API获取所有币种的今日开盘价 (日线开盘价)</li>
                                    <li>保存为新的基准文件 <code>baseline_YYYYMMDD.json</code></li>
                                    <li>创建新的数据文件 <code>coin_change_YYYYMMDD.jsonl</code></li>
                                    <li>累计涨跌幅从0开始重新计算</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- JSONL数据格式 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2">
                            <i class="fas fa-database text-indigo-600 mr-2"></i>
                            JSONL 数据存储格式
                        </h3>
                        
                        <div class="space-y-4 text-sm">
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">📂 存储路径</h4>
                                <div class="bg-white p-3 rounded border border-gray-300 font-mono text-xs">
                                    <p><strong>数据目录：</strong>/home/user/webapp/data/coin_change_tracker/</p>
                                    <p><strong>主数据文件：</strong>coin_change_YYYYMMDD.jsonl (每天一个文件，包含涨跌幅+RSI)</p>
                                    <p><strong>RSI专用文件：</strong>rsi_YYYYMMDD.jsonl (每天一个文件，仅RSI数据)</p>
                                    <p><strong>基准文件：</strong>baseline_YYYYMMDD.json (每天一个文件，开盘价)</p>
                                    <p><strong>示例：</strong>coin_change_20260218.jsonl, rsi_20260218.jsonl, baseline_20260218.json</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">📋 数据文件格式 (coin_change_YYYYMMDD.jsonl)</h4>
                                <div class="space-y-2">
                                    <p class="text-gray-700"><strong>格式：</strong>JSONL (每行一个完整的JSON对象)</p>
                                    <p class="text-gray-700"><strong>更新频率：</strong>每1分钟一条记录</p>
                                    <p class="text-gray-700"><strong>字段说明：</strong></p>
                                    <div class="bg-white p-3 rounded border border-gray-300 font-mono text-xs overflow-x-auto">
                                        <pre>{
  "timestamp": 1771402915151,              // Unix时间戳 (毫秒)
  "beijing_time": "2026-02-18 16:21:45",  // 北京时间字符串
  "total_change": 31.3,                    // 27币累计涨跌幅 (百分比之和)
  "cumulative_pct": 31.3,                  // 累计涨跌幅 (与total_change相同)
  "count": 27,                             // 实际采集到的币种数量
  "up_ratio": 92.6,                        // 上涨占比 (%)
  "up_coins": 25,                          // 上涨币种数
  "down_coins": 2,                         // 下跌币种数
  "total_rsi": 1820.72,                    // RSI之和 (0-2700，每5分钟更新)
  "rsi_values": {                          // 各币种RSI值 (每5分钟更新)
    "BTC": 80.58,                          // BTC的RSI值 (0-100)
    "ETH": 78.79,                          // ETH的RSI值
    "BNB": 74.79,
    ... // 其余24个币种的RSI
  },
  "changes": {                             // 各币种详细数据
    "BTC": {
      "current_price": 68294.3,            // 当前价格 (USDT)
      "baseline_price": 67349.9,           // 基准价格 (今日开盘价)
      "change_pct": 1.4                    // 涨跌幅 (%)
    },
    "ETH": {
      "current_price": 2024.94,
      "baseline_price": 1967.53,
      "change_pct": 2.92
    },
    ... // 其余25个币种
  }
}</pre>
                                    </div>
                                    <div class="mt-2 p-2 bg-yellow-50 rounded border border-yellow-200">
                                        <p class="text-xs text-yellow-800"><strong>⚠️ 注意：</strong>RSI字段(total_rsi、rsi_values)仅在每5分钟采集周期时存在，其他时间点的记录中这些字段可能为空或不存在。</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">📋 RSI专用文件格式 (rsi_YYYYMMDD.jsonl)</h4>
                                <div class="space-y-2">
                                    <p class="text-gray-700"><strong>格式：</strong>JSONL (每行一个完整的JSON对象)</p>
                                    <p class="text-gray-700"><strong>更新频率：</strong>每5分钟一条记录</p>
                                    <p class="text-gray-700"><strong>RSI计算：</strong>14周期，基于5分钟K线</p>
                                    <p class="text-gray-700"><strong>字段说明：</strong></p>
                                    <div class="bg-white p-3 rounded border border-gray-300 font-mono text-xs overflow-x-auto">
                                        <pre>{
  "timestamp": 1771402705553,              // Unix时间戳 (毫秒)
  "beijing_time": "2026-02-18 16:18:06",  // 北京时间字符串
  "total_rsi": 1865.23,                    // RSI之和 (0-2700)
  "count": 27,                             // 采集到的币种数量
  "rsi_values": {                          // 各币种RSI值
    "BTC": 80.58,                          // BTC的14周期RSI (0-100)
    "ETH": 78.79,                          // ETH的14周期RSI
    "BNB": 74.79,
    "XRP": 74.52,
    "DOGE": 66.67,
    "SOL": 76.57,
    "DOT": 76.19,
    "LTC": 68.09,
    "LINK": 78.24,
    "HBAR": 67.69,
    "TAO": 57.47,
    "CFX": 68.83,
    "TRX": 39.64,
    "TON": 61.9,
    "NEAR": 70.68,
    "LDO": 72.22,
    "CRO": 59.5,
    "ETC": 71.14,
    "XLM": 86.11,
    "BCH": 67.61,
    "UNI": 68.83,
    "SUI": 82.91,
    "FIL": 66.3,
    "STX": 63.64,
    "CRV": 70.18,
    "AAVE": 50.92,
    "APT": 65.22
  }
}</pre>
                                    </div>
                                    <div class="mt-2 p-2 bg-blue-50 rounded border border-blue-200">
                                        <p class="text-xs text-blue-800"><strong>💡 RSI判断标准：</strong></p>
                                        <ul class="list-disc list-inside text-xs text-blue-700 mt-1 ml-2">
                                            <li><strong>单币RSI：</strong>70以上超买，30以下超卖，30-70中性</li>
                                            <li><strong>27币RSI之和：</strong>1890以上超买(平均70)，810以下超卖(平均30)，810-1890中性</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">📋 基准文件格式 (baseline_YYYYMMDD.json)</h4>
                                <div class="bg-white p-3 rounded border border-gray-300 font-mono text-xs overflow-x-auto">
                                    <pre>{
  "BTC": 69288.2,
  "ETH": 2022.8,
  "BNB": 619.4,
  ... // 其余24个币种的今日开盘价
}</pre>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                                <h4 class="font-bold text-yellow-800 mb-2">⚠️ 数据备份与清理</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li><strong>自动清理：</strong>不自动清理，所有历史数据永久保留</li>
                                    <li><strong>备份建议：</strong>定期备份 <code>data/coin_change_tracker/</code> 目录到 <code>/mnt/aidrive/</code></li>
                                    <li><strong>文件大小：</strong>每天约生成 3-5MB 数据 (288条记录 × 5分钟/条)</li>
                                    <li><strong>历史查询：</strong>前端可通过日期选择器查看任意历史日期的数据</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 系统功能详解 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-yellow-500 pb-2">
                            <i class="fas fa-star text-yellow-600 mr-2"></i>
                            系统功能详解
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-blue-800 mb-2">📊 实时图表可视化</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>ECharts 5.4.3 专业图表库</li>
                                    <li>平滑曲线显示累计涨跌趋势</li>
                                    <li>鼠标悬停显示详细数据</li>
                                    <li>时间轴自动适配 (5分钟间隔)</li>
                                    <li>动态颜色 (上涨绿色/下跌红色)</li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-bold text-green-800 mb-2">🔔 智能预警系统</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>自定义上涨/下跌预警阈值</li>
                                    <li>独立开关控制 (总开关 + 分类开关)</li>
                                    <li>触发时浏览器通知弹窗</li>
                                    <li>音效提示 (可配置)</li>
                                    <li>LocalStorage 持久化配置</li>
                                </ul>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-bold text-purple-800 mb-2">📈 币种详情展示</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>27币种分类卡片展示</li>
                                    <li>实时价格 + 涨跌幅</li>
                                    <li>涨跌颜色标识 (绿/红)</li>
                                    <li>基准价格对比</li>
                                    <li>自动排序 (涨幅榜/跌幅榜)</li>
                                </ul>
                            </div>
                            
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <h4 class="font-bold text-orange-800 mb-2">🕒 历史数据查询</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>日期选择器 (可选任意历史日期)</li>
                                    <li>前后日期快速切换</li>
                                    <li>API支持日期范围查询</li>
                                    <li>数据永久保存不丢失</li>
                                    <li>加载状态友好提示</li>
                                </ul>
                            </div>
                            
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-bold text-red-800 mb-2">⚡ 性能优化</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>JSONL 追加写入 (不重写整个文件)</li>
                                    <li>API响应缓存 (1分钟)</li>
                                    <li>前端数据分页加载</li>
                                    <li>图表懒加载渲染</li>
                                    <li>PM2 自动重启保活</li>
                                </ul>
                            </div>
                            
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <h4 class="font-bold text-indigo-800 mb-2">🔧 容错机制</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    <li>API请求失败自动重试</li>
                                    <li>永续合约失败 → 现货切换</li>
                                    <li>部分币种失败不影响整体</li>
                                    <li>详细错误日志记录</li>
                                    <li>基准价格缺失自动补全</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- PM2 进程与路由 API -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-red-500 pb-2">
                            <i class="fas fa-server text-red-600 mr-2"></i>
                            PM2 进程与路由 API
                        </h3>
                        
                        <div class="space-y-4 text-sm">
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">🔧 PM2 进程配置</h4>
                                <div class="bg-white p-3 rounded border border-gray-300 font-mono text-xs overflow-x-auto">
                                    <pre><strong>进程名称：</strong>coin-change-tracker
<strong>脚本路径：</strong>/home/user/webapp/source_code/coin_change_tracker_collector.py
<strong>解释器：</strong>python3
<strong>工作目录：</strong>/home/user/webapp
<strong>自动重启：</strong>是
<strong>内存限制：</strong>200MB
<strong>日志路径：</strong>
  - 标准输出: /home/user/webapp/logs/coin-change-tracker-out.log
  - 错误日志: /home/user/webapp/logs/coin-change-tracker-error.log

<strong>PM2 管理命令：</strong>
pm2 start ecosystem.config.js --only coin-change-tracker  # 启动
pm2 stop coin-change-tracker                              # 停止
pm2 restart coin-change-tracker                           # 重启
pm2 logs coin-change-tracker                              # 查看日志
pm2 status                                                # 查看所有进程状态</pre>
                                </div>
                            </div>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">🌐 API 路由清单</h4>
                                <table class="w-full text-xs bg-white rounded border border-gray-300">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="border border-gray-300 px-3 py-2 text-left">路由</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left">方法</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left">说明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 font-mono">/coin-change-tracker</td>
                                            <td class="border border-gray-300 px-3 py-2">GET</td>
                                            <td class="border border-gray-300 px-3 py-2">主页面 (返回HTML模板)</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-300 px-3 py-2 font-mono">/api/coin-change-tracker/latest</td>
                                            <td class="border border-gray-300 px-3 py-2">GET</td>
                                            <td class="border border-gray-300 px-3 py-2">获取最新一条数据 (实时数据)</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 font-mono">/api/coin-change-tracker/history</td>
                                            <td class="border border-gray-300 px-3 py-2">GET</td>
                                            <td class="border border-gray-300 px-3 py-2">获取历史数据
                                                <br><strong>参数：</strong>
                                                <br>- date: YYYYMMDD (默认今天)
                                                <br>- limit: 数量限制 (默认1440)
                                            </td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-300 px-3 py-2 font-mono">/api/coin-change-tracker/baseline</td>
                                            <td class="border border-gray-300 px-3 py-2">GET</td>
                                            <td class="border border-gray-300 px-3 py-2">获取基准价格
                                                <br><strong>参数：</strong>date: YYYYMMDD
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 font-mono">/api/coin-change-tracker/reset-baseline</td>
                                            <td class="border border-gray-300 px-3 py-2">POST</td>
                                            <td class="border border-gray-300 px-3 py-2">手动重置基准价格 (管理员功能)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">🔗 外部依赖 API</h4>
                                <table class="w-full text-xs bg-white rounded border border-gray-300">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="border border-gray-300 px-3 py-2 text-left">API</th>
                                            <th class="border border-gray-300 px-3 py-2 text-left">用途</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-3 py-2 font-mono text-xs">https://www.okx.com/api/v5/market/ticker</td>
                                            <td class="border border-gray-300 px-3 py-2">获取实时价格 (永续合约/现货)</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-300 px-3 py-2 font-mono text-xs">https://www.okx.com/api/v5/market/candles</td>
                                            <td class="border border-gray-300 px-3 py-2">获取日线开盘价 (基准价格)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 技术架构 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-teal-500 pb-2">
                            <i class="fas fa-layer-group text-teal-600 mr-2"></i>
                            技术架构
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>后端：</strong>Flask (Python 3.10+)
                            </div>
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>前端：</strong>Tailwind CSS + ECharts 5.4.3 + Font Awesome 6.4.0
                            </div>
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>数据采集：</strong>Python 定时脚本 (PM2 守护)
                            </div>
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>数据存储：</strong>JSONL 文件 (按日期分文件)
                            </div>
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>进程管理：</strong>PM2 (自动重启、日志管理、资源限制)
                            </div>
                            <div class="bg-gray-100 p-3 rounded">
                                <strong>Python依赖：</strong>Flask 3.1.2, requests 2.32.4, pytz, pathlib
                            </div>
                        </div>
                    </div>

                    <!-- 故障排查 -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-orange-500 pb-2">
                            <i class="fas fa-tools text-orange-600 mr-2"></i>
                            常见问题与故障排查
                        </h3>
                        <div class="space-y-3 text-sm text-gray-700">
                            <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500">
                                <strong>问题：图表不显示数据</strong>
                                <ul class="list-disc list-inside ml-4 mt-2">
                                    <li>检查 PM2 进程状态: <code>pm2 status</code></li>
                                    <li>检查数据文件是否存在: <code>ls data/coin_change_tracker/</code></li>
                                    <li>检查API是否响应: <code>curl http://localhost:5000/api/coin-change-tracker/latest</code></li>
                                    <li>查看后端日志: <code>pm2 logs coin-change-tracker</code></li>
                                </ul>
                            </div>
                            
                            <div class="bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-500">
                                <strong>问题：数据采集中断</strong>
                                <ul class="list-disc list-inside ml-4 mt-2">
                                    <li>重启采集进程: <code>pm2 restart coin-change-tracker</code></li>
                                    <li>检查网络连接 (能否访问 okx.com)</li>
                                    <li>检查磁盘空间: <code>df -h</code></li>
                                    <li>检查错误日志: <code>tail -f logs/coin-change-tracker-error.log</code></li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                <strong>问题：基准价格错误</strong>
                                <ul class="list-disc list-inside ml-4 mt-2">
                                    <li>手动重置基准: <code>POST /api/coin-change-tracker/reset-baseline</code></li>
                                    <li>删除错误基准文件后重启进程</li>
                                    <li>等待0点自动重置</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- RSI + 涨跌幅组合分析说明 -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 shadow-md border-2 border-purple-300">
                        <h3 class="text-lg font-bold text-purple-800 mb-4 border-b-2 border-purple-500 pb-2">
                            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                            📊 RSI + 涨跌幅组合分析指南
                        </h3>
                        <div class="space-y-4 text-sm text-gray-700">
                            
                            <!-- 核心价值 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-purple-500">
                                <h4 class="font-bold text-purple-800 mb-3">✨ 为什么RSI与涨跌幅配合使用？</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div class="bg-blue-50 p-3 rounded">
                                        <p class="font-bold text-blue-800 mb-2">📈 27币涨跌幅之和</p>
                                        <ul class="list-disc list-inside space-y-1 text-xs ml-2">
                                            <li><strong>时间维度：</strong>当日累计变化</li>
                                            <li><strong>含义：</strong>今天涨了多少</li>
                                            <li><strong>特点：</strong>绝对变化量</li>
                                            <li><strong>更新：</strong>每分钟</li>
                                        </ul>
                                    </div>
                                    <div class="bg-purple-50 p-3 rounded">
                                        <p class="font-bold text-purple-800 mb-2">📊 RSI之和</p>
                                        <ul class="list-disc list-inside space-y-1 text-xs ml-2">
                                            <li><strong>时间维度：</strong>最近14个周期</li>
                                            <li><strong>含义：</strong>市场强弱程度</li>
                                            <li><strong>特点：</strong>相对强弱度</li>
                                            <li><strong>更新：</strong>每5分钟</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3 bg-gradient-to-r from-green-50 to-blue-50 p-3 rounded border border-green-300">
                                    <p class="font-bold text-green-800 mb-1">🎯 组合优势：</p>
                                    <ul class="list-disc list-inside space-y-1 text-xs ml-2">
                                        <li><strong>互补性强：</strong>涨跌幅看绝对值，RSI看相对强度</li>
                                        <li><strong>相互验证：</strong>两个指标一致时信号更可靠</li>
                                        <li><strong>发现背离：</strong>价格与RSI不一致时往往是转折点</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 四象限分析法 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-bold text-green-800 mb-3">🎯 四象限分析法</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs border-collapse">
                                        <thead>
                                            <tr class="bg-gray-200">
                                                <th class="border border-gray-400 px-3 py-2 text-left">涨跌幅 ↓ / RSI →</th>
                                                <th class="border border-gray-400 px-3 py-2 text-center">RSI低(&lt;810)<br>超卖</th>
                                                <th class="border border-gray-400 px-3 py-2 text-center">RSI中(810-1890)<br>中性</th>
                                                <th class="border border-gray-400 px-3 py-2 text-center">RSI高(&gt;1890)<br>超买</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="border border-gray-400 px-3 py-2 font-bold">涨幅大 (&gt;+15%)</td>
                                                <td class="border border-gray-400 px-3 py-2 bg-green-50">
                                                    <div class="font-bold text-green-700 mb-1">🟢 强势反弹</div>
                                                    <div class="text-xs">超卖后大涨</div>
                                                    <div class="text-xs text-blue-600">✓ 关注持续性</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-blue-50">
                                                    <div class="font-bold text-blue-700 mb-1">✅ 健康上涨</div>
                                                    <div class="text-xs">RSI未超买</div>
                                                    <div class="text-xs text-green-600">✓ 可以持有</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-red-50">
                                                    <div class="font-bold text-red-700 mb-1">🔴 风险区域</div>
                                                    <div class="text-xs">涨幅大+超买</div>
                                                    <div class="text-xs text-red-600">⚠️ 考虑止盈</div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-3 py-2 font-bold">涨幅小 (-5%~+5%)</td>
                                                <td class="border border-gray-400 px-3 py-2 bg-gray-50">
                                                    <div class="font-bold text-gray-700 mb-1">⚪ 底部震荡</div>
                                                    <div class="text-xs">横盘整理</div>
                                                    <div class="text-xs text-gray-600">➡️ 等待机会</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-gray-50">
                                                    <div class="font-bold text-gray-700 mb-1">➡️ 盘整状态</div>
                                                    <div class="text-xs">市场平稳</div>
                                                    <div class="text-xs text-gray-600">➡️ 观察为主</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-yellow-50">
                                                    <div class="font-bold text-yellow-700 mb-1">⚠️ 滞涨风险</div>
                                                    <div class="text-xs">RSI高但不涨</div>
                                                    <div class="text-xs text-orange-600">⚠️ 警惕回调</div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="border border-gray-400 px-3 py-2 font-bold">跌幅大 (&lt;-15%)</td>
                                                <td class="border border-gray-400 px-3 py-2 bg-green-50">
                                                    <div class="font-bold text-green-700 mb-1">🟢 超跌反弹</div>
                                                    <div class="text-xs">极度超卖</div>
                                                    <div class="text-xs text-green-600">✓ 分批建仓</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-gray-50">
                                                    <div class="font-bold text-gray-700 mb-1">⚪ 调整到位</div>
                                                    <div class="text-xs">回调健康</div>
                                                    <div class="text-xs text-blue-600">➡️ 等待企稳</div>
                                                </td>
                                                <td class="border border-gray-400 px-3 py-2 bg-red-50">
                                                    <div class="font-bold text-red-700 mb-1">🔴 下跌中继</div>
                                                    <div class="text-xs">RSI仍高+大跌</div>
                                                    <div class="text-xs text-red-600">⚠️ 继续观望</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 实战场景 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-bold text-blue-800 mb-3">💼 实战场景分析</h4>
                                <div class="space-y-3">
                                    
                                    <!-- 场景1 -->
                                    <div class="bg-red-50 p-3 rounded border border-red-200">
                                        <p class="font-bold text-red-800 mb-2">场景1: 暴涨后的判断 🚀</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                                            <div><strong>涨跌幅:</strong> +30% ⬆️</div>
                                            <div><strong>RSI:</strong> 1950 (超买) 🔴</div>
                                            <div><strong>上涨占比:</strong> 85% ↑</div>
                                            <div><strong>市场状态:</strong> 过热</div>
                                        </div>
                                        <div class="bg-white p-2 rounded">
                                            <p class="font-bold text-gray-800 mb-1">📊 分析:</p>
                                            <ul class="list-disc list-inside text-xs space-y-1 ml-2">
                                                <li>✅ 市场短期大涨</li>
                                                <li>⚠️ RSI严重超买</li>
                                                <li>⚠️ 多数币种已跟涨</li>
                                            </ul>
                                            <p class="font-bold text-red-700 mt-2 text-xs">💡 建议: 短线可能见顶，考虑止盈或减仓</p>
                                        </div>
                                    </div>

                                    <!-- 场景2 -->
                                    <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                        <p class="font-bold text-blue-800 mb-2">场景2: 震荡中的机会 📊</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                                            <div><strong>涨跌幅:</strong> +5% ➡️</div>
                                            <div><strong>RSI:</strong> 1350 (中性) ⚪</div>
                                            <div><strong>上涨占比:</strong> 55% →</div>
                                            <div><strong>市场状态:</strong> 健康</div>
                                        </div>
                                        <div class="bg-white p-2 rounded">
                                            <p class="font-bold text-gray-800 mb-1">📊 分析:</p>
                                            <ul class="list-disc list-inside text-xs space-y-1 ml-2">
                                                <li>✅ 市场温和上涨</li>
                                                <li>✅ RSI健康，无过热</li>
                                                <li>✅ 多空相对平衡</li>
                                            </ul>
                                            <p class="font-bold text-blue-700 mt-2 text-xs">💡 建议: 市场状态健康，可以正常持仓</p>
                                        </div>
                                    </div>

                                    <!-- 场景3 -->
                                    <div class="bg-green-50 p-3 rounded border border-green-200">
                                        <p class="font-bold text-green-800 mb-2">场景3: 超卖后的反弹 📉→📈</p>
                                        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                                            <div><strong>涨跌幅:</strong> -20% ⬇️</div>
                                            <div><strong>RSI:</strong> 700 (超卖) 🟢</div>
                                            <div><strong>上涨占比:</strong> 15% ↓</div>
                                            <div><strong>市场状态:</strong> 恐慌</div>
                                        </div>
                                        <div class="bg-white p-2 rounded">
                                            <p class="font-bold text-gray-800 mb-1">📊 分析:</p>
                                            <ul class="list-disc list-inside text-xs space-y-1 ml-2">
                                                <li>⚠️ 市场恐慌性下跌</li>
                                                <li>✅ RSI严重超卖</li>
                                                <li>⚠️ 绝大多数币种下跌</li>
                                            </ul>
                                            <p class="font-bold text-green-700 mt-2 text-xs">💡 建议: 可能接近底部，分批建仓机会</p>
                                        </div>
                                    </div>

                                    <!-- 场景4 -->
                                    <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                        <p class="font-bold text-yellow-800 mb-2">场景4: 背离预警 ⚠️</p>
                                        <div class="grid grid-cols-1 gap-2 text-xs mb-2">
                                            <div class="bg-white p-2 rounded">
                                                <p class="font-bold text-orange-700 mb-1">顶背离 (Bearish Divergence):</p>
                                                <div class="ml-2">
                                                    <div>涨跌幅: +15% → +20% → +25% (价格新高)</div>
                                                    <div>RSI: 1850 → 1820 → 1780 (RSI下降)</div>
                                                    <div class="text-red-600 font-bold mt-1">⚠️ 信号: 上涨动力衰竭，可能反转</div>
                                                </div>
                                            </div>
                                            <div class="bg-white p-2 rounded">
                                                <p class="font-bold text-green-700 mb-1">底背离 (Bullish Divergence):</p>
                                                <div class="ml-2">
                                                    <div>涨跌幅: -15% → -18% → -20% (价格新低)</div>
                                                    <div>RSI: 850 → 900 → 950 (RSI上升)</div>
                                                    <div class="text-green-600 font-bold mt-1">✓ 信号: 下跌动力衰竭，可能反弹</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 配合上涨占比 -->
                            <div class="bg-white p-4 rounded-lg border-l-4 border-indigo-500">
                                <h4 class="font-bold text-indigo-800 mb-3">🎯 三指标综合评估</h4>
                                <div class="bg-gray-50 p-3 rounded border border-gray-300">
                                    <p class="font-bold text-gray-800 mb-2">完整的市场状态评估：</p>
                                    <div class="space-y-2 text-xs">
                                        <div class="bg-red-50 p-2 rounded border border-red-200">
                                            <p class="font-bold text-red-700 mb-1">🔴 极度超买 (高风险):</p>
                                            <div class="ml-2">涨跌幅 &gt; +20% <strong>且</strong> RSI &gt; 1890 <strong>且</strong> 上涨占比 &gt; 75%</div>
                                        </div>
                                        <div class="bg-green-50 p-2 rounded border border-green-200">
                                            <p class="font-bold text-green-700 mb-1">🟢 极度超卖 (机会区域):</p>
                                            <div class="ml-2">涨跌幅 &lt; -15% <strong>且</strong> RSI &lt; 810 <strong>且</strong> 上涨占比 &lt; 25%</div>
                                        </div>
                                        <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                            <p class="font-bold text-blue-700 mb-1">⚪ 正常波动 (继续观察):</p>
                                            <div class="ml-2">其他情况</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 使用建议 -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-300">
                                <h4 class="font-bold text-blue-800 mb-3">💡 实用建议</h4>
                                <div class="space-y-2 text-xs">
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">1.</span>
                                        <p><strong>单一指标容易误判，</strong>建议涨跌幅、RSI、上涨占比三者结合判断</p>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">2.</span>
                                        <p><strong>重点关注一致性，</strong>三个指标同时超买/超卖时信号最可靠</p>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">3.</span>
                                        <p><strong>警惕背离现象，</strong>价格创新高但RSI不创新高往往是顶部信号</p>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">4.</span>
                                        <p><strong>观察图表趋势，</strong>RSI曲线的走势可以提前预判市场转向</p>
                                    </div>
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">5.</span>
                                        <p><strong>分批操作，</strong>即使信号明确也建议分批建仓/止盈，降低风险</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 预警设置面板 -->
        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-orange-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-bell text-orange-600 mr-2"></i>
                    涨跌预警设置
                </h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">预警状态:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="alertEnabled" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                    </label>
                    <span id="alertStatus" class="text-sm font-medium text-orange-600">已开启</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 上涨预警 -->
                <div class="bg-white rounded-lg p-4 border-2 border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-green-600 flex items-center">
                            <i class="fas fa-arrow-up mr-2"></i>
                            上涨预警
                        </h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="upAlertEnabled" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                触发阈值 (%)
                            </label>
                            <input type="number" id="upThreshold" step="0.1" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="加载中...">
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            当任意币种涨幅大于此值时触发预警
                        </div>
                    </div>
                </div>
                
                <!-- 下跌预警 -->
                <div class="bg-white rounded-lg p-4 border-2 border-red-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-red-600 flex items-center">
                            <i class="fas fa-arrow-down mr-2"></i>
                            下跌预警
                        </h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="downAlertEnabled" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                触发阈值 (%)
                            </label>
                            <input type="number" id="downThreshold" step="0.1" max="0" min="-100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="加载中...">
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            当任意币种跌幅小于此值时触发预警
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Telegram设置 -->
            <div class="mt-4 bg-white rounded-lg p-4 border-2 border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-blue-600 flex items-center">
                        <i class="fab fa-telegram text-blue-500 mr-2"></i>
                        Telegram通知
                    </h3>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="tgEnabled" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    开启后将通过Telegram发送预警通知（需要后端配置）
                </div>
            </div>
            
            <!-- 保存按钮 -->
            <div class="mt-4 flex justify-end space-x-3">
                <button id="testSound" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-lg shadow-lg hover:from-blue-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-volume-up mr-2"></i>
                    测试声音
                </button>
                <button id="testAlert" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold rounded-lg shadow-lg hover:from-purple-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-vial mr-2"></i>
                    测试预警
                </button>
                <button id="saveAlertSettings" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg shadow-lg hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    保存预警设置
                </button>
                <button id="resetAlertSettings" class="px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white font-bold rounded-lg shadow-lg hover:from-gray-500 hover:to-gray-600 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <i class="fas fa-undo mr-2"></i>
                    恢复默认
                </button>
            </div>
            
            <!-- 保存成功提示 -->
            <div id="saveSuccess" class="mt-4 hidden">
                <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="font-medium text-green-800">预警设置已保存！</span>
                    </div>
                </div>
            </div>
            
            <!-- 预警日志 -->
            <div id="alertLog" class="mt-4 hidden">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                        <span class="font-medium text-yellow-800" id="alertMessage"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 实时数据卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
            <!-- 总涨跌幅 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">27币涨跌幅之和</span>
                    <i class="fas fa-percentage text-blue-600"></i>
                </div>
                <div id="totalChange" class="text-3xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    <i class="far fa-clock mr-1"></i>
                    <span id="updateTime">--</span>
                </div>
            </div>

            <!-- RSI之和 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">RSI之和</span>
                    <i class="fas fa-chart-line text-purple-600"></i>
                </div>
                <div id="totalRSI" class="text-3xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    <span id="rsiStatus" class="font-medium">--</span>
                </div>
                <!-- 当日最高/最低点 -->
                <div class="text-xs text-gray-400 mt-3 flex justify-between">
                    <div>
                        <span class="text-red-500">↑</span> 
                        <span id="rsiMax">--</span>
                    </div>
                    <div>
                        <span class="text-green-500">↓</span> 
                        <span id="rsiMin">--</span>
                    </div>
                </div>
            </div>

            <!-- 有效币种数 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">有效币种数</span>
                    <i class="fas fa-coins text-green-600"></i>
                </div>
                <div id="validCount" class="text-3xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    共 27 个币种
                </div>
            </div>

            <!-- 上涨占比 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">上涨占比</span>
                    <i class="fas fa-arrow-up text-emerald-600"></i>
                </div>
                <div id="upRatio" class="text-3xl font-bold text-gray-800">--</div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>平均: <span id="upRatioAvg" class="font-semibold">--</span></span>
                    <span>最小: <span id="upRatioMin" class="font-semibold">--</span></span>
                    <span>最大: <span id="upRatioMax" class="font-semibold">--</span></span>
                </div>
                <div class="text-sm text-gray-500 mt-2">
                    <i class="far fa-clock mr-1"></i>
                    <span id="upRatioUpdateTime">--</span>
                </div>
            </div>

            <!-- 基准价时间 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">基准价时间</span>
                    <i class="fas fa-calendar-alt text-orange-600"></i>
                </div>
                <div id="baselineDate" class="text-2xl font-bold text-gray-800">--</div>
                <div class="text-sm text-gray-500 mt-2">
                    每天0点重置
                </div>
            </div>
        </div>
        
        <!-- 市场情绪分析卡片 -->
        <div class="mb-6">
            <div class="bg-gradient-to-r from-purple-50 via-pink-50 to-blue-50 rounded-lg shadow-lg p-6 border-2 border-purple-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center text-purple-800">
                        <i class="fas fa-brain text-purple-600 mr-2"></i>
                        市场情绪偏向分析 (15分钟更新)
                    </h2>
                    <button onclick="refreshMarketSentiment()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>刷新
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <!-- 当前情绪 -->
                    <div class="bg-white rounded-lg p-4 shadow-md border-l-4" id="sentimentCard">
                        <div class="text-sm text-gray-600 mb-2">当前情绪</div>
                        <div id="currentSentiment" class="text-3xl font-bold mb-2">--</div>
                        <div id="sentimentReason" class="text-xs text-gray-500">--</div>
                        <div class="text-xs text-gray-400 mt-2">
                            <i class="far fa-clock mr-1"></i>
                            <span id="sentimentTime">--</span>
                        </div>
                    </div>
                    
                    <!-- 币价变化 -->
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="text-sm text-gray-600 mb-2">27币价格变化</div>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span id="coinChangeFrom" class="text-lg text-gray-500">--</span>
                            <i class="fas fa-arrow-right text-gray-400"></i>
                            <span id="coinChangeTo" class="text-2xl font-bold">--</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">变化:</span>
                            <span id="coinChangeDelta" class="text-lg font-semibold">--</span>
                            <span id="coinChangePercent" class="text-sm">--</span>
                        </div>
                    </div>
                    
                    <!-- RSI变化 -->
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="text-sm text-gray-600 mb-2">RSI总和变化</div>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span id="rsiChangeFrom" class="text-lg text-gray-500">--</span>
                            <i class="fas fa-arrow-right text-gray-400"></i>
                            <span id="rsiChangeTo" class="text-2xl font-bold">--</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">变化:</span>
                            <span id="rsiChangeDelta" class="text-lg font-semibold">--</span>
                            <span id="rsiChangePercent" class="text-sm">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- 情绪判断说明 -->
                <div class="bg-white rounded-lg p-4 shadow-md">
                    <div class="text-sm font-semibold text-gray-700 mb-2">判断逻辑说明：</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-600">
                        <div class="bg-green-50 p-2 rounded border-l-2 border-green-500">
                            <strong class="text-green-700">🐂 偏多信号：</strong>
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-0.5">
                                <li>价格下跌时，RSI下降幅度 <strong>&gt;</strong> 价格下降幅度（恐慌过度，可能反弹）</li>
                                <li>价格上涨时，RSI上涨幅度 <strong>&lt;</strong> 价格上涨幅度（理性上涨，可持续）</li>
                            </ul>
                        </div>
                        <div class="bg-red-50 p-2 rounded border-l-2 border-red-500">
                            <strong class="text-red-700">🐻 偏空信号：</strong>
                            <ul class="list-disc list-inside ml-2 mt-1 space-y-0.5">
                                <li>价格下跌时，RSI下降幅度 <strong>&lt;</strong> 价格下降幅度（下跌未充分反映，可能继续）</li>
                                <li>价格上涨时，RSI上涨幅度 <strong>&gt;</strong> 价格上涨幅度（贪婪过度，可能回调）</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 详细数据表格（可折叠） -->
                <div class="mt-4">
                    <button onclick="toggleDetailedData()" class="w-full px-4 py-2 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow border-2 border-purple-200 flex items-center justify-between">
                        <span class="text-sm font-semibold text-purple-800">
                            <i class="fas fa-table mr-2"></i>查看详细数据（27币价格 vs RSI 比值分析）
                        </span>
                        <i id="detailedDataIcon" class="fas fa-chevron-down text-purple-600"></i>
                    </button>
                    
                    <div id="detailedDataPanel" class="mt-3 bg-white rounded-lg shadow-md p-4 border-2 border-purple-100" style="display: none;">
                        <div class="mb-4 text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>说明：</strong>通过对比27个币种的总价格变化与RSI总和变化的比值关系，判断市场整体的理性程度。
                        </div>
                        
                        <!-- 当前数据概览 -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">27币价格变化总和</div>
                                <div id="detailCoinChange" class="text-2xl font-bold text-blue-700">--</div>
                                <div id="detailCoinChangePercent" class="text-xs text-gray-500">--</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">RSI总和</div>
                                <div id="detailRSI" class="text-2xl font-bold text-purple-700">--</div>
                                <div id="detailRSIPercent" class="text-xs text-gray-500">--</div>
                            </div>
                            <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">价格/RSI 比值</div>
                                <div id="detailRatio" class="text-2xl font-bold text-amber-700">--</div>
                                <div class="text-xs text-gray-500">比值越高，价格影响越大</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">市场状态</div>
                                <div id="detailMarketState" class="text-xl font-bold text-green-700">--</div>
                                <div class="text-xs text-gray-500">基于比值判断</div>
                            </div>
                        </div>
                        
                        <!-- 历史数据表格 -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-purple-100 border-b-2 border-purple-300">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">时间</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700">27币价格变化</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700">变化幅度</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700">RSI总和</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700">RSI变化</th>
                                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700">价格/RSI比值</th>
                                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-700">情绪</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">原因</th>
                                    </tr>
                                </thead>
                                <tbody id="detailedDataTable" class="divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="8" class="px-3 py-8 text-center text-gray-400">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控制 -->
                        <div class="mt-4 flex items-center justify-between text-sm">
                            <div class="text-gray-600">
                                显示 <span id="detailPageInfo">0</span> 条记录
                            </div>
                            <div class="flex gap-2">
                                <button onclick="loadDetailedDataPage('prev')" class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left"></i> 上一页
                                </button>
                                <button onclick="loadDetailedDataPage('next')" class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    下一页 <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BTC 当日涨跌幅状态框 -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fab fa-bitcoin text-orange-500 mr-2"></i>
                        BTC 当日涨跌幅状态
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- BTC 涨跌幅 -->
                    <div id="btcChangeCard" class="p-4 rounded-lg border-2 transition-all duration-300">
                        <div class="text-sm text-gray-600 mb-1">BTC 当前涨跌幅</div>
                        <div id="btcChange" class="text-3xl font-bold mb-2">--</div>
                        <div id="btcStatus" class="text-lg font-semibold">--</div>
                    </div>
                    
                    <!-- 状态说明 -->
                    <div class="col-span-1 md:col-span-1 lg:col-span-2 bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-gray-700 mb-2">状态分类标准：</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-red-600 mr-2"></span>
                                <span><strong>主跌：</strong>跌幅 &gt; 3%</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-orange-500 mr-2"></span>
                                <span><strong>大幅下跌：</strong>-3% ~ -1.5%</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></span>
                                <span><strong>小幅震荡偏空：</strong>-1.5% ~ 0%</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-blue-400 mr-2"></span>
                                <span><strong>小幅震荡偏多：</strong>0% ~ 1.5%</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                <span><strong>大幅上涨：</strong>1.5% ~ 3%</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-emerald-600 mr-2"></span>
                                <span><strong>主升：</strong>涨幅 &gt; 3%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 - 趋势图独占一行，放大2倍 -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- 总涨跌幅趋势图 - 放大2倍 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">
                        <i class="fas fa-chart-area text-blue-600 mr-2"></i>
                        总涨跌幅趋势
                        <span class="text-sm font-normal text-gray-500 ml-2">
                            <i class="fas fa-arrow-up text-red-500"></i> 最高价
                            <i class="fas fa-arrow-down text-green-500 ml-3"></i> 最低价
                        </span>
                    </h2>
                    <!-- 日期选择器 -->
                    <div class="flex items-center space-x-3">
                        <button id="prevDay" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-chevron-left mr-1"></i> 前一天
                        </button>
                        <input type="date" id="dateSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button id="nextDay" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            后一天 <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                        <button id="todayBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-calendar-day mr-1"></i> 今天
                        </button>
                    </div>
                </div>
                <div class="mb-3 flex flex-wrap gap-3 text-sm">
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-red-600 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-red-600 font-semibold">+180%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-amber-500 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-amber-500 font-semibold">+90%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-blue-500 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-blue-500 font-semibold">-90%</span>
                    </span>
                    <span class="inline-flex items-center">
                        <span class="inline-block w-8 h-0.5 bg-purple-600 mr-1" style="border-top: 2px dashed;"></span>
                        <span class="text-purple-600 font-semibold">-180%</span>
                    </span>
                </div>
                <div id="trendChart" style="height: 800px;"></div>
            </div>
        </div>

        <!-- 波峰检测与假突破告警框 -->
        <div id="wavePeakAlertBox" class="mb-6" style="display: none;">
            <div class="bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-600 rounded-lg shadow-lg p-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 id="wavePeakAlertTitle" class="text-xl font-bold text-red-800 mb-2">
                            <i class="fas fa-chart-line mr-2"></i>市场预警信号
                        </h3>
                        <div id="wavePeakAlertContent" class="text-gray-700">
                            <!-- 动态内容将在这里填充 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B-A-C 波峰详情框 -->
        <div id="wavePeakDetailsBox" class="mb-6" style="display: none;">
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-600">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-mountain text-blue-600 mr-2"></i>B-A-C 波峰详情
                        <span class="text-sm font-normal text-gray-500 ml-2">
                            （动态确认：15分钟内保持极值才算确认）
                        </span>
                    </h3>
                    <button onclick="toggleWavePeakDetails()" class="text-blue-600 hover:text-blue-800 transition-colors">
                        <i id="wavePeakDetailsToggleIcon" class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="wavePeakDetailsContent" class="space-y-4">
                    <!-- 动态内容将在这里填充 -->
                </div>
            </div>
        </div>

        <!-- 假突破期做空策略收益分析框 -->
        <div class="mb-6">
            <div class="bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 rounded-lg shadow-2xl p-6 border-2 border-orange-400">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <div class="bg-gradient-to-br from-orange-500 to-red-600 p-3 rounded-full mr-4">
                            <i class="fas fa-fire text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-600 to-red-600">
                                🔥 假突破期做空策略收益分析
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">基于2月5-9日实际数据验证（连续5天假突破期）</p>
                        </div>
                    </div>
                    <button onclick="toggleFalseBreakoutStrategy()" class="text-orange-600 hover:text-orange-800 transition-colors">
                        <i id="falseBreakoutToggleIcon" class="fas fa-chevron-up text-xl"></i>
                    </button>
                </div>

                <div id="falseBreakoutStrategyContent">
                    <!-- 核心数据摘要 -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-red-500">
                            <div class="text-xs text-gray-500 mb-1">总交易次数</div>
                            <div class="text-2xl font-bold text-gray-800">30次</div>
                            <div class="text-xs text-gray-600 mt-1">5天 • 6次/天</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-orange-500">
                            <div class="text-xs text-gray-500 mb-1">累计总收益</div>
                            <div class="text-2xl font-bold text-orange-600">+10,160.70%</div>
                            <div class="text-xs text-gray-600 mt-1">10倍杠杆</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-amber-500">
                            <div class="text-xs text-gray-500 mb-1">日均收益</div>
                            <div class="text-2xl font-bold text-amber-600">+2,032.14%</div>
                            <div class="text-xs text-gray-600 mt-1">约本金20倍/天</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-green-500">
                            <div class="text-xs text-gray-500 mb-1">胜率</div>
                            <div class="text-2xl font-bold text-green-600">100.00%</div>
                            <div class="text-xs text-gray-600 mt-1">无一亏损 ✅</div>
                        </div>
                    </div>

                    <!-- 关键发现 -->
                    <div class="bg-white rounded-lg p-5 shadow-md mb-4">
                        <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                            关键发现
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="flex items-start">
                                <span class="text-2xl mr-2">🚀</span>
                                <div>
                                    <div class="font-semibold text-gray-800">日均收益爆炸</div>
                                    <div class="text-gray-600">假突破期日均收益是正常期的<span class="text-red-600 font-bold">2.72倍</span>（+171.9%提升）</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="text-2xl mr-2">⚡</span>
                                <div>
                                    <div class="font-semibold text-gray-800">高频交易密集</div>
                                    <div class="text-gray-600">交易频率是正常期的<span class="text-orange-600 font-bold">2.5倍</span>（6次 vs 2.4次/天）</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="text-2xl mr-2">💰</span>
                                <div>
                                    <div class="font-semibold text-gray-800">黄金时期</div>
                                    <div class="text-gray-600">虽只占28%时间，却贡献<span class="text-green-600 font-bold">51%总收益</span>和49%交易机会</div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="text-2xl mr-2">✅</span>
                                <div>
                                    <div class="font-semibold text-gray-800">系统验证</div>
                                    <div class="text-gray-600">所有30次A点→C点交易<span class="text-blue-600 font-bold">100%盈利</span>，验证算法准确性</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 实战案例 -->
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-5 shadow-md mb-4 border-2 border-purple-300">
                        <h4 class="font-bold text-lg text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-trophy text-purple-600 mr-2"></i>
                            实战案例：最大收益（2月9日 Peak 2）
                        </h4>
                        <div class="grid grid-cols-5 gap-3 text-sm">
                            <div class="bg-white rounded-lg p-3 shadow">
                                <div class="text-xs text-gray-500 mb-1">A点时间</div>
                                <div class="font-bold text-purple-700">07:08:00</div>
                                <div class="text-xs text-purple-600 mt-1">+24.57%</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow">
                                <div class="text-xs text-gray-500 mb-1">C点时间</div>
                                <div class="font-bold text-purple-700">07:25:00</div>
                                <div class="text-xs text-purple-600 mt-1">-38.77%</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow">
                                <div class="text-xs text-gray-500 mb-1">用时</div>
                                <div class="font-bold text-orange-600">17分钟</div>
                                <div class="text-xs text-gray-600 mt-1">极速</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow">
                                <div class="text-xs text-gray-500 mb-1">10倍收益</div>
                                <div class="font-bold text-red-600">+633.40%</div>
                                <div class="text-xs text-gray-600 mt-1">单次最高</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow">
                                <div class="text-xs text-gray-500 mb-1">1000U→</div>
                                <div class="font-bold text-green-600">7,334U</div>
                                <div class="text-xs text-gray-600 mt-1">实际收益</div>
                            </div>
                        </div>
                    </div>

                    <!-- 收益预期 -->
                    <div class="bg-white rounded-lg p-5 shadow-md mb-4">
                        <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-calculator text-blue-600 mr-2"></i>
                            收益预期示例（稳健策略 ✅ 推荐）
                        </h4>
                        <div class="grid grid-cols-4 gap-4 text-sm">
                            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-3 border border-blue-200">
                                <div class="text-xs text-gray-600 mb-1">本金</div>
                                <div class="font-bold text-xl text-blue-700">10,000 USDT</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                                <div class="text-xs text-gray-600 mb-1">单次仓位</div>
                                <div class="font-bold text-xl text-green-700">15%</div>
                                <div class="text-xs text-gray-500 mt-1">风控合理</div>
                            </div>
                            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-3 border border-amber-200">
                                <div class="text-xs text-gray-600 mb-1">日均收益</div>
                                <div class="font-bold text-xl text-amber-700">+20,321 USDT</div>
                                <div class="text-xs text-gray-500 mt-1">每天4次</div>
                            </div>
                            <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-3 border border-red-200">
                                <div class="text-xs text-gray-600 mb-1">5天累计</div>
                                <div class="font-bold text-xl text-red-700">≈201,605 USDT</div>
                                <div class="text-xs text-gray-500 mt-1">本金20倍</div>
                            </div>
                        </div>
                    </div>

                    <!-- 实战策略 -->
                    <div class="bg-white rounded-lg p-5 shadow-md">
                        <h4 class="font-bold text-lg text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-crosshairs text-red-600 mr-2"></i>
                            实战策略要点
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-semibold text-green-700 mb-2 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>核心优势
                                </div>
                                <ul class="space-y-1 text-gray-700 ml-6">
                                    <li>• 交易机会密集（6次/天）</li>
                                    <li>• 单次收益稳定（+338.69%平均）</li>
                                    <li>• 100%胜率（无一亏损）</li>
                                    <li>• 日均收益爆炸（+2,032.14%）</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-semibold text-red-700 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>风险提示
                                </div>
                                <ul class="space-y-1 text-gray-700 ml-6">
                                    <li>• 需要全天候盯盘（高频交易）</li>
                                    <li>• 震荡行情心理压力大</li>
                                    <li>• 高波动期可能有滑点</li>
                                    <li>• 10倍杠杆风险极高</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-semibold text-blue-700 mb-2 flex items-center">
                                    <i class="fas fa-sign-in-alt mr-2"></i>入场时机
                                </div>
                                <ul class="space-y-1 text-gray-700 ml-6">
                                    <li>• 等待A点确认（15分钟窗口）</li>
                                    <li>• 确认后立即做空10倍杠杆</li>
                                    <li>• 绝不在A点之前进场</li>
                                </ul>
                            </div>
                            <div>
                                <div class="font-semibold text-purple-700 mb-2 flex items-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i>出场时机
                                </div>
                                <ul class="space-y-1 text-gray-700 ml-6">
                                    <li>• C点触发立即平仓</li>
                                    <li>• 不等二次确认</li>
                                    <li>• 不贪心，及时离场</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                            <div class="font-semibold text-yellow-800 mb-1 flex items-center">
                                <i class="fas fa-shield-alt mr-2"></i>风控管理（必须严格执行）
                            </div>
                            <div class="text-xs text-yellow-700 space-y-1">
                                <div>• 止损：A点上方5%（本金损失0.5%）</div>
                                <div>• 单次仓位：10-15%（假突破期）| 20-30%（正常期）</div>
                                <div>• 日最大回撤：10%必须停止交易</div>
                                <div>• 连续3次止损：降低仓位至5%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 策略筛选器 -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- 流通盘6名策略 -->
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg shadow-lg p-6 border-2 border-indigo-200">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                    流通盘6名策略
                    <span class="ml-3 text-sm font-normal text-gray-600">点击按钮快速筛选策略</span>
                </h2>
                
                <!-- 策略按钮网格 -->
                <div class="grid grid-cols-4 gap-3 mb-4">
                    <!-- 前8 1.5% 10倍做空 -->
                    <button onclick="applyStrategy('top8', 1.5, 10, 'short')" 
                            class="strategy-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">📉 前8做空</span>
                            <i class="fas fa-arrow-down text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">涨幅后: 1.5% • 10x</div>
                        <div class="text-xs opacity-75 mt-1">涨幅前8名 开空单</div>
                    </button>

                    <!-- 前8 1.5% 10倍做多 -->
                    <button onclick="applyStrategy('top8', 1.5, 10, 'long')" 
                            class="strategy-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">📈 前8做多</span>
                            <i class="fas fa-arrow-up text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">涨幅后: 1.5% • 10x</div>
                        <div class="text-xs opacity-75 mt-1">涨幅前8名 开多单</div>
                    </button>

                    <!-- 后8 1.5% 10倍做多 -->
                    <button onclick="applyStrategy('bottom8', 1.5, 10, 'long')" 
                            class="strategy-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">📈 后8做多</span>
                            <i class="fas fa-arrow-up text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">跌幅后: 1.5% • 10x</div>
                        <div class="text-xs opacity-75 mt-1">跌幅后8名 开多单</div>
                    </button>

                    <!-- 后8 1.5% 10倍做空 -->
                    <button onclick="applyStrategy('bottom8', 1.5, 10, 'short')" 
                            class="strategy-btn bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-base">📉 后8做空</span>
                            <i class="fas fa-arrow-down text-lg"></i>
                        </div>
                        <div class="text-xs opacity-90">跌幅后: 1.5% • 10x</div>
                        <div class="text-xs opacity-75 mt-1">跌幅后8名 开空单</div>
                    </button>
                </div>

                <!-- 策略说明 -->
                <div class="bg-white rounded-lg p-4 border border-indigo-200">
                    <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-info-circle text-indigo-600 mr-2"></i>
                        策略说明:
                    </h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• <strong>前8</strong>: 在流通盘中选涨幅前8名的币种</li>
                        <li>• <strong>后8</strong>: 在流通盘中选跌幅后8名的币种（即跌幅最大的8个）</li>
                        <li>• <strong>涨幅后</strong>: 等待币种在当前价格基础上再涨1.5%后开仓</li>
                        <li>• <strong>跌幅后</strong>: 等待币种在当前价格基础上再跌1.5%后开仓</li>
                        <li>• <strong>10x</strong>: 使用10倍杠杆进行交易</li>
                        <li>• <strong>做多/做空</strong>: 选择开多单或空单的方向</li>
                    </ul>
                </div>

                <!-- 当前策略显示 -->
                <div id="currentStrategy" class="mt-4 hidden bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4 border-2 border-yellow-400">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-yellow-600 text-2xl mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 mb-2">当前选择的策略:</h4>
                            <div id="strategyDetails" class="text-sm text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 市场情绪偏向分析 (15分钟更新) -->
        <div class="mb-6">
            <div class="bg-gradient-to-r from-purple-50 via-pink-50 to-blue-50 rounded-lg shadow-lg border-2 border-purple-200">
                <!-- 标题栏 -->
                <div class="flex items-center justify-between p-4 border-b border-purple-200">
                    <h2 class="text-xl font-bold flex items-center text-purple-800">
                        <i class="fas fa-brain text-purple-600 mr-2"></i>
                        市场情绪偏向分析 (15分钟更新)
                    </h2>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleSentimentDetails()" id="sentimentToggleBtn" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                            <i class="fas fa-chevron-down mr-1"></i>展开详情
                        </button>
                        <button onclick="refreshMarketSentiment()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>刷新
                        </button>
                    </div>
                </div>
                
                <!-- 概览卡片（始终显示） -->
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- 当前情绪 -->
                        <div class="bg-white rounded-lg p-4 shadow-md border-l-4" id="sentimentCard">
                            <div class="text-sm text-gray-600 mb-2">当前情绪</div>
                            <div id="currentSentiment" class="text-2xl font-bold mb-2">--</div>
                            <div id="sentimentReason" class="text-xs text-gray-500">--</div>
                            <div class="text-xs text-gray-400 mt-2">
                                <i class="far fa-clock mr-1"></i>
                                <span id="sentimentTime">--</span>
                            </div>
                        </div>
                        
                        <!-- 币价变化 -->
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="text-sm text-gray-600 mb-2">27币价格变化</div>
                            <div class="flex items-baseline gap-2 mb-2">
                                <span id="coinChangeFrom" class="text-lg text-gray-500">--</span>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                                <span id="coinChangeTo" class="text-2xl font-bold">--</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">变化:</span>
                                <span id="coinChangeDelta" class="text-lg font-semibold">--</span>
                                <span id="coinChangePercent" class="text-sm">--</span>
                            </div>
                        </div>
                        
                        <!-- RSI变化 -->
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="text-sm text-gray-600 mb-2">RSI总和变化</div>
                            <div class="flex items-baseline gap-2 mb-2">
                                <span id="rsiChangeFrom" class="text-lg text-gray-500">--</span>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                                <span id="rsiChangeTo" class="text-2xl font-bold">--</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">变化:</span>
                                <span id="rsiChangeDelta" class="text-lg font-semibold">--</span>
                                <span id="rsiChangePercent" class="text-sm">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 详细信息（可折叠） -->
                <div id="sentimentDetailsPanel" style="display: none;">
                    <!-- 判断逻辑说明 -->
                    <div class="px-4 pb-4">
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-info-circle text-purple-600 mr-1"></i>
                                判断逻辑说明：
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-600">
                                <div class="bg-green-50 p-3 rounded border-l-2 border-green-500">
                                    <strong class="text-green-700">🐂 偏多信号：</strong>
                                    <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
                                        <li>价格下跌时，RSI下降幅度 <strong>&gt;</strong> 价格下降幅度（恐慌过度，可能反弹）</li>
                                        <li>价格上涨时，RSI上涨幅度 <strong>&lt;</strong> 价格上涨幅度（理性上涨，可持续）</li>
                                    </ul>
                                </div>
                                <div class="bg-red-50 p-3 rounded border-l-2 border-red-500">
                                    <strong class="text-red-700">🐻 偏空信号：</strong>
                                    <ul class="list-disc list-inside ml-2 mt-2 space-y-1">
                                        <li>价格下跌时，RSI下降幅度 <strong>&lt;</strong> 价格下降幅度（下跌未充分反映，可能继续）</li>
                                        <li>价格上涨时，RSI上涨幅度 <strong>&gt;</strong> 价格上涨幅度（贪婪过度，可能回调）</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 历史数据表格 -->
                    <div class="px-4 pb-4">
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="text-sm font-semibold text-gray-700 mb-3 flex items-center justify-between">
                                <span>
                                    <i class="fas fa-history text-purple-600 mr-1"></i>
                                    市场情绪历史记录
                                    <span class="text-xs text-gray-500 ml-2">(显示最近 <span id="sentimentLimit">20</span> 条)</span>
                                </span>
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center space-x-2">
                                        <label class="text-xs text-gray-600">选择日期:</label>
                                        <input type="date" 
                                               id="sentimentDatePicker" 
                                               class="text-xs border border-gray-300 rounded px-2 py-1"
                                               onchange="changeSentimentDate()">
                                        <button onclick="goToYesterday()" 
                                                class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded"
                                                title="查看昨天的数据">
                                            昨天
                                        </button>
                                        <button onclick="resetSentimentDate()" 
                                                class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded"
                                                title="返回今天">
                                            今天
                                        </button>
                                    </div>
                                    <span class="text-xs text-gray-500">
                                        🔥 见底信号 | ⚠️ 见顶信号 | 每15分钟检查
                                    </span>
                                    <select id="sentimentLimitSelect" onchange="changeSentimentLimit()" class="text-xs border border-gray-300 rounded px-2 py-1">
                                        <option value="10">10条</option>
                                        <option value="20" selected>20条</option>
                                        <option value="50">50条</option>
                                        <option value="100">100条</option>
                                    </select>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-xs">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">时间</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">情绪</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">币价变化</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">RSI变化</th>
                                            <th class="px-3 py-2 text-left font-medium text-gray-500">原因</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sentimentHistoryTable">
                                        <tr>
                                            <td colspan="5" class="px-3 py-4 text-center text-gray-500">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 排行榜 -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- 单币涨跌幅排行 -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-trophy text-yellow-600 mr-2"></i>
                    单币涨跌幅排行（实时）
                </h2>
                <div id="rankChart" style="height: 800px;"></div>
            </div>
        </div>

        <!-- 详细数据表格 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-table text-green-600 mr-2"></i>
                详细数据（27个币种）
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">币种</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基准价</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当前价</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">涨跌幅</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RSI</th>
                        </tr>
                    </thead>
                    <tbody id="detailTable" class="bg-white divide-y divide-gray-200">
                        <!-- 数据将在这里填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 音频相关变量（必须在最前面定义）
        let audioContext = null;
        let audioInitialized = false;
        let alertSoundLoop = null;  // 用于控制声音循环
        
        // 图表实例
        let trendChart = null;
        let rankChart = null;
        
        // 历史数据（用于趋势图）
        let historyData = [];
        let rsiHistoryData = [];  // RSI历史数据
        
        // 最后的RSI数据缓存
        let lastRSIData = {
            total_rsi: null,
            rsi_values: {},
            timestamp: null
        };
        
        // 格式化日期为 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 解析日期字符串，支持两种格式: YYYYMMDD 或 YYYY-MM-DD
        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            
            // 如果是 YYYYMMDD 格式（8位数字），转换为 YYYY-MM-DD
            if (/^\d{8}$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                dateStr = `${year}-${month}-${day}`;
            }
            
            return new Date(dateStr + 'T00:00:00');
        }
        
        // 当前选择的日期
        // 检查URL参数中是否有date参数
        const urlParams = new URL(window.location.href).searchParams;
        const urlDate = urlParams.get('date');
        let currentDate = urlDate ? parseDate(urlDate) : new Date();
        
        // 初始化图表
        function initCharts() {
            const trendChartDom = document.getElementById('trendChart');
            const rankChartDom = document.getElementById('rankChart');
            
            console.log('📊 初始化图表...');
            console.log('趋势图容器:', trendChartDom, '宽度:', trendChartDom.offsetWidth, '高度:', trendChartDom.offsetHeight);
            console.log('排行榜容器:', rankChartDom, '宽度:', rankChartDom.offsetWidth, '高度:', rankChartDom.offsetHeight);
            
            trendChart = echarts.init(trendChartDom);
            rankChart = echarts.init(rankChartDom);
            
            // 强制resize确保图表正确显示
            setTimeout(() => {
                trendChart.resize();
                rankChart.resize();
                console.log('📊 图表已resize');
            }, 100);
            
            console.log('📊 ECharts实例已创建:', {trendChart, rankChart});
            
            // 趋势图配置
            trendChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    },
                    formatter: function(params) {
                        const time = params[0].axisValue;
                        let html = `<div style="padding: 8px; min-width: 240px;">`;
                        html += `<div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">`;
                        html += `<i class="far fa-clock" style="margin-right: 4px;"></i>${time}`;
                        html += `</div>`;
                        
                        // 遍历所有系列
                        params.forEach(p => {
                            const dataIndex = p.dataIndex;
                            
                            if (p.seriesName === '27币涨跌幅之和') {
                                const value = p.value;
                                let upRatio = '--';
                                
                                // 获取上涨占比
                                if (historyData && historyData[dataIndex]) {
                                    if (historyData[dataIndex].up_ratio !== undefined) {
                                        upRatio = historyData[dataIndex].up_ratio.toFixed(1) + '%';
                                    } else if (historyData[dataIndex].changes) {
                                        const changes = historyData[dataIndex].changes;
                                        const changesArray = Object.values(changes);
                                        const upCoins = changesArray.filter(coin => coin.change_pct > 0).length;
                                        const totalCoins = changesArray.length;
                                        upRatio = totalCoins > 0 ? (upCoins / totalCoins * 100).toFixed(1) + '%' : '--';
                                    }
                                }
                                
                                html += `<div style="margin-bottom: 4px;">`;
                                html += `${p.marker}<span style="font-weight: 600;">${p.seriesName}</span>`;
                                html += `</div>`;
                                html += `<div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">`;
                                html += `${value > 0 ? '+' : ''}${value}%`;
                                html += `</div>`;
                                html += `<div style="margin-top: 4px; font-size: 13px; color: #6B7280;">`;
                                html += `上涨占比: <span style="font-weight: 600; color: #10B981;">${upRatio}</span>`;
                                html += `</div>`;
                            } else if (p.seriesName === 'RSI之和') {
                                const rsiValue = p.value;
                                const avgRsi = (rsiValue / 27).toFixed(1);
                                let status = '中性';
                                let statusColor = '#6B7280';
                                
                                if (rsiValue >= 1890) {
                                    status = '超买';
                                    statusColor = '#EF4444';
                                } else if (rsiValue <= 810) {
                                    status = '超卖';
                                    statusColor = '#10B981';
                                }
                                
                                html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB;">`;
                                html += `<div style="margin-bottom: 4px;">`;
                                html += `${p.marker}<span style="font-weight: 600;">${p.seriesName}</span>`;
                                html += `</div>`;
                                html += `<div style="font-size: 16px; font-weight: bold; color: #9333EA;">`;
                                html += `${rsiValue.toFixed(1)}`;
                                html += `</div>`;
                                html += `<div style="margin-top: 4px; font-size: 13px; color: #6B7280;">`;
                                html += `平均RSI: <span style="font-weight: 600;">${avgRsi}</span> | `;
                                html += `状态: <span style="font-weight: 600; color: ${statusColor};">${status}</span>`;
                                html += `</div>`;
                                html += `</div>`;
                            }
                        });
                        
                        html += `</div>`;
                        return html;
                    }
                },
                grid: {
                    left: '3%',
                    right: '10%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: []
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '涨跌幅(%)',
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}%'
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#3B82F6'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'RSI之和',
                        position: 'right',
                        min: 0,
                        max: 2700,
                        interval: 270,
                        axisLabel: {
                            formatter: '{value}'
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#9CA3AF'
                            }
                        },
                        splitLine: {
                            show: false
                        }
                    }
                ],
                series: [
                    {
                        name: '27币涨跌幅之和',
                        type: 'line',
                        yAxisIndex: 0,
                        smooth: true,
                        data: [],
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(59, 130, 246, 0.5)' },
                                    { offset: 1, color: 'rgba(59, 130, 246, 0.1)' }
                                ]
                            }
                        },
                        lineStyle: {
                            color: '#3B82F6',
                            width: 2
                        }
                    },
                    {
                        name: 'RSI之和',
                        type: 'line',
                        yAxisIndex: 1,
                        smooth: true,
                        data: [],
                        lineStyle: {
                            color: '#9CA3AF',
                            width: 2,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#9CA3AF'
                        },
                        showSymbol: true,
                        symbol: 'circle',
                        symbolSize: 5,
                        connectNulls: true
                    }
                ]
            });
        }
        
        // 加载最后一次的RSI数据（用于初始化缓存）
        async function loadLastRSIData() {
            try {
                console.log('🔄 加载最后的RSI数据...');
                const url = `/api/coin-change-tracker/rsi-history?limit=1&_t=${Date.now()}`;
                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const lastRSI = result.data[0];
                    lastRSIData.total_rsi = lastRSI.total_rsi;
                    lastRSIData.rsi_values = lastRSI.rsi_values || {};
                    lastRSIData.timestamp = lastRSI.beijing_time;
                    console.log('✅ 成功加载最后的RSI数据:', lastRSI.total_rsi);
                    
                    // 立即更新显示
                    const totalRSIEl = document.getElementById('totalRSI');
                    const rsiStatusEl = document.getElementById('rsiStatus');
                    totalRSIEl.textContent = lastRSIData.total_rsi.toFixed(2);
                    
                    let status = '';
                    let statusColor = '';
                    if (lastRSIData.total_rsi > 1890) {
                        status = '超买';
                        statusColor = 'text-red-600';
                        totalRSIEl.className = 'text-3xl font-bold text-red-600';
                    } else if (lastRSIData.total_rsi < 810) {
                        status = '超卖';
                        statusColor = 'text-green-600';
                        totalRSIEl.className = 'text-3xl font-bold text-green-600';
                    } else {
                        status = '中性';
                        statusColor = 'text-gray-600';
                        totalRSIEl.className = 'text-3xl font-bold text-gray-800';
                    }
                    rsiStatusEl.textContent = status;
                    rsiStatusEl.className = `font-medium ${statusColor}`;
                }
            } catch (error) {
                console.error('❌ 加载最后RSI数据失败:', error);
            }
        }
        
        // 更新实时数据
        async function updateLatestData() {
            console.log('🔄 开始更新最新数据...', new Date().toLocaleTimeString());
            try {
                // 添加时间戳参数防止缓存
                const url = `/api/coin-change-tracker/latest?_t=${Date.now()}`;
                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    console.log('✅ 数据更新成功，时间:', data.beijing_time);
                    
                    // 保存当前数据到全局变量（供策略使用）
                    window.currentCoinsData = data.changes;
                    
                    // 更新卡片数据
                    const totalChange = data.total_change;
                    const totalChangeEl = document.getElementById('totalChange');
                    totalChangeEl.textContent = `${totalChange > 0 ? '+' : ''}${totalChange.toFixed(2)}%`;
                    totalChangeEl.className = `text-3xl font-bold ${totalChange > 0 ? 'text-green-600' : totalChange < 0 ? 'text-red-600' : 'text-gray-800'}`;
                    
                    document.getElementById('validCount').textContent = `${data.count}/27`;
                    
                    // 计算上涨占比（data.changes 是对象，需要转换为数组）
                    const changesArray = Object.values(data.changes);
                    const upCoins = changesArray.filter(coin => coin.change_pct > 0).length;
                    const totalCoins = changesArray.length;
                    const upRatio = totalCoins > 0 ? (upCoins / totalCoins * 100) : 0;
                    
                    const upRatioEl = document.getElementById('upRatio');
                    upRatioEl.textContent = `${upRatio.toFixed(1)}%`;
                    upRatioEl.className = `text-3xl font-bold ${upRatio >= 50 ? 'text-green-600' : upRatio > 0 ? 'text-orange-500' : 'text-red-600'}`;
                    
                    // 更新上涨占比的更新时间（与总涨跌幅同步）
                    const upRatioTimeStr = data.beijing_time ? data.beijing_time.split(' ')[1] : 'N/A';
                    document.getElementById('upRatioUpdateTime').textContent = upRatioTimeStr;
                    
                    // 提取时间部分显示（HH:MM:SS）
                    const timeStr = data.beijing_time ? data.beijing_time.split(' ')[1] : 'N/A';
                    document.getElementById('updateTime').textContent = timeStr;
                    // 基准价时间显示为今天的日期（YYYY-MM-DD）
                    const dateStr = data.beijing_time ? data.beijing_time.split(' ')[0] : formatDate(new Date());
                    document.getElementById('baselineDate').textContent = dateStr;
                    
                    // 更新单币排行榜
                    updateRankChart(data.changes);
                    
                    // 更新RSI数据缓存
                    if (data.total_rsi !== undefined) {
                        lastRSIData.total_rsi = data.total_rsi;
                        lastRSIData.rsi_values = data.rsi_values || {};
                        lastRSIData.timestamp = data.beijing_time;
                    } else if (lastRSIData.total_rsi === null) {
                        // 如果是首次加载且没有RSI数据，尝试从历史数据中获取最后一次RSI
                        await loadLastRSIData();
                    }
                    
                    // 更新详细表格（使用最新的或缓存的RSI数据）
                    const rsiValuesToUse = (data.rsi_values && Object.keys(data.rsi_values).length > 0) 
                        ? data.rsi_values 
                        : lastRSIData.rsi_values;
                    updateDetailTable(data.changes, rsiValuesToUse);
                    
                    // 更新BTC当日涨跌幅状态
                    updateBTCStatus(data.changes);
                    
                    // 更新RSI之和卡片（使用最新的或缓存的RSI数据）
                    const totalRSIToUse = data.total_rsi !== undefined ? data.total_rsi : lastRSIData.total_rsi;
                    
                    if (totalRSIToUse !== null) {
                        const totalRSI = totalRSIToUse;
                        const totalRSIEl = document.getElementById('totalRSI');
                        totalRSIEl.textContent = totalRSI.toFixed(2);
                        
                        // 根据RSI值显示状态
                        const rsiStatusEl = document.getElementById('rsiStatus');
                        let status = '';
                        let statusColor = '';
                        if (totalRSI > 1890) {
                            status = '超买';
                            statusColor = 'text-red-600';
                            totalRSIEl.className = 'text-3xl font-bold text-red-600';
                        } else if (totalRSI < 810) {
                            status = '超卖';
                            statusColor = 'text-green-600';
                            totalRSIEl.className = 'text-3xl font-bold text-green-600';
                        } else {
                            status = '中性';
                            statusColor = 'text-gray-600';
                            totalRSIEl.className = 'text-3xl font-bold text-gray-800';
                        }
                        rsiStatusEl.textContent = status;
                        rsiStatusEl.className = `font-medium ${statusColor}`;
                    } else {
                        document.getElementById('totalRSI').textContent = '--';
                        document.getElementById('rsiStatus').textContent = '等待采集';
                    }
                    
                    // 检查预警（添加）- 使用延迟调用确保函数已定义
                    if (typeof checkAlerts === 'function') {
                        checkAlerts({
                            cumulative_pct: totalChange,
                            changes: data.changes
                        });
                    }
                    
                } else {
                    console.error('❌ 获取数据失败:', result.error);
                }
            } catch (error) {
                console.error('❌ 更新数据异常:', error);
            }
        }
        
        // 更新历史趋势（支持指定日期）
        async function updateHistoryData(date = null) {
            try {
                // 如果指定了日期，则查询特定日期的数据
                let url = '/api/coin-change-tracker/history?limit=1440';
                if (date) {
                    url += `&date=${formatDate(date)}`;
                }
                
                // 添加时间戳参数防止缓存
                url += `&_t=${Date.now()}`;
                
                console.log('Fetching history data from:', url);
                
                // 添加 no-cache 请求头
                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const result = await response.json();
                
                console.log('History data result:', result);
                console.log('Fetched URL:', url);
                console.log('Data count:', result.data ? result.data.length : 0);
                
                if (result.success && result.data && result.data.length > 0) {
                    historyData = result.data;
                    
                    // 计算上涨占比的统计值（平均值、最小值、最大值）
                    // 只统计00:30之后的数据
                    const filteredData = historyData.filter(d => {
                        let timeStr = '';
                        if (d.beijing_time) {
                            timeStr = d.beijing_time.split(' ')[1] || '';
                        } else if (d.time) {
                            timeStr = d.time;
                        }
                        // 比较时间字符串，只保留 >= "00:30:00" 的数据
                        return timeStr >= '00:30:00';
                    });
                    
                    const upRatios = filteredData.map(d => {
                        if (d.up_ratio !== undefined) {
                            return d.up_ratio;
                        } else if (d.changes) {
                            const changesArray = Object.values(d.changes);
                            const upCoins = changesArray.filter(coin => coin.change_pct > 0).length;
                            const totalCoins = changesArray.length;
                            return totalCoins > 0 ? (upCoins / totalCoins * 100) : 0;
                        }
                        return 0;
                    }).filter(v => v !== undefined);
                    
                    if (upRatios.length > 0) {
                        const avgUpRatio = upRatios.reduce((sum, v) => sum + v, 0) / upRatios.length;
                        const minUpRatio = Math.min(...upRatios);
                        const maxUpRatio = Math.max(...upRatios);
                        
                        // 更新显示
                        document.getElementById('upRatioAvg').textContent = avgUpRatio.toFixed(1) + '%';
                        document.getElementById('upRatioMin').textContent = minUpRatio.toFixed(1) + '%';
                        document.getElementById('upRatioMax').textContent = maxUpRatio.toFixed(1) + '%';
                        
                        console.log('📊 上涨占比统计 (从00:30开始):', {
                            平均值: avgUpRatio.toFixed(1) + '%',
                            最小值: minUpRatio.toFixed(1) + '%',
                            最大值: maxUpRatio.toFixed(1) + '%',
                            数据点: upRatios.length,
                            开始时间: filteredData.length > 0 ? (filteredData[0].beijing_time || filteredData[0].time) : 'N/A',
                            结束时间: filteredData.length > 0 ? (filteredData[filteredData.length-1].beijing_time || filteredData[filteredData.length-1].time) : 'N/A'
                        });
                    }
                    
                    // 提取时间和总涨跌幅（使用beijing_time字段，格式化为HH:MM:SS）
                    const times = historyData.map(d => {
                        // 兼容两种格式：
                        // 新格式: beijing_time: "2026-02-18 00:17:39"
                        // 旧格式: time: "00:17:39"
                        if (d.beijing_time) {
                            // 新格式：提取时间部分
                            return d.beijing_time.split(' ')[1] || 'undefined';
                        } else if (d.time) {
                            // 旧格式：直接使用time字段
                            return d.time;
                        } else {
                            return 'undefined';
                        }
                    });
                    const changes = historyData.map(d => d.total_change);
                    
                    // 加载RSI数据
                    let rsiUrl = '/api/coin-change-tracker/rsi-history?limit=1440';
                    if (date) {
                        rsiUrl += `&date=${formatDate(date)}`;
                    }
                    rsiUrl += `&_t=${Date.now()}`;
                    
                    console.log('Fetching RSI data from:', rsiUrl);
                    
                    let rsiData = [];
                    let rsiValues = [];
                    
                    try {
                        const rsiResponse = await fetch(rsiUrl, {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        const rsiResult = await rsiResponse.json();
                        
                        if (rsiResult.success && rsiResult.data && rsiResult.data.length > 0) {
                            rsiData = rsiResult.data;
                            
                            // 创建RSI时间戳映射表
                            const rsiMap = {};
                            rsiData.forEach(d => {
                                const timeStr = d.beijing_time || '';
                                const time = timeStr.split(' ')[1] || '';
                                if (time) {
                                    rsiMap[time] = d.total_rsi;
                                }
                            });
                            
                            // 将RSI值映射到涨跌幅的时间轴，如果没有对应的RSI值则使用null
                            rsiValues = times.map(time => {
                                return rsiMap[time] !== undefined ? rsiMap[time] : null;
                            });
                            
                            console.log('✅ RSI数据加载成功，原始数据点:', rsiData.length, '映射后数据点:', rsiValues.length);
                            console.log('✅ RSI非空数据点:', rsiValues.filter(v => v !== null).length);
                            
                            // 计算当日RSI最高和最低值
                            const validRsiValues = rsiValues.filter(v => v !== null && v !== undefined);
                            if (validRsiValues.length > 0) {
                                const rsiMax = Math.max(...validRsiValues);
                                const rsiMin = Math.min(...validRsiValues);
                                document.getElementById('rsiMax').textContent = rsiMax.toFixed(2);
                                document.getElementById('rsiMin').textContent = rsiMin.toFixed(2);
                            } else {
                                document.getElementById('rsiMax').textContent = '--';
                                document.getElementById('rsiMin').textContent = '--';
                            }
                        } else {
                            console.log('⚠️ RSI数据文件不存在或为空');
                            // 如果没有RSI数据，填充null数组
                            rsiValues = times.map(() => null);
                            document.getElementById('rsiMax').textContent = '--';
                            document.getElementById('rsiMin').textContent = '--';
                        }
                    } catch (e) {
                        console.warn('⚠️ RSI数据加载失败:', e);
                        // 出错时也填充null数组
                        rsiValues = times.map(() => null);
                        document.getElementById('rsiMax').textContent = '--';
                        document.getElementById('rsiMin').textContent = '--';
                    }
                    
                    console.log('Times count:', times.length, 'Changes count:', changes.length, 'RSI count:', rsiValues.length);
                    
                    // 加载波峰数据
                    let wavePeaksData = [];
                    let falseBreakout = null;
                    let crashWarning = null;  // 添加暴跌预警变量
                    let currentState = null;  // 添加当前状态变量
                    
                    try {
                        let wavePeaksUrl = '/api/coin-change-tracker/wave-peaks?';
                        if (date) {
                            wavePeaksUrl += `date=${formatDate(date)}&`;
                            console.log('🔍 查询历史波峰数据，日期:', formatDate(date));
                        } else {
                            console.log('🔍 查询今日波峰数据（无date参数）');
                        }
                        wavePeaksUrl += `_t=${Date.now()}`;
                        
                        console.log('Fetching wave peaks from:', wavePeaksUrl);
                        
                        const wavePeaksResponse = await fetch(wavePeaksUrl, {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        const wavePeaksResult = await wavePeaksResponse.json();
                        
                        if (wavePeaksResult.success && wavePeaksResult.peaks) {
                            wavePeaksData = wavePeaksResult.peaks;
                            falseBreakout = wavePeaksResult.false_breakout;
                            crashWarning = wavePeaksResult.crash_warning;  // 保存暴跌预警
                            currentState = wavePeaksResult.current_state;  // 保存当前状态
                            console.log('✅ 波峰数据加载成功，波峰数量:', wavePeaksData.length);
                            console.log('📅 波峰数据日期:', wavePeaksResult.date);
                            if (wavePeaksData.length > 0) {
                                console.log('📍 第一个波峰:', wavePeaksData[0].b_point.beijing_time);
                            }
                            if (falseBreakout) {
                                console.log('⚠️ 检测到假突破信号！', falseBreakout);
                            }
                            if (crashWarning) {
                                console.log('🚨 检测到暴跌预警！', crashWarning);
                            }
                            if (currentState && currentState.incomplete_peak) {
                                console.log('🔄 检测到进行中的波峰:', currentState.incomplete_peak);
                            }
                        } else {
                            console.log('⚠️ 波峰数据为空或检测失败');
                        }
                    } catch (e) {
                        console.warn('⚠️ 波峰数据加载失败:', e);
                    }
                    
                    // 加载市场情绪数据
                    let sentimentData = [];
                    try {
                        let sentimentUrl = '/api/market-sentiment/history?limit=1440';
                        if (date) {
                            sentimentUrl += `&date=${formatDate(date)}`;
                            console.log('🔍 查询历史情绪数据，日期:', formatDate(date));
                        } else {
                            console.log('🔍 查询今日情绪数据（无date参数）');
                        }
                        sentimentUrl += `&_t=${Date.now()}`;
                        
                        console.log('📡 Fetching sentiment data from:', sentimentUrl);
                        
                        const sentimentResponse = await fetch(sentimentUrl, {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        const sentimentResult = await sentimentResponse.json();
                        
                        console.log('📡 Sentiment API response:', {
                            success: sentimentResult.success,
                            dataCount: sentimentResult.data ? sentimentResult.data.length : 0,
                            dataType: Array.isArray(sentimentResult.data) ? 'array' : typeof sentimentResult.data
                        });
                        
                        if (sentimentResult.success && sentimentResult.data) {
                            // 市场情绪数据可能返回单个对象或数组
                            sentimentData = Array.isArray(sentimentResult.data) ? sentimentResult.data : [sentimentResult.data];
                            console.log('✅ 市场情绪数据加载成功，数据点:', sentimentData.length);
                            
                            // 过滤出见顶/见底信号
                            const topSignals = sentimentData.filter(s => s.sentiment && s.sentiment.includes('见顶'));
                            const bottomSignals = sentimentData.filter(s => s.sentiment && (s.sentiment.includes('见底') || s.sentiment.includes('底部背离')));
                            const topDivergence = sentimentData.filter(s => s.sentiment && s.sentiment.includes('顶部背离'));
                            const bottomDivergence = sentimentData.filter(s => s.sentiment && s.sentiment.includes('底部背离'));
                            
                            console.log('📊 市场情绪信号统计:', {
                                见顶信号: topSignals.length,
                                顶部背离: topDivergence.length,
                                见底信号: bottomSignals.length,
                                底部背离: bottomDivergence.length,
                                总计: topSignals.length + topDivergence.length + bottomSignals.length + bottomDivergence.length
                            });
                        } else {
                            console.log('⚠️ 市场情绪数据为空或加载失败，返回数据:', sentimentResult);
                        }
                    } catch (e) {
                        console.error('❌ 市场情绪数据加载失败:', e);
                    }
                    
                    // 找出最高价和最低价
                    const maxChange = Math.max(...changes);
                    const minChange = Math.min(...changes);
                    const maxIndex = changes.indexOf(maxChange);
                    const minIndex = changes.indexOf(minChange);
                    
                    console.log('📊 准备更新趋势图，数据:', {times, changes, maxChange, minChange});
                    
                    // 更新趋势图，添加最高价和最低价标记
                    // 使用 notMerge: true 强制重新渲染整个图表
                    console.log('📊 调用 trendChart.setOption，trendChart是否存在:', !!trendChart);
                    trendChart.setOption({
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            },
                            formatter: function(params) {
                                if (!params || params.length === 0) return '';
                                
                                const time = params[0].axisValue;
                                const dataIndex = params[0].dataIndex;
                                
                                let html = `<div style="padding: 8px; min-width: 200px;">
                                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                        <i class="far fa-clock" style="margin-right: 4px;"></i>${time}
                                    </div>`;
                                
                                // 显示涨跌幅数据
                                const changeParam = params.find(p => p.seriesName === '27币涨跌幅之和');
                                if (changeParam) {
                                    const value = changeParam.value;
                                    
                                    // 获取上涨占比
                                    let upRatio = '--';
                                    if (historyData && historyData[dataIndex]) {
                                        if (historyData[dataIndex].up_ratio !== undefined) {
                                            upRatio = historyData[dataIndex].up_ratio.toFixed(1) + '%';
                                        } else if (historyData[dataIndex].changes) {
                                            const changes = historyData[dataIndex].changes;
                                            const changesArray = Object.values(changes);
                                            const upCoins = changesArray.filter(coin => coin.change_pct > 0).length;
                                            const totalCoins = changesArray.length;
                                            upRatio = totalCoins > 0 ? (upCoins / totalCoins * 100).toFixed(1) + '%' : '--';
                                        }
                                    }
                                    
                                    html += `<div style="margin-bottom: 4px;">
                                        ${changeParam.marker}<span style="font-weight: 600;">${changeParam.seriesName}</span>
                                    </div>
                                    <div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">
                                        ${value > 0 ? '+' : ''}${value}%
                                    </div>
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 13px;">
                                            <span style="color: #6B7280;">上涨占比:</span>
                                            <span style="font-weight: 600; color: #10B981;">${upRatio}</span>
                                        </div>
                                    </div>`;
                                }
                                
                                // 显示RSI数据
                                const rsiParam = params.find(p => p.seriesName === 'RSI之和');
                                if (rsiParam && rsiParam.value !== null && rsiParam.value !== undefined) {
                                    const rsiValue = rsiParam.value;
                                    const avgRsi = (rsiValue / 27).toFixed(2);
                                    
                                    let status = '中性';
                                    let statusColor = '#6B7280';
                                    if (rsiValue > 1890) {
                                        status = '超买';
                                        statusColor = '#EF4444';
                                    } else if (rsiValue < 810) {
                                        status = '超卖';
                                        statusColor = '#10B981';
                                    }
                                    
                                    html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB;">
                                        <div style="margin-bottom: 4px;">
                                            ${rsiParam.marker}<span style="font-weight: 600; color: #9CA3AF;">RSI之和</span>
                                        </div>
                                        <div style="font-size: 14px; font-weight: bold; color: #9CA3AF;">
                                            ${rsiValue.toFixed(2)}
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 12px; margin-top: 4px;">
                                            <span style="color: #6B7280;">平均RSI:</span>
                                            <span style="font-weight: 600;">${avgRsi}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 12px;">
                                            <span style="color: #6B7280;">市场状态:</span>
                                            <span style="font-weight: 600; color: ${statusColor};">${status}</span>
                                        </div>
                                    </div>`;
                                }
                                
                                html += '</div>';
                                return html;
                            }
                        },
                        xAxis: { 
                            type: 'category',
                            boundaryGap: false,
                            data: times 
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '涨跌幅 (%)',
                                position: 'left',
                                axisLabel: {
                                    formatter: '{value}%'
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: '#3B82F6'
                                    }
                                }
                            },
                            {
                                type: 'value',
                                name: 'RSI之和',
                                position: 'right',
                                min: 0,
                                max: 2700,
                                axisLabel: {
                                    formatter: '{value}'
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: '#9CA3AF'
                                    }
                                },
                                splitLine: {
                                    show: false
                                }
                            }
                        ],
                        series: [{
                            name: '27币涨跌幅之和',
                            type: 'line',
                            smooth: true,
                            data: changes,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                        { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                                    ]
                                }
                            },
                            markPoint: {
                                data: (function() {
                                    const points = [
                                        {
                                            name: '最高价',
                                            value: maxChange.toFixed(2) + '%',
                                            xAxis: maxIndex,
                                            yAxis: maxChange,
                                            itemStyle: {
                                                color: '#EF4444'
                                            },
                                            label: {
                                                formatter: '{b}\n{c}',
                                                fontSize: 14,
                                                fontWeight: 'bold'
                                            }
                                        },
                                        {
                                            name: '最低价',
                                            value: minChange.toFixed(2) + '%',
                                            xAxis: minIndex,
                                            yAxis: minChange,
                                            itemStyle: {
                                                color: '#10B981'
                                            },
                                            label: {
                                                formatter: '{b}\n{c}',
                                                fontSize: 14,
                                                fontWeight: 'bold'
                                            }
                                        }
                                    ];
                                    
                                    // 添加波峰标记点 (B-A-C三点)
                                    if (wavePeaksData && wavePeaksData.length > 0) {
                                        console.log('🔍 开始添加波峰标记点，波峰数量:', wavePeaksData.length);
                                        console.log('🔍 Times数组示例（前5个）:', times.slice(0, 5));
                                        console.log('🔍 Times数组示例（中间5个）:', times.slice(Math.floor(times.length/2), Math.floor(times.length/2) + 5));
                                        
                                        wavePeaksData.forEach((peak, peakIdx) => {
                                            // B点 (谷底)
                                            const bTime = peak.b_point.beijing_time.split(' ')[1];
                                            const bIndex = times.indexOf(bTime);
                                            console.log(`🔍 波峰${peakIdx+1} B点: ${peak.b_point.beijing_time} -> 时间=${bTime}, 索引=${bIndex}`);
                                            
                                            // 如果找不到，尝试查找相似的时间
                                            if (bIndex < 0) {
                                                const similar = times.find(t => t && t.includes(bTime.substring(0, 5)));
                                                console.log(`  ⚠️ 未找到精确匹配，相似时间:`, similar);
                                            }
                                            
                                            if (bIndex >= 0) {
                                                points.push({
                                                    name: `波峰${peakIdx+1}-B`,
                                                    value: `B: ${peak.b_point.value.toFixed(1)}%`,
                                                    xAxis: bIndex,
                                                    yAxis: peak.b_point.value,
                                                    itemStyle: {
                                                        color: '#06B6D4',
                                                        borderColor: '#fff',
                                                        borderWidth: 3
                                                    },
                                                    label: {
                                                        formatter: (params) => {
                                                            return `${params.name}\n${params.value}`;
                                                        },
                                                        fontSize: 12,
                                                        fontWeight: 'bold',
                                                        color: '#06B6D4',
                                                        show: true,
                                                        position: 'bottom'
                                                    },
                                                    symbol: 'circle',
                                                    symbolSize: 18
                                                });
                                            }
                                            
                                            // A点 (峰顶)
                                            const aTime = peak.a_point.beijing_time.split(' ')[1];
                                            const aIndex = times.indexOf(aTime);
                                            console.log(`🔍 波峰${peakIdx+1} A点: ${peak.a_point.beijing_time} -> 时间=${aTime}, 索引=${aIndex}`);
                                            if (aIndex >= 0) {
                                                points.push({
                                                    name: `波峰${peakIdx+1}-A`,
                                                    value: `A: ${peak.a_point.value.toFixed(1)}%`,
                                                    xAxis: aIndex,
                                                    yAxis: peak.a_point.value,
                                                    itemStyle: {
                                                        color: '#F59E0B',
                                                        borderColor: '#fff',
                                                        borderWidth: 3
                                                    },
                                                    label: {
                                                        formatter: (params) => {
                                                            return `${params.name}\n${params.value}`;
                                                        },
                                                        fontSize: 12,
                                                        fontWeight: 'bold',
                                                        color: '#F59E0B',
                                                        show: true,
                                                        position: 'top'
                                                    },
                                                    symbol: 'triangle',
                                                    symbolSize: 20
                                                });
                                            }
                                            
                                            // C点 (回调后反弹点)
                                            const cTime = peak.c_point.beijing_time.split(' ')[1];
                                            const cIndex = times.indexOf(cTime);
                                            console.log(`🔍 波峰${peakIdx+1} C点: ${peak.c_point.beijing_time} -> 时间=${cTime}, 索引=${cIndex}`);
                                            if (cIndex >= 0) {
                                                points.push({
                                                    name: `波峰${peakIdx+1}-C`,
                                                    value: `C: ${peak.c_point.value.toFixed(1)}%`,
                                                    xAxis: cIndex,
                                                    yAxis: peak.c_point.value,
                                                    itemStyle: {
                                                        color: '#8B5CF6',
                                                        borderColor: '#fff',
                                                        borderWidth: 3
                                                    },
                                                    label: {
                                                        formatter: (params) => {
                                                            return `${params.name}\n${params.value}`;
                                                        },
                                                        fontSize: 12,
                                                        fontWeight: 'bold',
                                                        color: '#8B5CF6',
                                                        show: true,
                                                        position: 'right'
                                                    },
                                                    symbol: 'diamond',
                                                    symbolSize: 18
                                                });
                                            }
                                        });
                                        
                                        console.log('✅ 完整波峰标记点添加完成，总标记点数:', points.length);
                                    }
                                    
                                    // 添加未完成的B-A波峰标记（A候选出现后就显示）
                                    // state = 4: CONFIRMING_A（正在确认A点，A候选已出现）
                                    // state = 5: LOOKING_FOR_C（等待C点形成，A点已确认）
                                    if (currentState && (currentState.state === 4 || currentState.state === 5) && currentState.b_candidate && currentState.a_candidate) {
                                        console.log('🔍 发现未完成的B-A波峰（A候选已出现）');
                                        
                                        // B点
                                        const bTime = currentState.b_candidate.beijing_time.split(' ')[1];
                                        const bIndex = times.indexOf(bTime);
                                        console.log(`🔍 未完成波峰 B点: ${currentState.b_candidate.beijing_time} -> 时间=${bTime}, 索引=${bIndex}`);
                                        
                                        if (bIndex >= 0) {
                                            points.push({
                                                name: `未完成-B`,
                                                value: `B: ${currentState.b_candidate.value.toFixed(1)}%`,
                                                xAxis: bIndex,
                                                yAxis: currentState.b_candidate.value,
                                                itemStyle: {
                                                    color: '#06B6D4',
                                                    borderColor: '#fff',
                                                    borderWidth: 3,
                                                    opacity: 0.7  // 半透明表示未完成
                                                },
                                                label: {
                                                    formatter: (params) => {
                                                        return `${params.name}\n${params.value}`;
                                                    },
                                                    fontSize: 12,
                                                    fontWeight: 'bold',
                                                    color: '#06B6D4',
                                                    show: true,
                                                    position: 'bottom'
                                                },
                                                symbol: 'circle',
                                                symbolSize: 18
                                            });
                                        }
                                        
                                        // A点（已确认）
                                        const aTime = currentState.a_candidate.beijing_time.split(' ')[1];
                                        const aIndex = times.indexOf(aTime);
                                        console.log(`🔍 未完成波峰 A点: ${currentState.a_candidate.beijing_time} -> 时间=${aTime}, 索引=${aIndex}`);
                                        
                                        if (aIndex >= 0) {
                                            points.push({
                                                name: `未完成-A`,
                                                value: `A: ${currentState.a_candidate.value.toFixed(1)}%`,
                                                xAxis: aIndex,
                                                yAxis: currentState.a_candidate.value,
                                                itemStyle: {
                                                    color: '#F59E0B',
                                                    borderColor: '#fff',
                                                    borderWidth: 3,
                                                    opacity: 0.7  // 半透明表示未完成
                                                },
                                                label: {
                                                    formatter: (params) => {
                                                        return `${params.name}\n${params.value}`;
                                                    },
                                                    fontSize: 12,
                                                    fontWeight: 'bold',
                                                    color: '#F59E0B',
                                                    show: true,
                                                    position: 'top'
                                                },
                                                symbol: 'triangle',
                                                symbolSize: 20
                                            });
                                        }
                                        
                                        console.log('✅ 未完成B-A波峰标记点添加完成');
                                    }
                                    
                                    // 添加市场情绪信号标记（见顶/见底信号）
                                    if (sentimentData && sentimentData.length > 0) {
                                        console.log('🔍 开始添加市场情绪信号标记，数据点:', sentimentData.length);
                                        
                                        sentimentData.forEach((sentiment, idx) => {
                                            const sentimentText = sentiment.sentiment || '';
                                            const beijingTime = sentiment.beijing_time || '';
                                            
                                            // 标记所有市场情绪信号：见顶、见底、顶部背离、底部背离
                                            const hasSignal = sentimentText.includes('见顶') || 
                                                            sentimentText.includes('见底') || 
                                                            sentimentText.includes('顶部背离') || 
                                                            sentimentText.includes('底部背离');
                                            
                                            if (!hasSignal) {
                                                return;
                                            }
                                            
                                            // 提取时间（HH:MM:SS）
                                            const time = beijingTime.split(' ')[1] || '';
                                            if (!time) return;
                                            
                                            // 提取小时和分钟（HH:MM）用于模糊匹配
                                            const timeHHMM = time.substring(0, 5);  // '08:45:03' -> '08:45'
                                            
                                            // 查找时间对应的索引（模糊匹配：只比较HH:MM）
                                            let timeIndex = -1;
                                            for (let i = 0; i < times.length; i++) {
                                                const chartTimeHHMM = times[i].substring(0, 5);
                                                if (chartTimeHHMM === timeHHMM) {
                                                    timeIndex = i;
                                                    break;
                                                }
                                            }
                                            
                                            if (timeIndex >= 0 && changes[timeIndex] !== undefined) {
                                                const isTopSignal = sentimentText.includes('见顶信号');
                                                const isBottomSignal = sentimentText.includes('见底信号');
                                                const isTopDivergence = sentimentText.includes('顶部背离');
                                                const isBottomDivergence = sentimentText.includes('底部背离');
                                                
                                                console.log(`🔍 情绪信号: ${sentimentText} @ ${beijingTime}, 索引=${timeIndex}, 涨跌幅=${changes[timeIndex].toFixed(2)}%`);
                                                
                                                // ⚠️ 见顶信号 - 深红色倒三角（最强烈的顶部警告）
                                                if (isTopSignal) {
                                                    points.push({
                                                        name: '⚠️见顶信号',
                                                        value: `见顶\n${changes[timeIndex].toFixed(1)}%`,
                                                        xAxis: timeIndex,
                                                        yAxis: changes[timeIndex],
                                                        itemStyle: {
                                                            color: '#DC2626',
                                                            borderColor: '#fff',
                                                            borderWidth: 2
                                                        },
                                                        label: {
                                                            formatter: '{b}',
                                                            fontSize: 13,
                                                            fontWeight: 'bold',
                                                            color: '#DC2626',
                                                            show: true,
                                                            position: 'top',
                                                            backgroundColor: '#FEE2E2',
                                                            padding: [4, 8],
                                                            borderRadius: 4
                                                        },
                                                        symbol: 'triangle',
                                                        symbolRotate: 180,
                                                        symbolSize: 24
                                                    });
                                                }
                                                
                                                // ⛔ 顶部背离 - 橙红色圆圈（顶部预警）
                                                if (isTopDivergence) {
                                                    points.push({
                                                        name: '⛔顶部背离',
                                                        value: `顶背\n${changes[timeIndex].toFixed(1)}%`,
                                                        xAxis: timeIndex,
                                                        yAxis: changes[timeIndex],
                                                        itemStyle: {
                                                            color: '#F97316',
                                                            borderColor: '#fff',
                                                            borderWidth: 2
                                                        },
                                                        label: {
                                                            formatter: '{b}',
                                                            fontSize: 11,
                                                            fontWeight: 'bold',
                                                            color: '#F97316',
                                                            show: true,
                                                            position: 'top',
                                                            backgroundColor: '#FFEDD5',
                                                            padding: [3, 6],
                                                            borderRadius: 4
                                                        },
                                                        symbol: 'circle',
                                                        symbolSize: 18
                                                    });
                                                }
                                                
                                                // 🔥 见底信号 - 深绿色向上箭头（最强烈的底部机会）
                                                if (isBottomSignal) {
                                                    points.push({
                                                        name: '🔥见底信号',
                                                        value: `见底\n${changes[timeIndex].toFixed(1)}%`,
                                                        xAxis: timeIndex,
                                                        yAxis: changes[timeIndex],
                                                        itemStyle: {
                                                            color: '#059669',
                                                            borderColor: '#fff',
                                                            borderWidth: 2
                                                        },
                                                        label: {
                                                            formatter: '{b}',
                                                            fontSize: 13,
                                                            fontWeight: 'bold',
                                                            color: '#059669',
                                                            show: true,
                                                            position: 'bottom',
                                                            backgroundColor: '#D1FAE5',
                                                            padding: [4, 8],
                                                            borderRadius: 4
                                                        },
                                                        symbol: 'arrow',
                                                        symbolRotate: 180,
                                                        symbolSize: 24
                                                    });
                                                }
                                                
                                                // 🚀 底部背离 - 青绿色菱形（底部预期反弹）
                                                if (isBottomDivergence) {
                                                    points.push({
                                                        name: '🚀底部背离',
                                                        value: `底背\n${changes[timeIndex].toFixed(1)}%`,
                                                        xAxis: timeIndex,
                                                        yAxis: changes[timeIndex],
                                                        itemStyle: {
                                                            color: '#10B981',
                                                            borderColor: '#fff',
                                                            borderWidth: 2
                                                        },
                                                        label: {
                                                            formatter: '{b}',
                                                            fontSize: 11,
                                                            fontWeight: 'bold',
                                                            color: '#10B981',
                                                            show: true,
                                                            position: 'bottom',
                                                            backgroundColor: '#ECFDF5',
                                                            padding: [3, 6],
                                                            borderRadius: 4
                                                        },
                                                        symbol: 'diamond',
                                                        symbolSize: 18
                                                    });
                                                }
                                            }
                                        });
                                        
                                        console.log('✅ 市场情绪信号标记添加完成');
                                    }
                                    
                                    console.log('✅ 所有波峰标记点添加完成，总标记点数:', points.length);
                                    
                                    return points;
                                })(),
                                symbol: 'pin',
                                symbolSize: 60
                            },
                            markLine: {
                                silent: false,
                                symbol: 'none',
                                data: [
                                    // 关键支撑线 +300%
                                    {
                                        yAxis: 300,
                                        name: '+300%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#EF4444'
                                        },
                                        lineStyle: {
                                            color: '#EF4444',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // 关键支撑线 +180%
                                    {
                                        yAxis: 180,
                                        name: '+180%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#DC2626'
                                        },
                                        lineStyle: {
                                            color: '#DC2626',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // 关键支撑线 +90%
                                    {
                                        yAxis: 90,
                                        name: '+90%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#F59E0B'
                                        },
                                        lineStyle: {
                                            color: '#F59E0B',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // 关键支撑线 -90%
                                    {
                                        yAxis: -90,
                                        name: '-90%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#3B82F6'
                                        },
                                        lineStyle: {
                                            color: '#3B82F6',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // 关键支撑线 -180%
                                    {
                                        yAxis: -180,
                                        name: '-180%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#7C3AED'
                                        },
                                        lineStyle: {
                                            color: '#7C3AED',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    },
                                    // 关键支撑线 -300%
                                    {
                                        yAxis: -300,
                                        name: '-300%',
                                        label: {
                                            formatter: '{b}',
                                            position: 'end',
                                            fontSize: 12,
                                            fontWeight: 'bold',
                                            color: '#10B981'
                                        },
                                        lineStyle: {
                                            color: '#10B981',
                                            width: 2,
                                            type: 'dashed'
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            name: 'RSI之和',
                            type: 'line',
                            yAxisIndex: 1,
                            smooth: true,
                            data: rsiValues.length > 0 ? rsiValues : [],
                            lineStyle: {
                                width: 2,
                                type: 'dashed',
                                color: '#9CA3AF'
                            },
                            itemStyle: {
                                color: '#9CA3AF'
                            },
                            showSymbol: true,
                            symbol: 'circle',
                            symbolSize: 5,
                            connectNulls: true,
                            zlevel: 1,
                            emphasis: {
                                focus: 'series',
                                lineStyle: {
                                    width: 4,
                                    color: '#9333EA',
                                    type: 'solid',
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(147, 51, 234, 0.5)'
                                },
                                itemStyle: {
                                    color: '#9333EA',
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }
                            },
                            markPoint: {
                                data: (() => {
                                    // 计算RSI的最高点和最低点（排除null值）
                                    const validRsiValues = rsiValues.filter(v => v !== null && v !== undefined);
                                    if (validRsiValues.length === 0) return [];
                                    
                                    let maxRsi = -Infinity;
                                    let minRsi = Infinity;
                                    let maxRsiIndex = -1;
                                    let minRsiIndex = -1;
                                    
                                    rsiValues.forEach((value, index) => {
                                        if (value !== null && value !== undefined) {
                                            if (value > maxRsi) {
                                                maxRsi = value;
                                                maxRsiIndex = index;
                                            }
                                            if (value < minRsi) {
                                                minRsi = value;
                                                minRsiIndex = index;
                                            }
                                        }
                                    });
                                    
                                    const markPoints = [];
                                    
                                    if (maxRsiIndex >= 0) {
                                        markPoints.push({
                                            name: 'RSI最高',
                                            value: maxRsi.toFixed(2),
                                            xAxis: maxRsiIndex,
                                            yAxis: maxRsi,
                                            itemStyle: {
                                                color: '#9333EA'  // 紫色标记
                                            },
                                            label: {
                                                formatter: '{b}\n{c}',
                                                fontSize: 12,
                                                fontWeight: 'bold',
                                                color: '#000000'  // 黑色字体
                                            }
                                        });
                                    }
                                    
                                    if (minRsiIndex >= 0) {
                                        markPoints.push({
                                            name: 'RSI最低',
                                            value: minRsi.toFixed(2),
                                            xAxis: minRsiIndex,
                                            yAxis: minRsi,
                                            itemStyle: {
                                                color: '#10B981'  // 浅绿色
                                            },
                                            label: {
                                                formatter: '{b}\n{c}',
                                                fontSize: 12,
                                                fontWeight: 'bold',
                                                color: '#000000'  // 黑色字体
                                            }
                                        });
                                    }
                                    
                                    return markPoints;
                                })(),
                                symbol: 'pin',
                                symbolSize: 50
                            }
                        },
                        // 独立的市场情绪信号系列（不受图例切换影响）
                        {
                            name: '市场情绪信号',
                            type: 'scatter',
                            yAxisIndex: 0,  // 使用左轴（涨跌幅）
                            data: (function() {
                                console.log('🔍 开始生成市场情绪scatter系列数据...');
                                console.log('📊 sentimentData:', {
                                    exists: !!sentimentData,
                                    isArray: Array.isArray(sentimentData),
                                    length: sentimentData ? sentimentData.length : 0
                                });
                                console.log('📊 times:', {
                                    exists: !!times,
                                    isArray: Array.isArray(times),
                                    length: times ? times.length : 0
                                });
                                console.log('📊 changes:', {
                                    exists: !!changes,
                                    isArray: Array.isArray(changes),
                                    length: changes ? changes.length : 0
                                });
                                
                                // 收集所有市场情绪信号的数据点
                                const signalPoints = [];
                                
                                if (sentimentData && sentimentData.length > 0) {
                                    console.log('✅ sentimentData有数据，开始处理...');
                                    
                                    sentimentData.forEach((sentiment, idx) => {
                                        const sentimentText = sentiment.sentiment || '';
                                        const beijingTime = sentiment.beijing_time || '';
                                        
                                        // 检查是否为信号
                                        const hasSignal = sentimentText.includes('见顶') || 
                                                        sentimentText.includes('见底') || 
                                                        sentimentText.includes('顶部背离') || 
                                                        sentimentText.includes('底部背离');
                                        
                                        if (!hasSignal) return;
                                        
                                        // 提取时间并匹配索引
                                        const time = beijingTime.split(' ')[1] || '';
                                        if (!time) {
                                            console.warn(`⚠️ 信号 ${idx} 缺少时间: ${beijingTime}`);
                                            return;
                                        }
                                        
                                        const timeHHMM = time.substring(0, 5);
                                        let timeIndex = -1;
                                        for (let i = 0; i < times.length; i++) {
                                            const chartTimeHHMM = times[i].substring(0, 5);
                                            if (chartTimeHHMM === timeHHMM) {
                                                timeIndex = i;
                                                break;
                                            }
                                        }
                                        
                                        if (timeIndex >= 0 && changes[timeIndex] !== undefined) {
                                            const isTopSignal = sentimentText.includes('见顶信号');
                                            const isBottomSignal = sentimentText.includes('见底信号');
                                            const isTopDivergence = sentimentText.includes('顶部背离');
                                            const isBottomDivergence = sentimentText.includes('底部背离');
                                            
                                            // 添加数据点 [x, y, 信号类型, 情绪文本]
                                            signalPoints.push({
                                                value: [timeIndex, changes[timeIndex]],
                                                signalType: isTopSignal ? 'topSignal' : 
                                                           isTopDivergence ? 'topDivergence' :
                                                           isBottomSignal ? 'bottomSignal' : 'bottomDivergence',
                                                sentiment: sentimentText,
                                                time: beijingTime
                                            });
                                            
                                            if (idx < 5) {  // 只记录前5个信号的详细信息
                                                console.log(`✅ 添加信号点 ${idx}: ${sentimentText} @ ${beijingTime}, 索引=${timeIndex}, 涨跌幅=${changes[timeIndex].toFixed(2)}%`);
                                            }
                                        } else {
                                            if (idx < 5) {
                                                console.warn(`⚠️ 信号 ${idx} 无法匹配时间: ${beijingTime}, 提取的HHMM=${timeHHMM}, 索引=${timeIndex}`);
                                            }
                                        }
                                    });
                                    
                                    console.log('✅ 市场情绪scatter系列数据生成完成，总点数:', signalPoints.length);
                                } else {
                                    console.warn('⚠️ sentimentData为空或不存在，无法生成市场情绪信号');
                                }
                                
                                console.log('📊 最终返回的信号点数:', signalPoints.length);
                                return signalPoints;
                            })(),
                            symbolSize: function(data) {
                                // 根据信号类型设置大小
                                const type = data.signalType;
                                return (type === 'topSignal' || type === 'bottomSignal') ? 24 : 18;
                            },
                            symbol: function(data) {
                                // 根据信号类型设置形状
                                const type = data.signalType;
                                if (type === 'topSignal') return 'triangle';
                                if (type === 'topDivergence') return 'circle';
                                if (type === 'bottomSignal') return 'arrow';
                                if (type === 'bottomDivergence') return 'diamond';
                                return 'circle';
                            },
                            symbolRotate: function(data) {
                                // 见顶信号和见底信号需要旋转
                                const type = data.signalType;
                                return (type === 'topSignal' || type === 'bottomSignal') ? 180 : 0;
                            },
                            itemStyle: {
                                color: function(params) {
                                    const type = params.data.signalType;
                                    if (type === 'topSignal') return '#DC2626';
                                    if (type === 'topDivergence') return '#F97316';
                                    if (type === 'bottomSignal') return '#059669';
                                    if (type === 'bottomDivergence') return '#10B981';
                                    return '#6B7280';
                                },
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                position: function(params) {
                                    const type = params.data.signalType;
                                    return (type === 'topSignal' || type === 'topDivergence') ? 'top' : 'bottom';
                                },
                                formatter: function(params) {
                                    const type = params.data.signalType;
                                    if (type === 'topSignal') return '⚠️见顶';
                                    if (type === 'topDivergence') return '⛔顶背';
                                    if (type === 'bottomSignal') return '🔥见底';
                                    if (type === 'bottomDivergence') return '🚀底背';
                                    return '';
                                },
                                fontSize: function(params) {
                                    const type = params.data.signalType;
                                    return (type === 'topSignal' || type === 'bottomSignal') ? 13 : 11;
                                },
                                fontWeight: 'bold',
                                color: function(params) {
                                    const type = params.data.signalType;
                                    if (type === 'topSignal') return '#DC2626';
                                    if (type === 'topDivergence') return '#F97316';
                                    if (type === 'bottomSignal') return '#059669';
                                    if (type === 'bottomDivergence') return '#10B981';
                                    return '#6B7280';
                                },
                                backgroundColor: function(params) {
                                    const type = params.data.signalType;
                                    if (type === 'topSignal') return '#FEE2E2';
                                    if (type === 'topDivergence') return '#FFEDD5';
                                    if (type === 'bottomSignal') return '#D1FAE5';
                                    if (type === 'bottomDivergence') return '#ECFDF5';
                                    return '#F3F4F6';
                                },
                                padding: function(params) {
                                    const type = params.data.signalType;
                                    return (type === 'topSignal' || type === 'bottomSignal') ? [4, 8] : [3, 6];
                                },
                                borderRadius: 4
                            },
                            tooltip: {
                                formatter: function(params) {
                                    const data = params.data;
                                    return `<div style="padding: 8px;">
                                        <div style="font-weight: bold; margin-bottom: 4px;">${data.sentiment}</div>
                                        <div style="font-size: 12px; color: #6B7280;">时间: ${data.time}</div>
                                        <div style="font-size: 12px; color: #6B7280;">涨跌幅: ${data.value[1].toFixed(2)}%</div>
                                    </div>`;
                                }
                            },
                            zlevel: 10,  // 确保在最上层显示
                            silent: false  // 允许交互
                        }]
                    }, true, true); // notMerge=true, lazyUpdate=true
                    
                    // 强制resize图表确保正确显示
                    // 多次resize确保图表正确显示
                    setTimeout(() => {
                        trendChart.resize();
                        rankChart.resize();
                        console.log('✅ 趋势图已渲染，数据点数:', changes.length);
                        console.log('📊 图表容器尺寸 -', 
                            'trendChart:', document.getElementById('trendChart').offsetWidth, 'x', document.getElementById('trendChart').offsetHeight,
                            'rankChart:', document.getElementById('rankChart').offsetWidth, 'x', document.getElementById('rankChart').offsetHeight);
                    }, 100);
                    
                    // 再次延迟resize
                    setTimeout(() => {
                        trendChart.resize();
                        rankChart.resize();
                        console.log('📊 第二次resize完成');
                    }, 500);
                    
                    // 更新波峰告警框
                    updateWavePeakAlert(wavePeaksData, falseBreakout, crashWarning);
                    
                    // 更新B-A-C波峰详情框
                    updateWavePeakDetails(wavePeaksData, currentState);
                } else {
                    console.warn('历史数据为空或加载失败');
                    console.warn('Result:', result);
                    // 如果没有数据，清空图表
                    trendChart.setOption({
                        xAxis: { data: [] },
                        series: [{ data: [] }]
                    }, true, true); // notMerge=true, lazyUpdate=true
                }
            } catch (error) {
                console.error('更新历史数据异常:', error);
            }
        }
        
        // 强制刷新数据（用户手动触发）
        async function forceRefreshData() {
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            
            // 显示加载动画
            icon.classList.add('fa-spin');
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            
            console.log('🔄 用户手动强制刷新数据...');
            
            try {
                // 同时刷新实时数据和历史数据
                await Promise.all([
                    updateLatestData(),
                    updateHistoryData(currentDate)  // 传递currentDate保持当前选择
                ]);
                
                console.log('✅ 数据刷新完成！');
                
                // 显示成功提示
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>刷新成功';
                btn.classList.remove('from-green-500', 'to-green-600');
                btn.classList.add('from-emerald-500', 'to-emerald-600');
                
                // 2秒后恢复按钮状态
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('from-emerald-500', 'to-emerald-600');
                    btn.classList.add('from-green-500', 'to-green-600');
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);
                
            } catch (error) {
                console.error('❌ 刷新数据失败:', error);
                
                // 显示错误提示
                btn.innerHTML = '<i class="fas fa-times mr-1"></i>刷新失败';
                btn.classList.remove('from-green-500', 'to-green-600');
                btn.classList.add('from-red-500', 'to-red-600');
                
                // 2秒后恢复按钮状态
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>刷新数据';
                    btn.classList.remove('from-red-500', 'to-red-600');
                    btn.classList.add('from-green-500', 'to-green-600');
                    icon.classList.remove('fa-spin');
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 2000);
            }
        }
        
        // 更新排行榜图表
        function updateRankChart(changes) {
            const validChanges = Object.entries(changes).filter(([_, v]) => !v.error);
            validChanges.sort((a, b) => b[1].change_pct - a[1].change_pct);
            
            const coins = validChanges.map(([k, _]) => k.replace('-USDT-SWAP', ''));
            const values = validChanges.map(([_, v]) => v.change_pct);
            
            rankChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const p = params[0];
                        const value = p.value;
                        const coin = p.axisValue;
                        
                        return `
                            <div style="padding: 8px; min-width: 150px;">
                                <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                    ${coin}
                                </div>
                                <div style="margin-bottom: 4px;">
                                    ${p.marker}<span style="font-weight: 600;">涨跌幅</span>
                                </div>
                                <div style="font-size: 16px; font-weight: bold; color: ${value > 0 ? '#10B981' : value < 0 ? '#EF4444' : '#6B7280'};">
                                    ${value > 0 ? '+' : ''}${value}%
                                </div>
                            </div>
                        `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                yAxis: {
                    type: 'category',
                    data: coins,
                    inverse: true
                },
                series: [{
                    type: 'bar',
                    data: values.map(v => ({
                        value: v,
                        itemStyle: {
                            color: v > 0 ? '#10B981' : v < 0 ? '#EF4444' : '#6B7280'
                        }
                    }))
                }]
            });
            
            // 强制resize图表确保正确显示
            setTimeout(() => {
                rankChart.resize();
                console.log('✅ 排行榜图已渲染，币种数:', coins.length);
            }, 100);
        }
        
        // 更新BTC当日涨跌幅状态
        function updateBTCStatus(changes) {
            // 查找BTC数据
            let btcChange = null;
            for (const [symbol, data] of Object.entries(changes)) {
                if (symbol.includes('BTC')) {
                    btcChange = data.change_pct || 0;
                    break;
                }
            }
            
            if (btcChange === null) {
                document.getElementById('btcChange').textContent = '--';
                document.getElementById('btcStatus').textContent = '暂无数据';
                return;
            }
            
            // 更新涨跌幅显示
            const btcChangeEl = document.getElementById('btcChange');
            btcChangeEl.textContent = `${btcChange > 0 ? '+' : ''}${btcChange.toFixed(2)}%`;
            
            // 根据涨跌幅确定状态和样式
            let status = '';
            let bgColor = '';
            let textColor = '';
            let borderColor = '';
            
            if (btcChange < -3) {
                status = '主跌';
                bgColor = 'bg-red-50';
                textColor = 'text-red-600';
                borderColor = 'border-red-600';
            } else if (btcChange >= -3 && btcChange < -1.5) {
                status = '大幅下跌';
                bgColor = 'bg-orange-50';
                textColor = 'text-orange-600';
                borderColor = 'border-orange-500';
            } else if (btcChange >= -1.5 && btcChange < 0) {
                status = '小幅震荡偏空';
                bgColor = 'bg-yellow-50';
                textColor = 'text-yellow-600';
                borderColor = 'border-yellow-400';
            } else if (btcChange >= 0 && btcChange < 1.5) {
                status = '小幅震荡偏多';
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-600';
                borderColor = 'border-blue-400';
            } else if (btcChange >= 1.5 && btcChange < 3) {
                status = '大幅上涨';
                bgColor = 'bg-green-50';
                textColor = 'text-green-600';
                borderColor = 'border-green-500';
            } else {
                status = '主升';
                bgColor = 'bg-emerald-50';
                textColor = 'text-emerald-600';
                borderColor = 'border-emerald-600';
            }
            
            // 更新状态显示
            document.getElementById('btcStatus').textContent = status;
            document.getElementById('btcStatus').className = `text-lg font-semibold ${textColor}`;
            btcChangeEl.className = `text-3xl font-bold mb-2 ${textColor}`;
            
            // 更新卡片样式
            const btcCard = document.getElementById('btcChangeCard');
            btcCard.className = `p-4 rounded-lg border-2 transition-all duration-300 ${bgColor} ${borderColor}`;
        }
        
        // 更新波峰告警框
        function updateWavePeakAlert(wavePeaksData, falseBreakout, crashWarning) {
            const alertBox = document.getElementById('wavePeakAlertBox');
            const alertContent = document.getElementById('wavePeakAlertContent');
            const alertTitle = document.getElementById('wavePeakAlertTitle');
            
            // 如果没有任何信号，隐藏告警框
            if (!falseBreakout && !crashWarning) {
                alertBox.style.display = 'none';
                return;
            }
            
            // 显示告警框
            alertBox.style.display = 'block';
            
            // 动态更新标题
            if (crashWarning && falseBreakout) {
                alertTitle.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>暴跌预警 + 假突破信号';
            } else if (crashWarning) {
                alertTitle.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>暴跌预警';
            } else {
                alertTitle.innerHTML = '<i class="fas fa-chart-line-down mr-2"></i>假突破信号';
            }
            
            let html = '<div class="space-y-4">';
            
            // 显示暴跌预警（优先级更高）
            if (crashWarning) {
                const isHighLevel = crashWarning.warning_level === 'high';
                const aValues = crashWarning.comparisons?.a_values || {};
                const bValues = crashWarning.comparisons?.b_values || {};
                const isDescending = crashWarning.pattern?.a_descending || false;  // 顶部递减模式
                const isAscending = crashWarning.pattern?.a_ascending || false;    // 底部递增模式
                
                html += `
                    <div class="bg-white p-4 rounded-lg shadow-sm border-2 ${isHighLevel ? 'border-red-500' : 'border-orange-400'}">
                        <p class="text-lg font-semibold ${isHighLevel ? 'text-red-700' : 'text-orange-700'} mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>${crashWarning.warning}
                        </p>
                        <p class="text-gray-700 mb-3">
                            <strong>模式：</strong>${crashWarning.pattern_name || '暴跌预警'} - ${crashWarning.pattern.description}
                        </p>
                        
                        <!-- A点趋势 -->
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border-2 border-orange-300 mb-3">
                            <div class="text-base font-bold text-orange-800 mb-3 flex items-center">
                                ${isDescending 
                                    ? '<i class="fas fa-chart-line-down mr-2"></i>A点趋势（反弹高点递减）' 
                                    : '<i class="fas fa-chart-line-up mr-2"></i>A点趋势（反弹高点递增）'
                                }
                            </div>
                            <div class="space-y-2">
                                <div class="bg-white p-3 rounded-lg border border-orange-400">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">A1 → A2:</span>
                                            <span class="text-sm text-gray-600">
                                                ${aValues.a1?.toFixed(2)}% → ${aValues.a2?.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 ${isDescending ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'} rounded-full text-xs font-semibold">
                                                <i class="fas ${isDescending ? 'fa-arrow-down' : 'fa-arrow-up'} mr-1"></i>${isDescending ? '下降' : '上升'}
                                            </span>
                                            <span class="text-xs ${isDescending ? 'text-red-600' : 'text-orange-600'} font-semibold">
                                                ${aValues.a2_vs_a1?.diff >= 0 ? '+' : ''}${aValues.a2_vs_a1?.diff?.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-3 rounded-lg border border-orange-400">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">A2 → A3:</span>
                                            <span class="text-sm text-gray-600">
                                                ${aValues.a2?.toFixed(2)}% → ${aValues.a3?.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 ${isDescending ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'} rounded-full text-xs font-semibold">
                                                <i class="fas ${isDescending ? 'fa-arrow-down' : 'fa-arrow-up'} mr-1"></i>${isDescending ? '下降' : '上升'}
                                            </span>
                                            <span class="text-xs ${isDescending ? 'text-red-600' : 'text-orange-600'} font-semibold">
                                                ${aValues.a3_vs_a2?.diff >= 0 ? '+' : ''}${aValues.a3_vs_a2?.diff?.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                
                // 如果B点也在递减，显示更强烈的警告
                if (crashWarning.pattern.b_descending) {
                    html += `
                        <div class="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg border-2 border-red-500">
                            <div class="text-base font-bold text-red-800 mb-3 flex items-center">
                                <i class="fas fa-chart-line-down mr-2"></i>B点趋势（谷底递减，加速下跌）
                            </div>
                            <div class="space-y-2">
                                <div class="bg-white p-3 rounded-lg border border-red-400">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">B1 → B2:</span>
                                            <span class="text-sm text-gray-600">
                                                ${bValues.b1?.toFixed(2)}% → ${bValues.b2?.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                                <i class="fas fa-arrow-down mr-1"></i>下降
                                            </span>
                                            <span class="text-xs text-red-600 font-semibold">
                                                ${bValues.b2_vs_b1?.diff?.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-3 rounded-lg border border-red-400">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">B2 → B3:</span>
                                            <span class="text-sm text-gray-600">
                                                ${bValues.b2?.toFixed(2)}% → ${bValues.b3?.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                                <i class="fas fa-arrow-down mr-1"></i>下降
                                            </span>
                                            <span class="text-xs text-red-600 font-semibold">
                                                ${bValues.b3_vs_b2?.diff?.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-400 mt-3">
                            <p class="text-sm font-semibold text-yellow-800 mb-1">
                                <i class="fas fa-lightbulb mr-1"></i>交易建议
                            </p>
                            <ul class="text-sm text-yellow-900 space-y-1 ml-4">
                                <li>• ${isHighLevel ? '考虑立即离场或开空单' : '谨慎观望，控制仓位'}</li>
                                <li>• ${isHighLevel ? '设置严格止损，防范大幅下跌' : '等待跌势确认后再做空'}</li>
                                <li>• ${isHighLevel ? '关注重要支撑位突破情况' : '密切关注后续波峰形态'}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            // 显示假突破预警
            if (falseBreakout) {
            const comparisons = falseBreakout.comparisons || {};
            const a1 = comparisons.a1 || 0;
            const a2 = comparisons.a2 || 0;
            const a3 = comparisons.a3 || 0;
            const a2VsA1 = comparisons.a2_vs_a1 || {};
            const a3VsA1 = comparisons.a3_vs_a1 || {};
            const a3VsA2 = comparisons.a3_vs_a2 || {};
            
            // 构建告警内容
            html += `
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <p class="text-lg font-semibold text-red-700 mb-2">
                            <i class="fas fa-chart-line-down mr-2"></i>检测到假突破 - 市场可能转跌
                        </p>
                        <p class="text-gray-700 mb-3">
                            连续 <span class="font-bold text-red-600">${falseBreakout.consecutive_peaks}</span> 个波峰的最高点（A点）
                            均未突破第一个波峰的前高 (<span class="font-bold">${falseBreakout.reference_high.toFixed(2)}%</span>)，
                            市场上涨动能减弱，可能进入下跌趋势。
                        </p>
                        
                        <!-- A点比较判断框 -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-2 border-blue-300 mb-4">
                            <div class="text-base font-bold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-balance-scale mr-2"></i>A点突破判断
                            </div>
                            <div class="space-y-2">
                                <!-- A2 vs A1 -->
                                <div class="bg-white p-3 rounded-lg border ${a2VsA1.breaks ? 'border-green-400' : 'border-red-400'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">A2 vs A1:</span>
                                            <span class="text-sm text-gray-600">
                                                ${a2.toFixed(2)}% vs ${a1.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            ${a2VsA1.breaks 
                                                ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><i class="fas fa-check-circle mr-1"></i>突破</span>'
                                                : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><i class="fas fa-times-circle mr-1"></i>未突破</span>'
                                            }
                                            <span class="text-xs ${a2VsA1.diff >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                                ${a2VsA1.diff >= 0 ? '+' : ''}${a2VsA1.diff.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- A3 vs A1 -->
                                <div class="bg-white p-3 rounded-lg border ${a3VsA1.breaks ? 'border-green-400' : 'border-red-400'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">A3 vs A1:</span>
                                            <span class="text-sm text-gray-600">
                                                ${a3.toFixed(2)}% vs ${a1.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            ${a3VsA1.breaks 
                                                ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><i class="fas fa-check-circle mr-1"></i>突破</span>'
                                                : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><i class="fas fa-times-circle mr-1"></i>未突破</span>'
                                            }
                                            <span class="text-xs ${a3VsA1.diff >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                                ${a3VsA1.diff >= 0 ? '+' : ''}${a3VsA1.diff.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- A3 vs A2 -->
                                <div class="bg-white p-3 rounded-lg border ${a3VsA2.breaks ? 'border-green-400' : 'border-red-400'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-gray-700">A3 vs A2:</span>
                                            <span class="text-sm text-gray-600">
                                                ${a3.toFixed(2)}% vs ${a2.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            ${a3VsA2.breaks 
                                                ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold"><i class="fas fa-check-circle mr-1"></i>突破</span>'
                                                : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold"><i class="fas fa-times-circle mr-1"></i>未突破</span>'
                                            }
                                            <span class="text-xs ${a3VsA2.diff >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                                ${a3VsA2.diff >= 0 ? '+' : ''}${a3VsA2.diff.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            `;
            
            // 添加3个波峰的信息
            falseBreakout.peaks.forEach((peak, idx) => {
                html += `
                    <div class="bg-gray-50 p-3 rounded border ${idx === 0 ? 'border-blue-400' : 'border-gray-300'}">
                        <div class="text-sm font-semibold text-gray-700 mb-2">
                            ${idx === 0 ? '第一波峰（参考）' : `第${idx+1}波峰`}
                        </div>
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-600">A点（峰顶）:</span>
                                <span class="font-bold ${peak.a_point.value > falseBreakout.reference_high ? 'text-green-600' : 'text-red-600'}">
                                    ${peak.a_point.value.toFixed(1)}%
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">B点（谷底）:</span>
                                <span class="font-semibold">${peak.b_point.value.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">振幅:</span>
                                <span class="font-semibold text-blue-600">${peak.amplitude.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded">
                            <p class="text-sm font-semibold text-yellow-800 mb-1">
                                <i class="fas fa-lightbulb mr-1"></i>交易建议：
                            </p>
                            <ul class="text-sm text-yellow-700 space-y-1 ml-5 list-disc">
                                <li>谨慎追高，建议观望或减仓</li>
                                <li>关注是否跌破第3波峰的B点支撑位</li>
                                <li>等待明确的反转信号后再考虑入场</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            }  // 闭合 if (falseBreakout)
            
            html += '</div>';  // 闭合最外层的 <div class="space-y-4">
            alertContent.innerHTML = html;
        }
        
        // 更新B-A-C波峰详情框
        function updateWavePeakDetails(wavePeaksData, currentState) {
            const detailsBox = document.getElementById('wavePeakDetailsBox');
            const detailsContent = document.getElementById('wavePeakDetailsContent');
            
            console.log('🔍 updateWavePeakDetails 被调用');
            console.log('  wavePeaksData:', wavePeaksData);
            console.log('  currentState:', currentState);
            
            // 如果没有波峰数据、没有进行中的波峰、也没有候选点，隐藏详情框
            if ((!wavePeaksData || wavePeaksData.length === 0) && 
                (!currentState || (!currentState.incomplete_peak && !currentState.b_candidate && !currentState.a_candidate))) {
                detailsBox.style.display = 'none';
                return;
            }
            
            // 显示详情框
            detailsBox.style.display = 'block';
            
            // 构建波峰详情内容
            let html = `
                <div class="mb-3 text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    检测到 <span class="font-bold text-blue-600">${wavePeaksData.length}</span> 个完整波峰
                    （最小振幅 ≥35%，15分钟确认）
                </div>
            `;
            
            wavePeaksData.forEach((peak, idx) => {
                const peakNum = idx + 1;
                html += `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-blue-800">
                                <i class="fas fa-mountain mr-2"></i>波峰 ${peakNum}
                            </h4>
                            <div class="text-sm">
                                <span class="px-2 py-1 bg-blue-600 text-white rounded-full text-xs font-semibold">
                                    振幅: ${peak.amplitude.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- B点（谷底） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-cyan-400 shadow-sm">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-cyan-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        B
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">谷底（起点）</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono font-semibold">${peak.b_point.beijing_time.split(' ')[1]}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="font-bold ${peak.b_point.value < 0 ? 'text-red-600' : 'text-green-600'}">
                                            ${peak.b_point.value.toFixed(2)}%
                                        </span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-check-circle text-cyan-500 mr-1"></i>15分钟内最低
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- A点（峰顶） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-orange-400 shadow-sm">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-orange-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        A
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">峰顶（最高点）</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono font-semibold">${peak.a_point.beijing_time.split(' ')[1]}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="font-bold ${peak.a_point.value > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${peak.a_point.value.toFixed(2)}%
                                        </span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-check-circle text-orange-500 mr-1"></i>15分钟内最高
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C点（回调反弹） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-purple-400 shadow-sm">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-purple-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        C
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">回调反弹点</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono font-semibold">${peak.c_point.beijing_time.split(' ')[1]}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="font-bold ${peak.c_point.value > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${peak.c_point.value.toFixed(2)}%
                                        </span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-arrow-down text-red-500 mr-1"></i>回调 ${peak.decline_ratio.toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 波峰统计信息 -->
                        <div class="mt-3 pt-3 border-t border-blue-200 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">B→A振幅</div>
                                <div class="font-bold text-blue-600">${peak.amplitude.toFixed(2)}%</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">A→C回调</div>
                                <div class="font-bold text-orange-600">${peak.decline.toFixed(2)}%</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">回调比例</div>
                                <div class="font-bold text-purple-600">${peak.decline_ratio.toFixed(1)}%</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">持续时长</div>
                                <div class="font-bold text-gray-700">
                                    ${calculateDuration(peak.b_point.beijing_time, peak.c_point.beijing_time)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // 如果有进行中的波峰，显示它
            if (currentState && currentState.incomplete_peak) {
                const peak = currentState.incomplete_peak;
                html += `
                    <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg p-4 border-2 border-yellow-400 mt-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-yellow-800">
                                <i class="fas fa-clock mr-2"></i>⏳ 进行中的波峰
                            </h4>
                            <div class="text-sm">
                                <span class="px-2 py-1 bg-yellow-500 text-white rounded-full text-xs font-semibold animate-pulse">
                                    等待C点形成
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- B点（谷底） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-cyan-400 shadow-sm">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-cyan-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        B
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">谷底（起点）✅</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono font-semibold">${peak.b_point.beijing_time.split(' ')[1]}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="font-bold ${peak.b_point.value < 0 ? 'text-red-600' : 'text-green-600'}">
                                            ${peak.b_point.value.toFixed(2)}%
                                        </span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-green-600 font-semibold">
                                            <i class="fas fa-check-circle mr-1"></i>已确认
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- A点（峰顶） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-orange-400 shadow-sm">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-orange-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        A
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">峰顶（最高点）✅</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono font-semibold">${peak.a_point.beijing_time.split(' ')[1]}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="font-bold ${peak.a_point.value > 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${peak.a_point.value.toFixed(2)}%
                                        </span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-green-600 font-semibold">
                                            <i class="fas fa-check-circle mr-1"></i>已确认
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C点（等待中） -->
                            <div class="bg-white rounded-lg p-3 border-2 border-dashed border-purple-300 shadow-sm opacity-75">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-purple-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                        C
                                    </div>
                                    <div class="text-sm font-semibold text-gray-700">回调反弹点⏳</div>
                                </div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">时间:</span>
                                        <span class="font-mono text-gray-400">--:--:--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">涨跌幅:</span>
                                        <span class="text-gray-400">待确定</span>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs text-yellow-600 font-semibold animate-pulse">
                                            <i class="fas fa-hourglass-half mr-1"></i>等待形成
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 波峰统计信息 -->
                        <div class="mt-3 pt-3 border-t border-yellow-200 grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">B→A振幅</div>
                                <div class="font-bold text-blue-600">${peak.amplitude.toFixed(2)}%</div>
                            </div>
                            <div class="bg-white rounded p-2">
                                <div class="text-gray-600">状态</div>
                                <div class="font-bold text-yellow-600">${peak.status}</div>
                            </div>
                        </div>
                        
                        <!-- 提示信息 -->
                        <div class="mt-3 p-3 bg-yellow-100 rounded-lg border border-yellow-300">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-2"></i>
                                <div class="text-xs text-gray-700">
                                    <strong>提示：</strong>A点已确认，正在等待价格回落超过50%振幅（${(peak.amplitude / 2).toFixed(2)}%）后反弹，形成C点。
                                    <br>目标回落幅度：≥ ${(peak.amplitude * 0.5).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 显示候选点（B点候选或A点候选，但还未完全确认）
            // 只有在没有incomplete_peak时才显示候选点UI
            // incomplete_peak只在state=5时存在，表示B-A都已确认，等待C点
            if (currentState && !currentState.incomplete_peak && currentState.state) {
                const stateValue = currentState.state;
                
                console.log(`🔍 检查候选点显示，state=${stateValue}, has b_candidate=${!!currentState.b_candidate}, has a_candidate=${!!currentState.a_candidate}`);
                
                // State 2: CONFIRMING_B - 正在确认B点
                // State 3: LOOKING_FOR_A - 寻找A点（B点已确认）
                if ((stateValue === 2 || stateValue === 3) && currentState.b_candidate) {
                    // 显示B点候选
                    html += `
                        <div class="bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg p-4 border-2 border-dashed border-gray-400 mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-bold text-gray-700">
                                    <i class="fas fa-hourglass-half mr-2"></i>⏳ 候选点检测中
                                </h4>
                                <div class="text-sm">
                                    <span class="px-2 py-1 bg-gray-400 text-white rounded-full text-xs font-semibold animate-pulse">
                                        ${stateValue === 2 ? '确认B点中...' : '等待振幅≥35%'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- B点候选 -->
                                <div class="bg-white rounded-lg p-3 border-2 border-dashed border-cyan-300 shadow-sm opacity-80">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-cyan-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            B
                                        </div>
                                        <div class="text-sm font-semibold text-gray-700">谷底（候选）⏳</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">时间:</span>
                                            <span class="font-mono font-semibold">${currentState.b_candidate.beijing_time.split(' ')[1]}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">涨跌幅:</span>
                                            <span class="font-bold ${currentState.b_candidate.value < 0 ? 'text-red-600' : 'text-green-600'}">
                                                ${currentState.b_candidate.value.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-gray-600 font-semibold animate-pulse">
                                                <i class="fas fa-clock mr-1"></i>${stateValue === 2 ? '等待15分钟确认' : '等待上涨≥35%'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- A点候选（占位） -->
                                <div class="bg-white rounded-lg p-3 border-2 border-dashed border-gray-200 shadow-sm opacity-40">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            A
                                        </div>
                                        <div class="text-sm font-semibold text-gray-400">峰顶（等待）</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">时间:</span>
                                            <span class="font-mono text-gray-300">--:--:--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">涨跌幅:</span>
                                            <span class="text-gray-300">待确定</span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-gray-400">
                                                <i class="fas fa-ban mr-1"></i>等待B点确认
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- C点候选（占位） -->
                                <div class="bg-white rounded-lg p-3 border-2 border-dashed border-gray-200 shadow-sm opacity-40">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            C
                                        </div>
                                        <div class="text-sm font-semibold text-gray-400">回调反弹点（等待）</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">时间:</span>
                                            <span class="font-mono text-gray-300">--:--:--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">涨跌幅:</span>
                                            <span class="text-gray-300">待确定</span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-gray-400">
                                                <i class="fas fa-ban mr-1"></i>等待A点确认
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 提示信息 -->
                            <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-2"></i>
                                    <div class="text-xs text-gray-700">
                                        <strong>状态说明：</strong>
                                        ${stateValue === 2 ? 
                                            'B点候选已发现，正在等待15分钟确认窗口。如果期间出现更低点，B点会被更新。' : 
                                            'B点已确认，正在寻找A点候选。需要价格上涨超过35%才能形成A点候选。'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (stateValue === 4 && currentState.a_candidate && currentState.b_candidate) {
                    // 显示B点确认 + A点候选（正在确认A点）
                    const amplitude = currentState.a_candidate.value - currentState.b_candidate.value;
                    html += `
                        <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg p-4 border-2 border-dashed border-amber-400 mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-bold text-amber-800">
                                    <i class="fas fa-hourglass-half mr-2"></i>⏳ 候选点检测中
                                </h4>
                                <div class="text-sm">
                                    <span class="px-2 py-1 bg-amber-500 text-white rounded-full text-xs font-semibold animate-pulse">
                                        确认A点中...
                                    </span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- B点（已确认） -->
                                <div class="bg-white rounded-lg p-3 border-2 border-cyan-400 shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-cyan-400 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            B
                                        </div>
                                        <div class="text-sm font-semibold text-gray-700">谷底（已确认）✅</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">时间:</span>
                                            <span class="font-mono font-semibold">${currentState.b_candidate.beijing_time.split(' ')[1]}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">涨跌幅:</span>
                                            <span class="font-bold ${currentState.b_candidate.value < 0 ? 'text-red-600' : 'text-green-600'}">
                                                ${currentState.b_candidate.value.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-green-600 font-semibold">
                                                <i class="fas fa-check-circle mr-1"></i>已确认
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- A点候选（正在确认） -->
                                <div class="bg-white rounded-lg p-3 border-2 border-dashed border-orange-300 shadow-sm opacity-80">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-orange-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            A
                                        </div>
                                        <div class="text-sm font-semibold text-gray-700">峰顶（候选）⏳</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">时间:</span>
                                            <span class="font-mono font-semibold">${currentState.a_candidate.beijing_time.split(' ')[1]}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">涨跌幅:</span>
                                            <span class="font-bold ${currentState.a_candidate.value > 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${currentState.a_candidate.value.toFixed(2)}%
                                            </span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-amber-600 font-semibold animate-pulse">
                                                <i class="fas fa-clock mr-1"></i>等待15分钟确认
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- C点候选（占位） -->
                                <div class="bg-white rounded-lg p-3 border-2 border-dashed border-gray-200 shadow-sm opacity-40">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold mr-2">
                                            C
                                        </div>
                                        <div class="text-sm font-semibold text-gray-400">回调反弹点（等待）</div>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">时间:</span>
                                            <span class="font-mono text-gray-300">--:--:--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">涨跌幅:</span>
                                            <span class="text-gray-300">待确定</span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <div class="text-xs text-gray-400">
                                                <i class="fas fa-ban mr-1"></i>等待A点确认
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 波峰统计信息 -->
                            <div class="mt-3 pt-3 border-t border-amber-200 grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-600">B→A振幅</div>
                                    <div class="font-bold text-blue-600">${amplitude.toFixed(2)}%</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div class="text-gray-600">状态</div>
                                    <div class="font-bold text-amber-600">等待A点15分钟确认</div>
                                </div>
                            </div>
                            
                            <!-- 提示信息 -->
                            <div class="mt-3 p-3 bg-amber-100 rounded-lg border border-amber-300">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-amber-600 mt-0.5 mr-2"></i>
                                    <div class="text-xs text-gray-700">
                                        <strong>状态说明：</strong>B点已确认，A点候选已发现（振幅${amplitude.toFixed(2)}%）。
                                        正在等待15分钟确认窗口，如果期间出现更高点，A点会被更新。
                                        A点确认后即可在图表上看到B-A标记。
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            detailsContent.innerHTML = html;
        }
        
        // 计算时长（分钟）
        function calculateDuration(startTime, endTime) {
            try {
                const start = new Date('2026-01-01 ' + startTime.split(' ')[1]);
                const end = new Date('2026-01-01 ' + endTime.split(' ')[1]);
                const diffMs = end - start;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins >= 60) {
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    return `${hours}h${mins}m`;
                }
                return `${diffMins}分钟`;
            } catch (e) {
                return '--';
            }
        }
        
        // 折叠/展开BAC详情
        function toggleWavePeakDetails() {
            const content = document.getElementById('wavePeakDetailsContent');
            const icon = document.getElementById('wavePeakDetailsToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // 折叠/展开假突破做空策略
        function toggleFalseBreakoutStrategy() {
            const content = document.getElementById('falseBreakoutStrategyContent');
            const icon = document.getElementById('falseBreakoutToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // 更新详细表格
        function updateDetailTable(changes, rsiValues = {}) {
            const tbody = document.getElementById('detailTable');
            
            // 转换为数组并排序
            const changesArray = Object.entries(changes)
                .filter(([_, v]) => !v.error && v.baseline_price !== undefined && v.current_price !== undefined && v.change_pct !== undefined)
                .sort((a, b) => b[1].change_pct - a[1].change_pct);
            
            tbody.innerHTML = changesArray.map(([symbol, data]) => {
                const coin = symbol.replace('-USDT-SWAP', '');
                const changePct = data.change_pct || 0;
                const changeClass = changePct > 0 ? 'text-green-600' : changePct < 0 ? 'text-red-600' : 'text-gray-600';
                const changePrefix = changePct > 0 ? '+' : '';
                
                const baselinePrice = (data.baseline_price || 0).toFixed(4);
                const currentPrice = (data.current_price || 0).toFixed(4);
                
                // 获取RSI值
                const rsiValue = rsiValues[coin];
                let rsiDisplay = '--';
                let rsiClass = 'text-gray-600';
                if (rsiValue !== undefined && rsiValue !== null) {
                    rsiDisplay = rsiValue.toFixed(2);
                    if (rsiValue > 70) {
                        rsiClass = 'text-red-600 font-bold';
                    } else if (rsiValue < 30) {
                        rsiClass = 'text-green-600 font-bold';
                    } else {
                        rsiClass = 'text-gray-600';
                    }
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${coin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">$${baselinePrice}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">$${currentPrice}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${changeClass} font-bold">${changePrefix}${changePct.toFixed(2)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap ${rsiClass}">${rsiDisplay}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // 更新日期选择器和按钮状态
        function updateDateSelector() {
            const dateInput = document.getElementById('dateSelector');
            dateInput.value = formatDate(currentDate);
            
            // 检查是否是今天
            const isToday = formatDate(currentDate) === formatDate(new Date());
            const nextDayBtn = document.getElementById('nextDay');
            const todayBtn = document.getElementById('todayBtn');
            
            // 如果是今天，禁用"后一天"按钮
            if (isToday) {
                nextDayBtn.disabled = true;
                nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                todayBtn.disabled = true;
                todayBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextDayBtn.disabled = false;
                nextDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                todayBtn.disabled = false;
                todayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // 切换到前一天
        function goToPrevDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateSelector();
            updateHistoryData(currentDate);
        }
        
        // 切换到后一天
        function goToNextDay() {
            const today = new Date();
            const nextDay = new Date(currentDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            // 不能超过今天
            if (formatDate(nextDay) <= formatDate(today)) {
                currentDate = nextDay;
                updateDateSelector();
                updateHistoryData(currentDate);
            }
        }
        
        // 切换到今天
        function goToToday() {
            currentDate = new Date();
            updateDateSelector();
            updateLatestData();
            updateHistoryData();
        }
        
        // 手动选择日期
        function onDateChange(e) {
            const selectedDate = parseDate(e.target.value);
            const today = new Date();
            
            // 不能选择未来的日期
            if (selectedDate <= today) {
                currentDate = selectedDate;
                updateDateSelector();
                updateHistoryData(currentDate);
                
                // 🆕 同时刷新市场情绪历史数据
                loadSentimentHistory();
            } else {
                // 恢复为今天
                e.target.value = formatDate(currentDate);
                alert('不能选择未来的日期');
            }
        }
        
        // ========== 市场情绪分析功能 ==========
        
        // 加载市场情绪数据
        async function loadMarketSentiment() {
            try {
                const response = await fetch(`/api/market-sentiment/latest?_t=${Date.now()}`, {
                    cache: 'no-store'
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateMarketSentimentUI(result.data);
                } else {
                    console.warn('⚠️ 暂无市场情绪数据');
                }
            } catch (error) {
                console.error('❌ 加载市场情绪失败:', error);
            }
        }
        
        // 更新市场情绪UI
        function updateMarketSentimentUI(data) {
            // 当前情绪
            const sentimentCard = document.getElementById('sentimentCard');
            const currentSentiment = document.getElementById('currentSentiment');
            const sentimentReason = document.getElementById('sentimentReason');
            const sentimentTime = document.getElementById('sentimentTime');
            
            let sentimentText = data.sentiment || '--';  // 保留完整情绪文本
            let sentimentColor = '';
            let borderColor = '';
            
            // 根据情绪类型设置颜色和边框
            if (data.sentiment_type === 'bullish') {
                sentimentColor = 'text-green-600';
                borderColor = 'border-green-500';
            } else if (data.sentiment_type === 'bearish') {
                sentimentColor = 'text-red-600';
                borderColor = 'border-red-500';
            } else {
                sentimentColor = 'text-gray-600';
                borderColor = 'border-gray-400';
            }
            
            currentSentiment.textContent = sentimentText;
            currentSentiment.className = `text-2xl font-bold mb-2 ${sentimentColor}`;  // 从text-3xl改为text-2xl
            sentimentCard.className = `bg-white rounded-lg p-4 shadow-md border-l-4 ${borderColor}`;
            sentimentReason.textContent = data.reason || '--';
            sentimentTime.textContent = data.beijing_time || '--';
            
            // 币价变化
            const coinData = data.coin_data;
            document.getElementById('coinChangeFrom').textContent = coinData.prev_cumulative_pct.toFixed(2) + '%';
            document.getElementById('coinChangeTo').textContent = coinData.curr_cumulative_pct.toFixed(2) + '%';
            document.getElementById('coinChangeDelta').textContent = (coinData.change_delta >= 0 ? '+' : '') + coinData.change_delta.toFixed(2) + '%';
            
            const coinChangePercent = document.getElementById('coinChangePercent');
            const coinPct = coinData.change_pct;
            coinChangePercent.textContent = `(${coinPct >= 0 ? '+' : ''}${coinPct.toFixed(2)}%)`;
            coinChangePercent.className = `text-sm font-medium ${coinPct >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            // RSI变化
            const rsiData = data.rsi_data;
            document.getElementById('rsiChangeFrom').textContent = rsiData.prev_total_rsi.toFixed(2);
            document.getElementById('rsiChangeTo').textContent = rsiData.curr_total_rsi.toFixed(2);
            document.getElementById('rsiChangeDelta').textContent = (rsiData.change_delta >= 0 ? '+' : '') + rsiData.change_delta.toFixed(2);
            
            const rsiChangePercent = document.getElementById('rsiChangePercent');
            const rsiPct = rsiData.change_pct;
            rsiChangePercent.textContent = `(${rsiPct >= 0 ? '+' : ''}${rsiPct.toFixed(2)}%)`;
            rsiChangePercent.className = `text-sm font-medium ${rsiPct >= 0 ? 'text-purple-600' : 'text-orange-600'}`;
        }
        
        // 刷新市场情绪
        async function refreshMarketSentiment() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            
            // 添加旋转动画
            icon.classList.add('fa-spin');
            btn.disabled = true;
            
            await loadMarketSentiment();
            
            // 如果详情面板是展开的，也刷新历史数据
            const detailsPanel = document.getElementById('sentimentDetailsPanel');
            if (detailsPanel.style.display !== 'none') {
                await loadSentimentHistory();
            }
            
            // 移除动画
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }, 500);
        }
        
        // 展开/折叠详情面板
        function toggleSentimentDetails() {
            const panel = document.getElementById('sentimentDetailsPanel');
            const btn = document.getElementById('sentimentToggleBtn');
            const icon = btn.querySelector('i');
            
            if (panel.style.display === 'none') {
                // 展开
                panel.style.display = 'block';
                icon.className = 'fas fa-chevron-up mr-1';
                btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>收起详情';
                
                // 加载历史数据
                loadSentimentHistory();
            } else {
                // 折叠
                panel.style.display = 'none';
                icon.className = 'fas fa-chevron-down mr-1';
                btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>展开详情';
            }
        }
        
        // 加载市场情绪历史数据
        async function loadSentimentHistory(limit = 20) {
            try {
                // 获取当前选择的日期（格式：YYYYMMDD）
                const date = formatDate(currentDate).replace(/-/g, '');
                const response = await fetch(`/api/market-sentiment/history?date=${date}&limit=${limit}&_t=${Date.now()}`, {
                    cache: 'no-store'
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    updateSentimentHistoryTable(result.data);
                } else {
                    document.getElementById('sentimentHistoryTable').innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-4 text-center text-gray-500">暂无历史数据</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('❌ 加载历史数据失败:', error);
                document.getElementById('sentimentHistoryTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="px-3 py-4 text-center text-red-500">加载失败</td>
                    </tr>
                `;
            }
        }
        
        // 切换显示条数
        function changeSentimentLimit() {
            const select = document.getElementById('sentimentLimitSelect');
            const limit = parseInt(select.value);
            document.getElementById('sentimentLimit').textContent = limit;
            loadSentimentHistory(limit);
        }
        
        // 切换日期
        function changeSentimentDate() {
            const datePicker = document.getElementById('sentimentDatePicker');
            const selectedDate = datePicker.value; // 格式: YYYY-MM-DD
            
            if (!selectedDate) return;
            
            const limit = parseInt(document.getElementById('sentimentLimitSelect').value) || 20;
            
            // 将YYYY-MM-DD转换为YYYYMMDD
            const dateStr = selectedDate.replace(/-/g, '');
            
            console.log(`📅 切换到日期: ${selectedDate} (${dateStr})`);
            
            // 加载指定日期的数据
            loadSentimentHistoryByDate(dateStr, limit);
        }
        
        // 返回今天
        function resetSentimentDate() {
            const datePicker = document.getElementById('sentimentDatePicker');
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            datePicker.value = todayStr;
            
            const limit = parseInt(document.getElementById('sentimentLimitSelect').value) || 20;
            loadSentimentHistory(limit);
            
            console.log('📅 已返回今天的数据');
        }
        
        // 切换到昨天
        function goToYesterday() {
            const datePicker = document.getElementById('sentimentDatePicker');
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0]; // YYYY-MM-DD
            
            datePicker.value = yesterdayStr;
            
            const limit = parseInt(document.getElementById('sentimentLimitSelect').value) || 20;
            
            // 将YYYY-MM-DD转换为YYYYMMDD
            const dateStr = yesterdayStr.replace(/-/g, '');
            
            console.log(`📅 切换到昨天: ${yesterdayStr} (${dateStr})`);
            
            // 加载昨天的数据
            loadSentimentHistoryByDate(dateStr, limit);
        }
        
        // 按日期加载市场情绪历史数据
        async function loadSentimentHistoryByDate(dateStr, limit = 20) {
            try {
                console.log(`📊 加载日期 ${dateStr} 的历史数据，条数: ${limit}`);
                
                const response = await fetch(`/api/market-sentiment/history?date=${dateStr}&limit=${limit}&_t=${Date.now()}`, {
                    cache: 'no-store'
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    updateSentimentHistoryTable(result.data);
                    console.log(`✅ 成功加载 ${result.data.length} 条记录`);
                } else {
                    document.getElementById('sentimentHistoryTable').innerHTML = `
                        <tr>
                            <td colspan="5" class="px-3 py-4 text-center text-gray-500">
                                ${dateStr} 暂无历史数据
                                <br>
                                <span class="text-xs">请选择其他日期或返回今天</span>
                            </td>
                        </tr>
                    `;
                    console.warn(`⚠️ ${dateStr} 无数据`);
                }
            } catch (error) {
                console.error('❌ 加载历史数据失败:', error);
                document.getElementById('sentimentHistoryTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="px-3 py-4 text-center text-red-500">
                            加载失败: ${error.message}
                            <br>
                            <span class="text-xs">请检查日期格式或网络连接</span>
                        </td>
                    </tr>
                `;
            }
        }
        
        // 更新历史数据表格
        function updateSentimentHistoryTable(historyData) {
            const tbody = document.getElementById('sentimentHistoryTable');
            
            tbody.innerHTML = historyData.map(item => {
                // ✅ 后端返回的beijing_time已经是北京时间，直接使用即可
                let displayTime = item.beijing_time;
                
                // 🔴 特殊处理见顶/见底信号
                let sentimentColor, sentimentIcon, rowBgClass = '';
                
                if (item.sentiment === '🔥见底信号' || item.sentiment.includes('见底')) {
                    sentimentColor = 'text-orange-600 font-bold';
                    sentimentIcon = '🔥';
                    rowBgClass = 'bg-orange-50 border-l-4 border-orange-500';
                } else if (item.sentiment === '⚠️见顶信号' || item.sentiment.includes('见顶')) {
                    sentimentColor = 'text-red-600 font-bold';
                    sentimentIcon = '⚠️';
                    rowBgClass = 'bg-red-50 border-l-4 border-red-500';
                } else {
                    sentimentColor = item.sentiment_type === 'bullish' ? 'text-green-600' : 
                                      item.sentiment_type === 'bearish' ? 'text-red-600' : 'text-gray-600';
                    sentimentIcon = item.sentiment_type === 'bullish' ? '🐂' : 
                                     item.sentiment_type === 'bearish' ? '🐻' : '😐';
                }
                
                const coinPctClass = item.coin_data.change_pct >= 0 ? 'text-green-600' : 'text-red-600';
                const rsiPctClass = item.rsi_data.change_pct >= 0 ? 'text-purple-600' : 'text-orange-600';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 ${rowBgClass}">
                        <td class="px-3 py-2 text-gray-600 whitespace-nowrap">${displayTime}</td>
                        <td class="px-3 py-2 ${sentimentColor}">${sentimentIcon} ${item.sentiment}</td>
                        <td class="px-3 py-2">
                            <span class="${coinPctClass} font-semibold">
                                ${item.coin_data.change_pct >= 0 ? '+' : ''}${item.coin_data.change_pct.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-3 py-2">
                            <span class="${rsiPctClass} font-semibold">
                                ${item.rsi_data.change_pct >= 0 ? '+' : ''}${item.rsi_data.change_pct.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">${item.reason}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // ========== 详细数据功能 ==========
        let detailedDataVisible = false;
        let currentDetailPage = 0;
        const detailPageSize = 20;
        let allDetailedData = [];
        
        // 切换详细数据显示
        function toggleDetailedData() {
            detailedDataVisible = !detailedDataVisible;
            const panel = document.getElementById('detailedDataPanel');
            const icon = document.getElementById('detailedDataIcon');
            
            if (detailedDataVisible) {
                panel.style.display = 'block';
                icon.className = 'fas fa-chevron-up text-purple-600';
                loadDetailedData();
            } else {
                panel.style.display = 'none';
                icon.className = 'fas fa-chevron-down text-purple-600';
            }
        }
        
        // 加载详细数据
        async function loadDetailedData() {
            try {
                // 同时获取市场情绪数据和最新的币价/RSI数据
                const [sentimentResp, latestResp] = await Promise.all([
                    fetch(`/api/market-sentiment/latest?limit=100&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`/api/coin-change-tracker/latest?t=${Date.now()}`, { cache: 'no-store' })
                ]);
                
                const sentimentData = await sentimentResp.json();
                const latestResult = await latestResp.json();
                
                if (sentimentData.success && sentimentData.data) {
                    allDetailedData = sentimentData.data;
                    
                    // 更新当前数据概览（注意要传递data字段）
                    if (latestResult.success && latestResult.data) {
                        updateDetailedOverview(latestResult.data);
                    }
                    
                    // 显示第一页
                    currentDetailPage = 0;
                    renderDetailedDataTable();
                }
            } catch (error) {
                console.error('加载详细数据失败:', error);
            }
        }
        
        // 更新详细数据概览
        function updateDetailedOverview(latestData) {
            if (!latestData) return;
            
            const coinChange = latestData.cumulative_pct || 0;
            const totalRSI = latestData.total_rsi || 0;
            const avgRSI = totalRSI / 27;
            
            // 计算比值（价格变化 / RSI平均值）
            const ratio = avgRSI !== 0 ? (Math.abs(coinChange) / avgRSI).toFixed(4) : '--';
            
            // 判断市场状态
            let marketState = '中性';
            if (ratio !== '--') {
                const ratioNum = parseFloat(ratio);
                if (ratioNum > 0.5) {
                    marketState = '价格主导';
                } else if (ratioNum < 0.2) {
                    marketState = 'RSI主导';
                } else {
                    marketState = '平衡状态';
                }
            }
            
            // 更新UI
            document.getElementById('detailCoinChange').textContent = coinChange.toFixed(2) + '%';
            document.getElementById('detailCoinChangePercent').textContent = coinChange >= 0 ? '↑ 上涨' : '↓ 下跌';
            document.getElementById('detailCoinChangePercent').className = `text-xs ${coinChange >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('detailRSI').textContent = totalRSI.toFixed(2);
            document.getElementById('detailRSIPercent').textContent = `平均: ${avgRSI.toFixed(2)}`;
            
            document.getElementById('detailRatio').textContent = ratio;
            document.getElementById('detailMarketState').textContent = marketState;
        }
        
        // 渲染详细数据表格
        function renderDetailedDataTable() {
            const tbody = document.getElementById('detailedDataTable');
            const start = currentDetailPage * detailPageSize;
            const end = start + detailPageSize;
            const pageData = allDetailedData.slice(start, end);
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-3 py-4 text-center text-gray-400">暂无数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = pageData.map(item => {
                const sentimentColor = item.sentiment_type === 'bullish' ? 'text-green-600 bg-green-50' : 
                                      item.sentiment_type === 'bearish' ? 'text-red-600 bg-red-50' : 'text-gray-600 bg-gray-50';
                const sentimentIcon = item.sentiment_type === 'bullish' ? '🐂' : 
                                     item.sentiment_type === 'bearish' ? '🐻' : '😐';
                
                const coinPctClass = item.coin_data.change_pct >= 0 ? 'text-green-600' : 'text-red-600';
                const rsiPctClass = item.rsi_data.change_pct >= 0 ? 'text-purple-600' : 'text-orange-600';
                
                // 计算比值
                const avgRSI = item.rsi_data.curr_total_rsi / 27;
                const ratio = avgRSI !== 0 ? (Math.abs(item.coin_data.curr_cumulative_pct) / avgRSI).toFixed(4) : '--';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-purple-50 transition-colors">
                        <td class="px-3 py-2 text-gray-600 whitespace-nowrap text-xs">${item.beijing_time}</td>
                        <td class="px-3 py-2 text-right">
                            <span class="${coinPctClass} font-semibold">
                                ${item.coin_data.curr_cumulative_pct.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <span class="${coinPctClass} text-xs">
                                ${item.coin_data.change_pct >= 0 ? '+' : ''}${item.coin_data.change_pct.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <span class="text-purple-700 font-semibold">
                                ${item.rsi_data.curr_total_rsi.toFixed(2)}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <span class="${rsiPctClass} text-xs">
                                ${item.rsi_data.change_pct >= 0 ? '+' : ''}${item.rsi_data.change_pct.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <span class="text-amber-700 font-semibold">${ratio}</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="${sentimentColor} px-2 py-1 rounded text-xs font-semibold">
                                ${sentimentIcon} ${item.sentiment}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-gray-600 text-xs">${item.reason}</td>
                    </tr>
                `;
            }).join('');
            
            // 更新分页信息
            document.getElementById('detailPageInfo').textContent = 
                `第 ${start + 1}-${Math.min(end, allDetailedData.length)} 条，共 ${allDetailedData.length}`;
        }
        
        // 分页控制
        function loadDetailedDataPage(direction) {
            if (direction === 'prev' && currentDetailPage > 0) {
                currentDetailPage--;
            } else if (direction === 'next' && (currentDetailPage + 1) * detailPageSize < allDetailedData.length) {
                currentDetailPage++;
            }
            renderDetailedDataTable();
        }
        
        // 数据缓存对象
        const dataCache = {
            latestData: { data: null, timestamp: 0, ttl: 10000 }, // 10秒缓存
            sentiment: { data: null, timestamp: 0, ttl: 30000 }, // 30秒缓存
            historyData: { data: null, timestamp: 0, ttl: 60000 } // 60秒缓存
        };
        
        // 缓存获取函数
        function getCachedData(key) {
            const cache = dataCache[key];
            if (cache && cache.data && (Date.now() - cache.timestamp < cache.ttl)) {
                console.log(`📦 使用缓存数据: ${key}`);
                return cache.data;
            }
            return null;
        }
        
        // 缓存设置函数
        function setCachedData(key, data) {
            if (dataCache[key]) {
                dataCache[key].data = data;
                dataCache[key].timestamp = Date.now();
                console.log(`💾 已缓存数据: ${key}`);
            }
        }
        
        // 初始化 - 高度优化版本（并行加载 + 缓存机制）
        window.onload = async function() {
            console.log('🚀 页面初始化开始...');
            const startTime = performance.now();
            
            // 第1步：立即初始化音频（无需等待）
            initAudio();
            const enableAudio = () => {
                initAudio();
                console.log('🎵 音频已启用（用户交互）');
            };
            document.addEventListener('click', enableAudio, { once: true });
            document.addEventListener('touchstart', enableAudio, { once: true });
            
            // 第2步：初始化图表骨架（无需等待数据）
            initCharts();
            console.log('✅ 图表初始化完成');
            
            // 第3步：并行加载关键数据（最重要的优化：3个请求同时发出）
            console.log('🔄 开始并行加载实时数据、市场情绪、历史数据...');
            
            const isToday = formatDate(currentDate) === formatDate(new Date());
            
            // 并行执行3个独立的数据加载任务
            const [latestResult, sentimentResult, historyResult] = await Promise.allSettled([
                updateLatestData(),
                loadMarketSentiment(),
                isToday ? updateHistoryData() : updateHistoryData(currentDate)
            ]);
            
            // 检查各个加载结果
            if (latestResult.status === 'fulfilled') {
                console.log('✅ 实时数据加载完成');
            } else {
                console.error('❌ 实时数据加载失败:', latestResult.reason);
            }
            
            if (sentimentResult.status === 'fulfilled') {
                console.log('✅ 市场情绪加载完成');
            } else {
                console.error('❌ 市场情绪加载失败:', sentimentResult.reason);
            }
            
            if (historyResult.status === 'fulfilled') {
                console.log('✅ 历史数据加载完成');
            } else {
                console.error('❌ 历史数据加载失败:', historyResult.reason);
            }
            
            // 第4步：更新日期选择器（无需等待）
            updateDateSelector();
            
            // 初始化市场情绪历史日期选择器
            const sentimentDatePicker = document.getElementById('sentimentDatePicker');
            if (sentimentDatePicker) {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                sentimentDatePicker.value = todayStr;
                sentimentDatePicker.max = todayStr; // 限制最大日期为今天
                console.log('✅ 市场情绪日期选择器已初始化:', todayStr);
            }
            
            // 第5步：后台懒加载账户余额信息（不阻塞页面显示）
            setTimeout(() => {
                loadAccountsBalance().then(() => {
                    console.log('✅ 账户余额信息已加载，可以使用策略功能');
                }).catch(error => {
                    console.error('❌ 账户余额加载失败:', error);
                });
            }, 100);
            
            const endTime = performance.now();
            console.log(`✅ 页面初始化完成，总耗时: ${((endTime - startTime) / 1000).toFixed(2)}秒`);
            console.log(`⚡ 性能提升: 采用并行加载 + 缓存机制，预计减少60%以上加载时间`);
            
            // 绑定日期选择器事件
            document.getElementById('prevDay').addEventListener('click', goToPrevDay);
            document.getElementById('nextDay').addEventListener('click', goToNextDay);
            document.getElementById('todayBtn').addEventListener('click', goToToday);
            document.getElementById('dateSelector').addEventListener('change', onDateChange);
            
            // 设置日期选择器的最大日期为今天
            const today = formatDate(new Date());
            document.getElementById('dateSelector').max = today;
            
            // 只有在查看今天时才自动刷新
            let autoRefreshInterval = null;
            let refreshCounter = 0;
            
            function startAutoRefresh() {
                console.log('🚀 启动自动刷新，间隔: 30秒');
                // 每30秒更新一次
                autoRefreshInterval = setInterval(async () => {
                    const isToday = formatDate(currentDate) === formatDate(new Date());
                    if (isToday) {
                        refreshCounter++;
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
                        console.log(`⏰ 自动刷新 #${refreshCounter} (${timeStr}): 开始更新所有数据...`);
                        
                        try {
                            // 每30秒全量刷新所有数据
                            console.log('📊 刷新实时数据...');
                            await updateLatestData();
                            
                            console.log('📊 刷新市场情绪数据...');
                            await loadMarketSentiment();
                            
                            console.log('📊 刷新历史数据...');
                            await updateHistoryData(currentDate);
                            
                            console.log(`✅ 自动刷新 #${refreshCounter} 完成 (${timeStr})`);
                            
                            // 显示刷新成功提示（可选）
                            showRefreshNotification();
                        } catch (error) {
                            console.error('❌ 自动刷新失败:', error);
                            showRefreshErrorNotification();
                        }
                    } else {
                        console.log('⚠️ 当前日期不是今天，跳过更新');
                    }
                }, 30000); // 30秒 = 30000毫秒
            }
            
            startAutoRefresh();
            
            // 启动刷新倒计时显示
            startRefreshCountdown();
            
            // 刷新倒计时显示函数
            function startRefreshCountdown() {
                let nextRefreshTime = Date.now() + 30000; // 30秒后
                
                function updateCountdown() {
                    const now = Date.now();
                    const remaining = nextRefreshTime - now;
                    
                    if (remaining <= 0) {
                        // 重置倒计时
                        nextRefreshTime = Date.now() + 30000;
                    }
                    
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    
                    const timerElement = document.getElementById('nextRefreshTime');
                    if (timerElement) {
                        if (minutes > 0) {
                            timerElement.textContent = `下次刷新: ${minutes}分${seconds}秒`;
                        } else {
                            timerElement.textContent = `下次刷新: ${seconds}秒`;
                        }
                        
                        // 最后10秒变红色提醒
                        const parentSpan = document.getElementById('autoRefreshTimer');
                        if (remaining <= 10000 && parentSpan) {
                            parentSpan.className = 'text-sm text-red-600 font-semibold';
                        } else if (parentSpan) {
                            parentSpan.className = 'text-sm text-gray-600';
                        }
                    }
                }
                
                // 每秒更新一次倒计时
                updateCountdown();
                setInterval(updateCountdown, 1000);
            }
            
            // 刷新成功提示
            function showRefreshNotification() {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    z-index: 9999;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
                
                notification.innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 18px;"></i>
                    <span>数据已自动更新 (${timeStr})</span>
                `;
                
                document.body.appendChild(notification);
                
                // 3秒后自动消失
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
                
                // 添加动画样式
                if (!document.getElementById('refreshNotificationStyle')) {
                    const style = document.createElement('style');
                    style.id = 'refreshNotificationStyle';
                    style.textContent = `
                        @keyframes slideInRight {
                            from {
                                transform: translateX(400px);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        @keyframes slideOutRight {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }
                            to {
                                transform: translateX(400px);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // 刷新失败提示
            function showRefreshErrorNotification() {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    z-index: 9999;
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                notification.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 18px;"></i>
                    <span>数据更新失败，请检查网络连接</span>
                `;
                
                document.body.appendChild(notification);
                
                // 5秒后自动消失
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 5000);
            }
            
            // 每天0点2分自动刷新页面（处理跨日期数据）
            function scheduleAutoPageRefresh() {
                // 获取当前北京时间
                const now = new Date();
                const beijingTime = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Shanghai'}));
                
                // 计算下一个0点2分（北京时间）
                const tomorrow = new Date(beijingTime);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 2, 0, 0); // 设置为明天0点2分
                
                // 计算当前浏览器本地时间到北京时间0点2分的时间差
                const timezoneOffset = now - beijingTime;
                const targetTime = new Date(tomorrow.getTime() + timezoneOffset);
                const timeUntilRefresh = targetTime - now;
                
                console.log(`🔄 页面将在北京时间 ${tomorrow.toLocaleString('zh-CN')} 自动刷新`);
                console.log(`⏰ 距离刷新还有 ${Math.floor(timeUntilRefresh / 1000 / 60)} 分钟 (${Math.floor(timeUntilRefresh / 1000 / 60 / 60)} 小时)`);
                
                setTimeout(() => {
                    console.log('🔄 执行每日0点2分自动刷新（处理跨日期数据）...');
                    location.reload();
                }, timeUntilRefresh);
            }
            
            // 加载所有账户的余额信息
            async function loadAccountsBalance() {
                try {
                    const accounts = JSON.parse(localStorage.getItem('okx_accounts') || '[]');
                    
                    if (accounts.length === 0) {
                        console.log('⚠️ 未找到账户信息');
                        return [];
                    }
                    
                    console.log(`🔄 正在加载 ${accounts.length} 个账户的余额信息...`);
                    
                    // 为每个账户获取余额
                    for (let account of accounts) {
                        if (!account.apiKey || !account.apiSecret || !account.passphrase) {
                            console.log(`⚠️ 账户 ${account.name} 缺少API凭证，跳过`);
                            continue;
                        }
                        
                        try {
                            const response = await fetch('/api/okx-trading/account-balance', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    apiKey: account.apiKey,
                                    apiSecret: account.apiSecret,
                                    passphrase: account.passphrase
                                })
                            });
                            
                            const result = await response.json();
                            if (result.success) {
                                // 使用现有API的格式：{success, balance, currency, raw_data}
                                const availBal = result.balance || 0;
                                
                                // 从raw_data中提取详细信息
                                let totalEq = availBal;
                                if (result.raw_data && result.raw_data.length > 0) {
                                    const details = result.raw_data[0].details || [];
                                    for (const detail of details) {
                                        if (detail.ccy === 'USDT') {
                                            totalEq = parseFloat(detail.eq || availBal);
                                            break;
                                        }
                                    }
                                }
                                
                                account.balance = {
                                    totalEquity: totalEq,
                                    availableBalance: availBal
                                };
                                console.log(`✅ 账户 ${account.name} 余额: ${account.balance.availableBalance} USDT`);
                            } else {
                                console.error(`❌ 账户 ${account.name} 余额获取失败:`, result.error);
                            }
                        } catch (error) {
                            console.error(`❌ 加载账户 ${account.name} 余额失败:`, error);
                        }
                    }
                    
                    // 保存更新后的账户数据到全局变量
                    window.accountsWithBalance = accounts;
                    console.log('✅ 所有账户余额加载完成');
                    return accounts;
                    
                } catch (error) {
                    console.error('❌ 加载账户余额失败:', error);
                    return [];
                }
            }
            
            // 策略应用函数
            function applyStrategy(range, threshold, leverage, direction) {
                console.log(`🎯 应用策略: ${range}, 阈值: ${threshold}%, 杠杆: ${leverage}x, 方向: ${direction}`);
                
                // 获取当前数据
                if (!window.currentCoinsData || window.currentCoinsData.length === 0) {
                    alert('❌ 暂无数据，请等待数据加载完成！');
                    return;
                }
                
                // 排序币种数据（按涨跌幅）
                const sortedCoins = [...window.currentCoinsData].sort((a, b) => b.change - a.change);
                
                // 选择目标币种
                let targetCoins = [];
                if (range === 'top8') {
                    // 涨幅前8名
                    targetCoins = sortedCoins.slice(0, 8);
                } else if (range === 'bottom8') {
                    // 跌幅后8名（即跌幅最大的8个）
                    targetCoins = sortedCoins.slice(-8).reverse();
                }
                
                // 显示策略详情
                const strategyDiv = document.getElementById('currentStrategy');
                const detailsDiv = document.getElementById('strategyDetails');
                
                const rangeText = range === 'top8' ? '涨幅前8名' : '跌幅后8名（跌幅最大的8个）';
                const directionText = direction === 'long' ? '做多（开多单）' : '做空（开空单）';
                const thresholdText = range === 'top8' ? '再涨' : '再跌';
                const directionIcon = direction === 'long' ? '📈' : '📉';
                const directionColor = direction === 'long' ? 'text-green-600' : 'text-red-600';
                
                let coinsListHTML = '<div class="mt-3 space-y-2">';
                targetCoins.forEach((coin, index) => {
                    const changeColor = coin.change >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeSign = coin.change >= 0 ? '+' : '';
                    coinsListHTML += `
                        <div class="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                            <span class="font-semibold">${index + 1}. ${coin.symbol}</span>
                            <span class="${changeColor} font-bold">${changeSign}${coin.change.toFixed(2)}%</span>
                        </div>
                    `;
                });
                coinsListHTML += '</div>';
                
                // 生成账户开仓建议HTML
                let accountsHTML = '';
                const accounts = window.accountsWithBalance || [];
                
                if (accounts.length === 0 || !accounts.some(a => a.balance)) {
                    accountsHTML = `
                        <div class="mt-4 p-3 bg-yellow-100 rounded border border-yellow-300">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-yellow-800 font-semibold">未加载账户余额信息</span>
                            </div>
                            <p class="text-sm text-yellow-700 mt-1">
                                请刷新页面以加载账户余额，或前往 
                                <a href="/okx-trading" class="underline font-semibold hover:text-yellow-900">OKX交易页面</a> 
                                配置账户API凭证
                            </p>
                        </div>
                    `;
                } else {
                    accountsHTML = '<div class="mt-4">';
                    accountsHTML += '<h5 class="font-bold text-gray-800 mb-2 flex items-center">';
                    accountsHTML += '<i class="fas fa-wallet text-blue-600 mr-2"></i>';
                    accountsHTML += '各账户建议开仓金额：</h5>';
                    accountsHTML += '<div class="space-y-2">';
                    
                    let totalSuggestedPosition = 0;
                    let accountsWithBalance = 0;
                    
                    accounts.forEach(account => {
                        if (account.balance && account.balance.availableBalance > 0) {
                            accountsWithBalance++;
                            const availBal = account.balance.availableBalance;
                            const positionSize = availBal * (threshold / 100);
                            const requiredMargin = positionSize / leverage;
                            
                            totalSuggestedPosition += positionSize;
                            
                            // 检查余额是否充足
                            const isSufficient = requiredMargin <= availBal;
                            const statusIcon = isSufficient ? '✅' : '⚠️';
                            const borderColor = isSufficient ? 'border-blue-200' : 'border-orange-300';
                            const bgColor = isSufficient ? 'bg-blue-50' : 'bg-orange-50';
                            
                            accountsHTML += `
                                <div class="p-3 ${bgColor} rounded border ${borderColor}">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-semibold text-gray-800">${statusIcon} ${account.name}</span>
                                        <span class="text-xs text-gray-500">可用: ${availBal.toFixed(2)} USDT</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">建议开仓:</span>
                                            <span class="font-bold text-blue-700 ml-1">${positionSize.toFixed(2)} USDT</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">需保证金:</span>
                                            <span class="font-bold text-purple-700 ml-1">${requiredMargin.toFixed(2)} USDT</span>
                                        </div>
                                    </div>
                                    ${!isSufficient ? '<div class="mt-1 text-xs text-orange-700">⚠️ 余额可能不足，请注意风险</div>' : ''}
                                </div>
                            `;
                        }
                    });
                    
                    accountsHTML += '</div>';
                    
                    // 添加总计信息
                    if (accountsWithBalance > 0) {
                        accountsHTML += `
                            <div class="mt-3 p-2 bg-gradient-to-r from-blue-100 to-purple-100 rounded border border-blue-300">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="font-semibold text-gray-800">
                                        <i class="fas fa-calculator mr-1"></i>
                                        总计 (${accountsWithBalance}个账户)
                                    </span>
                                    <span class="font-bold text-blue-800">
                                        ${totalSuggestedPosition.toFixed(2)} USDT
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                    accountsHTML += '</div>';
                }
                
                detailsDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold ${directionColor}">${directionIcon} ${directionText}</span>
                            <span class="text-gray-500">|</span>
                            <span>选择范围: <strong>${rangeText}</strong></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>触发条件: 等待${thresholdText} <strong class="text-orange-600">${threshold}%</strong> 后开仓</span>
                            <span class="text-gray-500">|</span>
                            <span>杠杆: <strong class="text-purple-600">${leverage}x</strong></span>
                        </div>
                        <div class="mt-3">
                            <strong>选中的币种（${targetCoins.length}个）:</strong>
                            ${coinsListHTML}
                        </div>
                        ${accountsHTML}
                        <div class="mt-3 p-3 bg-yellow-100 rounded border border-yellow-300">
                            <strong class="text-yellow-800">📌 下一步操作:</strong>
                            <p class="text-sm text-yellow-700 mt-1">
                                请前往 <a href="/okx-trading" class="underline font-semibold hover:text-yellow-900">OKX交易页面</a> 
                                根据各账户建议金额手动下单
                            </p>
                        </div>
                    </div>
                `;
                
                strategyDiv.classList.remove('hidden');
                
                // 滚动到策略详情
                strategyDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 保存当前策略到localStorage
                const strategyData = {
                    range,
                    threshold,
                    leverage,
                    direction,
                    targetCoins: targetCoins.map(c => ({
                        symbol: c.symbol,
                        change: c.change,
                        currentPrice: c.current_price
                    })),
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('currentStrategy', JSON.stringify(strategyData));
                
                console.log('✅ 策略已应用:', strategyData);
            }
            
            // 页面加载时恢复上次的策略
            function restoreLastStrategy() {
                const savedStrategy = localStorage.getItem('currentStrategy');
                if (savedStrategy) {
                    try {
                        const strategy = JSON.parse(savedStrategy);
                        // 检查策略是否在24小时内
                        const strategyTime = new Date(strategy.timestamp);
                        const now = new Date();
                        const hoursDiff = (now - strategyTime) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            console.log('🔄 恢复上次的策略...');
                            // 这里不自动应用，只是提示用户
                            console.log('上次策略:', strategy);
                        } else {
                            // 超过24小时，清除旧策略
                            localStorage.removeItem('currentStrategy');
                        }
                    } catch (e) {
                        console.error('恢复策略失败:', e);
                    }
                }
            }
            
            // ==================== 预警功能 ====================
            
            // 预警状态管理
            let alertState = {
                upperEnabled: false,
                lowerEnabled: false,
                upperThreshold: 300,
                lowerThreshold: -300,
                upperLastTriggerTime: null,  // 上限上次触发时间
                lowerLastTriggerTime: null,  // 下限上次触发时间
                lastCheckTime: null,
                tgEnabled: true,
                triggerInterval: 5 * 60 * 1000  // 5分钟内不重复触发
            };
            
            // 从后端加载预警设置
            async function loadAlertSettings() {
                try {
                    // 先从后端加载
                    const response = await fetch('/api/coin-tracker/alert-settings');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.settings) {
                            const settings = result.settings;
                            
                            // 更新alertState
                            alertState.upperThreshold = settings.upperThreshold || 5;
                            alertState.lowerThreshold = settings.lowerThreshold || -5;
                            alertState.upperEnabled = settings.upperEnabled || false;
                            alertState.lowerEnabled = settings.lowerEnabled || false;
                            alertState.tgEnabled = settings.tgEnabled || false;
                            // 从服务器加载时，重置触发时间（允许立即触发）
                            alertState.upperLastTriggerTime = settings.upperLastTriggerTime || null;
                            alertState.lowerLastTriggerTime = settings.lowerLastTriggerTime || null;
                            
                            // 强制更新UI（确保值被设置）
                            const upInput = document.getElementById('upThreshold');
                            const downInput = document.getElementById('downThreshold');
                            const upSwitch = document.getElementById('upAlertEnabled');
                            const downSwitch = document.getElementById('downAlertEnabled');
                            const tgSwitch = document.getElementById('tgEnabled');
                            
                            if (upInput) upInput.value = alertState.upperThreshold;
                            if (downInput) downInput.value = alertState.lowerThreshold;
                            if (upSwitch) upSwitch.checked = alertState.upperEnabled;
                            if (downSwitch) downSwitch.checked = alertState.lowerEnabled;
                            if (tgSwitch) tgSwitch.checked = alertState.tgEnabled;
                            
                            updateSwitchStyles();
                            console.log('✅ 预警设置已从服务器加载:', alertState);
                            console.log('📊 阈值已更新 - 上限:', alertState.upperThreshold, '下限:', alertState.lowerThreshold);
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('从服务器加载预警设置失败，尝试从localStorage加载:', e);
                }
                
                // 如果后端加载失败，尝试从localStorage加载
                const saved = localStorage.getItem('coinAlertSettings');
                if (saved) {
                    try {
                        const settings = JSON.parse(saved);
                        
                        // 更新alertState
                        alertState.upperThreshold = settings.upperThreshold || 5;
                        alertState.lowerThreshold = settings.lowerThreshold || -5;
                        alertState.upperEnabled = settings.upperEnabled || false;
                        alertState.lowerEnabled = settings.lowerEnabled || false;
                        alertState.tgEnabled = settings.tgEnabled || false;
                        // 从localStorage加载时，重置触发时间
                        alertState.upperLastTriggerTime = settings.upperLastTriggerTime || null;
                        alertState.lowerLastTriggerTime = settings.lowerLastTriggerTime || null;
                        
                        // 强制更新UI
                        const upInput = document.getElementById('upThreshold');
                        const downInput = document.getElementById('downThreshold');
                        const upSwitch = document.getElementById('upAlertEnabled');
                        const downSwitch = document.getElementById('downAlertEnabled');
                        const tgSwitch = document.getElementById('tgEnabled');
                        
                        if (upInput) upInput.value = alertState.upperThreshold;
                        if (downInput) downInput.value = alertState.lowerThreshold;
                        if (upSwitch) upSwitch.checked = alertState.upperEnabled;
                        if (downSwitch) downSwitch.checked = alertState.lowerEnabled;
                        if (tgSwitch) tgSwitch.checked = alertState.tgEnabled;
                        
                        updateSwitchStyles();
                        console.log('✅ 预警设置已从localStorage加载:', alertState);
                        console.log('📊 阈值已更新 - 上限:', alertState.upperThreshold, '下限:', alertState.lowerThreshold);
                    } catch (e) {
                        console.error('从localStorage加载预警设置失败:', e);
                    }
                }
            }
            
            // 保存预警设置到后端和localStorage
            async function saveAlertSettings() {
                // 保存到localStorage（本地备份）
                localStorage.setItem('coinAlertSettings', JSON.stringify(alertState));
                
                // 保存到后端
                try {
                    const response = await fetch('/api/coin-tracker/alert-settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(alertState)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('💾 预警设置已保存到服务器:', result);
                    } else {
                        console.error('保存到服务器失败，但已保存到localStorage');
                    }
                } catch (e) {
                    console.error('保存到服务器失败:', e, '但已保存到localStorage');
                }
            }
            
            // 更新开关样式
            function updateSwitchStyles() {
                const upperSwitch = document.getElementById('upAlertEnabled');
                const lowerSwitch = document.getElementById('downAlertEnabled');
                const upperLabel = upperSwitch.parentElement;
                const lowerLabel = lowerSwitch.parentElement;
                
                if (alertState.upperEnabled) {
                    upperLabel.classList.add('bg-green-500');
                    upperLabel.classList.remove('bg-gray-300');
                } else {
                    upperLabel.classList.remove('bg-green-500');
                    upperLabel.classList.add('bg-gray-300');
                }
                
                if (alertState.lowerEnabled) {
                    lowerLabel.classList.add('bg-green-500');
                    lowerLabel.classList.remove('bg-gray-300');
                } else {
                    lowerLabel.classList.remove('bg-green-500');
                    lowerLabel.classList.add('bg-gray-300');
                }
            }
            
            
            // 初始化音频上下文
            async function initAudio() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        audioInitialized = true;
                        console.log('✅ 音频上下文已初始化, state:', audioContext.state);
                    } catch (e) {
                        console.error('❌ 音频上下文初始化失败:', e);
                        return false;
                    }
                }
                
                // 如果音频上下文被暂停，恢复它
                if (audioContext && audioContext.state === 'suspended') {
                    try {
                        await audioContext.resume();
                        console.log('✅ 音频上下文已恢复, state:', audioContext.state);
                    } catch (e) {
                        console.error('❌ 音频上下文恢复失败:', e);
                        return false;
                    }
                }
                
                return audioContext && audioContext.state === 'running';
            }
            
            // 播放单次哔声
            function playBeep(frequency, duration, delay) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        try {
                            if (!audioContext) {
                                console.warn('⚠️ 音频上下文未初始化');
                                resolve();
                                return;
                            }
                            
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = frequency;
                            oscillator.type = 'sine'; // 使用正弦波，更温和
                            
                            // 音量设置
                            const now = audioContext.currentTime;
                            gainNode.gain.setValueAtTime(0, now);
                            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                            gainNode.gain.linearRampToValueAtTime(0.3, now + duration - 0.01);
                            gainNode.gain.linearRampToValueAtTime(0, now + duration);
                            
                            oscillator.start(now);
                            oscillator.stop(now + duration);
                            
                            console.log(`🔊 播放哔声: ${frequency}Hz`);
                            
                            setTimeout(resolve, duration * 1000);
                        } catch (e) {
                            console.error('❌ 播放哔声失败:', e);
                            resolve();
                        }
                    }, delay);
                });
            }
            
            // 播放预警音效（循环播放，直到停止）
            async function playAlertSound() {
                console.log('🎵 playAlertSound 被调用');
                
                // 确保音频已初始化并运行
                const audioReady = await initAudio();
                
                if (!audioReady || !audioContext) {
                    console.error('❌ 无法创建音频上下文或音频未就绪');
                    alert('⚠️ 无法播放声音！请检查浏览器权限设置。\n\n提示：某些浏览器需要用户交互后才能播放声音。');
                    return;
                }
                
                console.log('✅ 音频系统就绪, AudioContext state:', audioContext.state);
                
                // 停止之前的循环（如果有）
                stopAlertSound();
                
                // 标记为正在播放
                alertSoundLoop = { playing: true };
                
                // 循环播放
                const playLoop = async () => {
                    try {
                        while (alertSoundLoop && alertSoundLoop.playing) {
                            console.log('🔊 播放一轮预警音效...');
                            
                            // 播放5次哔声：高-低-高-低-高
                            if (!alertSoundLoop.playing) break;
                            await playBeep(1000, 0.2, 0);    // 第1次
                            
                            if (!alertSoundLoop.playing) break;
                            await playBeep(800, 0.2, 100);   // 第2次
                            
                            if (!alertSoundLoop.playing) break;
                            await playBeep(1000, 0.2, 100);  // 第3次
                            
                            if (!alertSoundLoop.playing) break;
                            await playBeep(800, 0.2, 100);   // 第4次
                            
                            if (!alertSoundLoop.playing) break;
                            await playBeep(1000, 0.3, 100);  // 第5次（稍长）
                            
                            // 等待1秒后再播放下一轮
                            if (alertSoundLoop.playing) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        console.log('🔇 预警音效循环结束');
                    } catch (e) {
                        console.error('❌ 播放音效失败:', e);
                    }
                };
                
                // 开始播放
                playLoop();
            }
            
            // 停止预警音效
            function stopAlertSound() {
                if (alertSoundLoop) {
                    console.log('🔇 停止预警音效');
                    alertSoundLoop.playing = false;
                    alertSoundLoop = null;
                }
            }
            
            // 发送Telegram通知
            async function sendTelegramAlert(message) {
                try {
                    const response = await fetch('/api/telegram/send-alert', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            type: 'coin_alert'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Telegram通知已发送:', result);
                        return true;
                    } else {
                        console.error('❌ Telegram通知发送失败:', response.status);
                        return false;
                    }
                } catch (e) {
                    console.error('发送Telegram通知异常:', e);
                    return false;
                }
            }
            
            // 显示预警弹窗（简化版，只显示阈值信息）
            function showAlertDialog(type, value, coins) {
                console.log('📢 showAlertDialog 被调用:', { type, value });
                
                // 先关闭已存在的弹窗
                const existingDialog = document.getElementById('alertDialog');
                if (existingDialog) {
                    console.log('🗑️ 关闭已存在的弹窗');
                    existingDialog.remove();
                }
                
                const title = type === 'upper' ? '🔴 涨幅预警触发' : '🟢 跌幅预警触发';
                const threshold = type === 'upper' ? alertState.upperThreshold : alertState.lowerThreshold;
                
                // 创建弹窗
                const dialog = document.createElement('div');
                dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center animate-fade-in';
                dialog.id = 'alertDialog';  // 添加ID方便关闭
                dialog.style.zIndex = '9999';  // 确保在最顶层
                dialog.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform animate-bounce-in">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">
                                ${type === 'upper' ? '📈' : '📉'}
                            </div>
                            <h2 class="text-3xl font-bold ${type === 'upper' ? 'text-red-600' : 'text-green-600'}">
                                ${title}
                            </h2>
                        </div>
                        <div class="bg-gradient-to-r ${type === 'upper' ? 'from-red-50 to-orange-50 border-red-200' : 'from-green-50 to-blue-50 border-green-200'} border-2 rounded-xl p-6 mb-6">
                            <div class="text-center space-y-3">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">当前累计涨跌幅</p>
                                    <p class="text-4xl font-bold ${value > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${value > 0 ? '+' : ''}${value.toFixed(2)}%
                                    </p>
                                </div>
                                <div class="border-t-2 border-dashed ${type === 'upper' ? 'border-red-200' : 'border-green-200'} pt-3">
                                    <p class="text-sm text-gray-600 mb-1">设定阈值</p>
                                    <p class="text-2xl font-semibold text-gray-700">
                                        ${threshold > 0 ? '+' : ''}${threshold}%
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center space-y-3">
                            <div class="flex justify-center space-x-3 w-full">
                                <button id="closeDialogBtn"
                                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition transform hover:scale-105 font-medium shadow-lg">
                                    知道了
                                </button>
                                <button id="refreshDialogBtn"
                                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition transform hover:scale-105 font-medium shadow-lg">
                                    刷新数据
                                </button>
                            </div>
                            <button id="testDialogSoundBtn"
                                    class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition transform hover:scale-105 font-medium shadow-md text-sm">
                                🔊 测试声音
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // 关闭弹窗的函数
                const closeDialog = () => {
                    console.log('🔘 关闭弹窗');
                    stopAlertSound();
                    const dialogElement = document.getElementById('alertDialog');
                    if (dialogElement) {
                        dialogElement.remove();
                        console.log('✅ 弹窗已关闭');
                    }
                    // 移除ESC键监听器
                    document.removeEventListener('keydown', escHandler);
                };
                
                // ESC键关闭
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        console.log('⌨️ 按下ESC键关闭弹窗');
                        closeDialog();
                    }
                };
                document.addEventListener('keydown', escHandler);
                
                // 点击遮罩层关闭
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        console.log('🖱️ 点击遮罩层关闭弹窗');
                        closeDialog();
                    }
                });
                
                // 添加事件监听器
                document.getElementById('closeDialogBtn').addEventListener('click', () => {
                    console.log('🔘 点击了知道了按钮');
                    closeDialog();
                });
                
                document.getElementById('refreshDialogBtn').addEventListener('click', () => {
                    console.log('🔘 点击了刷新数据按钮');
                    stopAlertSound();
                    location.reload();
                });
                
                document.getElementById('testDialogSoundBtn').addEventListener('click', function() {
                    testDialogSound(this);
                });
            }
            
            // 检查预警条件
            async function checkAlerts(currentData) {
                console.log('🔍 checkAlerts 被调用，数据:', currentData);
                
                if (!currentData || !currentData.cumulative_pct) {
                    console.warn('⚠️ 数据无效，跳过预警检查');
                    return;
                }
                
                const currentValue = currentData.cumulative_pct;
                const now = Date.now();
                
                console.log(`📊 当前值: ${currentValue}, 上限: ${alertState.upperThreshold}, 下限: ${alertState.lowerThreshold}`);
                console.log(`🔔 上限开关: ${alertState.upperEnabled}, 下限开关: ${alertState.lowerEnabled}`);
                
                // 避免频繁检查（最少间隔10秒）
                if (alertState.lastCheckTime && (now - alertState.lastCheckTime) < 10000) {
                    console.log('⏱️ 距离上次检查不足10秒，跳过');
                    return;
                }
                
                alertState.lastCheckTime = now;
                
                // 获取触发的币种
                const changes = currentData.changes || {};
                const triggerCoins = [];
                
                Object.entries(changes).forEach(([symbol, data]) => {
                    if (!data.error && Math.abs(data.change_pct) > 10) {
                        triggerCoins.push({
                            symbol: symbol.replace('-USDT-SWAP', ''),
                            change: data.change_pct.toFixed(2)
                        });
                    }
                });
                
                // 检查上限预警
                if (alertState.upperEnabled && currentValue >= alertState.upperThreshold) {
                    // 检查是否在间隔时间内
                    const timeSinceLastTrigger = alertState.upperLastTriggerTime 
                        ? now - alertState.upperLastTriggerTime 
                        : Infinity;
                    
                    if (timeSinceLastTrigger >= alertState.triggerInterval) {
                        console.log('🔴 触发上限预警:', currentValue, '>=', alertState.upperThreshold);
                        console.log(`⏱️ 距离上次触发: ${timeSinceLastTrigger === Infinity ? '未触发过' : Math.round(timeSinceLastTrigger/1000) + '秒'}`);
                        
                        // 记录触发时间
                        alertState.upperLastTriggerTime = now;
                        
                        // 确保音频已初始化并运行
                        await initAudio();
                        
                        // 开始播放音效（循环）
                        playAlertSound();
                        
                        // 显示弹窗
                        showAlertDialog('upper', currentValue, triggerCoins);
                        
                        // 发送Telegram通知
                        const message = `🔴 涨幅预警触发！\n\n当前累计涨跌幅: +${currentValue.toFixed(2)}%\n已达到设定阈值: +${alertState.upperThreshold}%`;
                        sendTelegramAlert(message);
                        
                        // 保存设置
                        saveAlertSettings();
                    } else {
                        const waitTime = Math.round((alertState.triggerInterval - timeSinceLastTrigger) / 1000);
                        console.log(`⏱️ 上限预警已触发，还需等待 ${waitTime} 秒才能再次触发`);
                    }
                }
                
                // 检查下限预警
                if (alertState.lowerEnabled && currentValue <= alertState.lowerThreshold) {
                    // 检查是否在间隔时间内
                    const timeSinceLastTrigger = alertState.lowerLastTriggerTime 
                        ? now - alertState.lowerLastTriggerTime 
                        : Infinity;
                    
                    if (timeSinceLastTrigger >= alertState.triggerInterval) {
                        console.log('🟢 触发下限预警:', currentValue, '<=', alertState.lowerThreshold);
                        console.log(`⏱️ 距离上次触发: ${timeSinceLastTrigger === Infinity ? '未触发过' : Math.round(timeSinceLastTrigger/1000) + '秒'}`);
                        
                        // 记录触发时间
                        alertState.lowerLastTriggerTime = now;
                        
                        // 确保音频已初始化并运行
                        await initAudio();
                        
                        // 开始播放音效（循环）
                        playAlertSound();
                        
                        // 显示弹窗
                        showAlertDialog('lower', currentValue, triggerCoins);
                        
                        // 发送Telegram通知
                        const message = `🟢 跌幅预警触发！\n\n当前累计涨跌幅: ${currentValue.toFixed(2)}%\n已达到设定阈值: ${alertState.lowerThreshold}%`;
                        sendTelegramAlert(message);
                        
                        // 保存设置
                        saveAlertSettings();
                    } else {
                        const waitTime = Math.round((alertState.triggerInterval - timeSinceLastTrigger) / 1000);
                        console.log(`⏱️ 下限预警已触发，还需等待 ${waitTime} 秒才能再次触发`);
                    }
                }
            }
            
            // 绑定预警设置事件
            document.getElementById('upThreshold').addEventListener('change', (e) => {
                alertState.upperThreshold = parseFloat(e.target.value);
                alertState.upperLastTriggerTime = null; // 重置触发时间
                saveAlertSettings();
                console.log('上限阈值已更新:', alertState.upperThreshold);
            });
            
            document.getElementById('downThreshold').addEventListener('change', (e) => {
                alertState.lowerThreshold = parseFloat(e.target.value);
                alertState.lowerLastTriggerTime = null; // 重置触发时间
                saveAlertSettings();
                console.log('下限阈值已更新:', alertState.lowerThreshold);
            });
            
            document.getElementById('upAlertEnabled').addEventListener('change', (e) => {
                alertState.upperEnabled = e.target.checked;
                if (alertState.upperEnabled) {
                    alertState.upperLastTriggerTime = null; // 重新开启时重置触发时间
                }
                updateSwitchStyles();
                saveAlertSettings();
                console.log('上限预警', alertState.upperEnabled ? '已开启' : '已关闭');
            });
            
            document.getElementById('downAlertEnabled').addEventListener('change', (e) => {
                alertState.lowerEnabled = e.target.checked;
                if (alertState.lowerEnabled) {
                    alertState.lowerLastTriggerTime = null; // 重新开启时重置触发时间
                }
                updateSwitchStyles();
                saveAlertSettings();
                console.log('下限预警', alertState.lowerEnabled ? '已开启' : '已关闭');
            });
            
            // 保存按钮点击事件
            document.getElementById('saveAlertSettings').addEventListener('click', async () => {
                // 读取当前设置
                alertState.upperThreshold = parseFloat(document.getElementById('upThreshold').value || 5);
                alertState.lowerThreshold = parseFloat(document.getElementById('downThreshold').value || -5);
                alertState.upperEnabled = document.getElementById('upAlertEnabled').checked;
                alertState.lowerEnabled = document.getElementById('downAlertEnabled').checked;
                alertState.tgEnabled = document.getElementById('tgEnabled').checked;
                
                // 保存到后端和localStorage
                await saveAlertSettings();
                
                // 显示保存成功提示
                const successDiv = document.getElementById('saveSuccess');
                successDiv.classList.remove('hidden');
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    successDiv.classList.add('hidden');
                }, 3000);
                
                console.log('✅ 预警设置已手动保存:', alertState);
            });
            
            // 测试声音按钮
            document.getElementById('testSound').addEventListener('click', async () => {
                console.log('🔊 测试声音功能');
                
                // 显示提示
                const originalText = document.getElementById('testSound').innerHTML;
                document.getElementById('testSound').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>播放中...';
                document.getElementById('testSound').disabled = true;
                
                // 确保音频已初始化并运行
                const audioReady = await initAudio();
                
                // 检查音频状态
                if (!audioReady || !audioContext) {
                    alert('⚠️ 音频上下文未初始化！\n\n请先点击页面任意位置，然后再试。');
                    document.getElementById('testSound').innerHTML = originalText;
                    document.getElementById('testSound').disabled = false;
                    return;
                }
                
                console.log('✅ 音频系统就绪, AudioContext state:', audioContext.state);
                
                // 播放音效
                try {
                    await playAlertSound();
                    
                    // 显示成功提示
                    alert('✅ 声音测试完成！\n\n如果您听到了5次哔哔声，说明声音功能正常。\n\n如果没有听到声音，请检查：\n1. 系统音量是否开启\n2. 浏览器标签页是否静音\n3. 是否使用耳机/扬声器');
                } catch (e) {
                    console.error('❌ 播放声音失败:', e);
                    alert('❌ 播放声音失败！\n\n错误信息: ' + e.message + '\n\n请检查：\n1. 浏览器是否允许音频播放\n2. 系统音量设置\n3. 浏览器控制台是否有错误');
                }
                
                // 恢复按钮状态
                document.getElementById('testSound').innerHTML = originalText;
                document.getElementById('testSound').disabled = false;
            });
            
            // 弹窗中的测试声音函数
            async function testDialogSound(button) {
                console.log('🔊 弹窗测试声音功能');
                
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 播放中...';
                button.disabled = true;
                
                // 确保音频已初始化并运行
                const audioReady = await initAudio();
                
                // 播放音效
                try {
                    if (audioReady && audioContext) {
                        console.log('✅ 音频系统就绪, 开始播放');
                        await playAlertSound();
                        console.log('✅ 声音播放完成');
                        button.innerHTML = '✅ 播放完成';
                    } else {
                        console.error('❌ 音频系统未就绪');
                        button.innerHTML = '❌ 音频未就绪';
                    }
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                } catch (e) {
                    console.error('❌ 播放声音失败:', e);
                    button.innerHTML = '❌ 播放失败';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            }
            
            // 重置按钮点击事件
            // 测试预警按钮
            document.getElementById('testAlert').addEventListener('click', async () => {
                console.log('🧪 手动测试预警功能');
                
                // 确保音频已初始化
                initAudio();
                
                // 播放音效
                await playAlertSound();
                
                // 显示简化弹窗（不需要币种信息）
                showAlertDialog('upper', 35.5, []);
                
                // 显示测试提示
                const alertLog = document.getElementById('alertLog');
                const alertMessage = document.getElementById('alertMessage');
                if (alertLog && alertMessage) {
                    alertMessage.textContent = '🧪 测试预警已触发！这是一个模拟预警，用于测试音效和弹窗功能。';
                    alertLog.classList.remove('hidden');
                    alertLog.classList.remove('bg-yellow-50');
                    alertLog.classList.add('bg-purple-50');
                    
                    const borderEl = alertLog.querySelector('.border-yellow-400');
                    if (borderEl) {
                        borderEl.classList.remove('border-yellow-400');
                        borderEl.classList.add('border-purple-400');
                    }
                    
                    setTimeout(() => {
                        alertLog.classList.add('hidden');
                        alertLog.classList.remove('bg-purple-50');
                        alertLog.classList.add('bg-yellow-50');
                        const borderEl = alertLog.querySelector('.border-purple-400');
                        if (borderEl) {
                            borderEl.classList.remove('border-purple-400');
                            borderEl.classList.add('border-yellow-400');
                        }
                    }, 5000);
                }
            });
            
            document.getElementById('resetAlertSettings').addEventListener('click', async () => {
                // 恢复默认值
                alertState = {
                    upperEnabled: false,
                    lowerEnabled: false,
                    tgEnabled: false,
                    upperThreshold: 5,
                    lowerThreshold: -5,
                    upperTriggered: false,
                    lowerTriggered: false,
                    lastCheckTime: null
                };
                
                // 更新UI
                document.getElementById('upThreshold').value = 5;
                document.getElementById('downThreshold').value = -5;
                document.getElementById('upAlertEnabled').checked = false;
                document.getElementById('downAlertEnabled').checked = false;
                document.getElementById('tgEnabled').checked = false;
                
                updateSwitchStyles();
                await saveAlertSettings();
                
                // 显示提示
                const alertLog = document.getElementById('alertLog');
                const alertMessage = document.getElementById('alertMessage');
                alertMessage.textContent = '已恢复默认设置：上限5%，下限-5%，开关已关闭';
                alertLog.classList.remove('hidden');
                
                setTimeout(() => {
                    alertLog.classList.add('hidden');
                }, 3000);
                
                console.log('🔄 预警设置已恢复默认');
            });
            
            // 在updateData函数中添加预警检查（已禁用，因为updateData不存在）
            // const originalUpdateData = updateData;
            // window.updateData = async function() {
            //     await originalUpdateData();
            //     
            //     // 检查预警
            //     const latestResponse = await fetch('/api/coin-change-tracker/latest');
            //     if (latestResponse.ok) {
            //         const latestData = await latestResponse.json();
            //         checkAlerts(latestData);
            //     }
            // };
            
            // 页面加载时加载预警设置（立即执行，确保最先加载）
            loadAlertSettings().then(() => {
                console.log('🎯 页面加载完成，预警设置已加载');
                // 二次确认：500ms后再次验证输入框的值
                setTimeout(() => {
                    const upValue = document.getElementById('upThreshold').value;
                    const downValue = document.getElementById('downThreshold').value;
                    console.log('🔍 500ms后验证 - 上限输入框值:', upValue, '下限输入框值:', downValue);
                    console.log('🔍 500ms后验证 - alertState:', JSON.stringify(alertState));
                    
                    // 如果不匹配，强制再次设置
                    if (upValue != alertState.upperThreshold || downValue != alertState.lowerThreshold) {
                        console.warn('⚠️ 检测到值不匹配，强制重新设置！');
                        document.getElementById('upThreshold').value = alertState.upperThreshold;
                        document.getElementById('downThreshold').value = alertState.lowerThreshold;
                    }
                }, 500);
            });
            
            // 预警设置加载完成后，立即检查一次（延迟2秒确保函数已定义）
            setTimeout(async () => {
                console.log('🧪 执行延迟预警检查...');
                try {
                    const url = `/api/coin-change-tracker/latest?_t=${Date.now()}`;
                    const response = await fetch(url, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            console.log('🧪 手动触发预警检查，当前值:', result.data.total_change);
                            if (typeof checkAlerts === 'function') {
                                checkAlerts({
                                    cumulative_pct: result.data.total_change,
                                    changes: result.data.changes
                                });
                            } else {
                                console.error('❌ checkAlerts 函数仍未定义');
                            }
                        }
                    }
                } catch (e) {
                    console.error('❌ 手动预警检查失败:', e);
                }
            }, 2000);
            
            // ==================== 预警功能结束 ====================
            
            // ==================== RSI止盈功能已移除 ====================
            // 说明：coin-change-tracker页面不再包含RSI止盈交易功能
            // RSI数据仅用于展示，自动止盈由后台rsi-takeprofit-monitor负责
            
            scheduleAutoPageRefresh();
            
            // ==================== RSI止盈功能已移除 ====================
            // 说明：coin-change-tracker页面不再包含RSI止盈交易功能
            // RSI数据仅用于展示，自动止盈由后台rsi-takeprofit-monitor负责
            
            // 窗口大小改变时重绘图表
            window.addEventListener('resize', () => {
                trendChart.resize();
                rankChart.resize();
            });
            
            // 🆕 添加 Page Visibility API 监听
            // 解决浏览器标签页切换到后台时，定时器被暂停的问题
            let lastVisibilityChange = Date.now();
            let wasHidden = false;
            
            document.addEventListener('visibilitychange', async () => {
                if (document.hidden) {
                    // 页面隐藏时
                    wasHidden = true;
                    lastVisibilityChange = Date.now();
                    console.log('👀 页面已隐藏，定时器可能被暂停');
                } else {
                    // 页面重新可见时
                    const hiddenDuration = Date.now() - lastVisibilityChange;
                    console.log(`👀 页面重新可见，隐藏时长: ${Math.floor(hiddenDuration / 1000)}秒`);
                    
                    // 如果隐藏超过1分钟，立即刷新数据
                    if (wasHidden && hiddenDuration > 60000) {
                        console.log('🔄 页面长时间隐藏，立即刷新数据...');
                        try {
                            await updateLatestData();
                            await loadMarketSentiment();
                            await updateHistoryData(currentDate);
                            console.log('✅ 数据刷新完成');
                        } catch (error) {
                            console.error('❌ 数据刷新失败:', error);
                        }
                    }
                    wasHidden = false;
                }
            });
            
            // 🆕 添加窗口聚焦监听（作为备用机制）
            window.addEventListener('focus', async () => {
                const timeSinceLastUpdate = Date.now() - lastVisibilityChange;
                if (timeSinceLastUpdate > 300000) { // 5分钟
                    console.log('🔄 窗口重新聚焦且超过5分钟，刷新数据...');
                    try {
                        await updateLatestData();
                        await loadMarketSentiment();
                        await updateHistoryData(currentDate);
                        console.log('✅ 数据刷新完成');
                    } catch (error) {
                        console.error('❌ 数据刷新失败:', error);
                    }
                }
            });
        };
        
        // 文档面板切换函数
        function toggleDocPanel() {
            const content = document.getElementById('docPanelContent');
            const icon = document.getElementById('docPanelIcon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
                localStorage.setItem('docPanelOpen', 'true');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
                localStorage.setItem('docPanelOpen', 'false');
            }
        }
        
        // 页面加载时恢复文档面板状态
        window.addEventListener('DOMContentLoaded', () => {
            const docPanelOpen = localStorage.getItem('docPanelOpen');
            if (docPanelOpen === 'true') {
                toggleDocPanel();
            }
        });
    </script>
</body>
</html>
