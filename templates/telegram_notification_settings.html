<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramé€šçŸ¥è®¾ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .settings-card h2 {
            color: #1f2937;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .toggle-item:last-child {
            border-bottom: none;
        }

        .toggle-label {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .toggle-description {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #10b981;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .save-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
        }

        .save-btn:hover {
            background: #059669;
        }

        .save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš™ï¸ Telegramé€šçŸ¥è®¾ç½®</h1>
            <div class="header-buttons">
                <a href="/" class="btn">ğŸ  è¿”å›é¦–é¡µ</a>
                <a href="/telegram-dashboard" class="btn">ğŸ“± æŸ¥çœ‹æ¨é€å†å²</a>
            </div>
        </div>

        <!-- é‡å¤§äº‹ä»¶ç›‘æ§ç³»ç»Ÿ -->
        <div class="settings-card">
            <h2>ğŸš¨ é‡å¤§äº‹ä»¶ç›‘æ§ç³»ç»Ÿï¼ˆ9ä¸ªäº‹ä»¶ï¼‰</h2>
            <div id="majorEventsToggles">
                <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- å…¶ä»–ç³»ç»Ÿ -->
        <div class="settings-card">
            <h2>ğŸ“Š å…¶ä»–ç›‘æ§ç³»ç»Ÿ</h2>
            <div id="otherSystemsToggles">
                <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <button class="save-btn" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
        <div class="status-message" id="statusMessage"></div>
    </div>

    <script>
        let config = null;

        // ç³»ç»Ÿæè¿°æ˜ å°„
        const systemDescriptions = {
            // é‡å¤§äº‹ä»¶ (ä½¿ç”¨å®é™…çš„äº‹ä»¶é”®å)
            'events.general_top_escape': 'ğŸ“‰ 2hè§é¡¶ä¿¡å·â‰¥100ï¼Œå»ºè®®é€ƒé¡¶',
            'events.strong_top_escape': 'ğŸ”¥ 2hè§é¡¶ä¿¡å·â‰¥120ï¼Œå¼ºçƒˆé€ƒé¡¶ä¿¡å·',
            'events.strong_short_liquidation': 'ğŸ’¥ çˆ†ä»“é‡‘é¢â‰¥2500ä¸‡ï¼Œ10åˆ†é’Ÿå†…æŒç»­æ–°é«˜',
            'events.weak_short_liquidation': 'ğŸ’¥ çˆ†ä»“é‡‘é¢â‰¥2500ä¸‡ï¼Œä½†æœªæŒç»­æ–°é«˜',
            'events.red_to_green_mark': 'ğŸ”„ å¤šç©ºç›ˆåˆ©æ ‡è®°ä»çº¢è‰²è½¬ç»¿è‰²ï¼Œå¸‚åœºè½¬å¼±',
            'events.green_to_red_mark': 'ğŸ”„ å¤šç©ºç›ˆåˆ©æ ‡è®°ä»ç»¿è‰²è½¬çº¢è‰²ï¼Œå¸‚åœºè½¬å¼º',
            'events.extreme_rally_pullback': 'ğŸ“ˆ æ€»æ¶¨è·Œå¹…â‰¥50ä¸”SARåç©ºâ‰¥20ä¸ªå¸ç§',
            'events.extreme_drop_rebound': 'ğŸ“‰ æ€»æ¶¨è·Œå¹…â‰¤-50ä¸”SARåå¤šâ‰¥7ä¸ªå¸ç§',
            'events.super_liquidation_drop': 'ğŸŒŠ 1hçˆ†ä»“â‰¥1.5äº¿åä¸»è·Œï¼Œæç«¯ä¿¡å·',
            
            // å…¶ä»–ç³»ç»Ÿ
            'extreme_tracking': 'ğŸ¯ æ¥æºï¼šextreme_value_tracker.py | 27ä¸ªå¸ç§æå€¼çªç ´æé†’ï¼ˆä¸­åº¦/é‡åº¦è·³å¹…ï¼‰',
            'support_resistance': 'ğŸ“ æ¥æºï¼šsupport_resistance_snapshot.py | æ”¯æ’‘å‹åŠ›çº¿çªç ´ä¿¡å·',
            'alert_system': 'âš ï¸ æ¥æºï¼šæœªçŸ¥ | è®¡æ¬¡é¢„è­¦ç³»ç»Ÿï¼ˆéœ€ç¡®è®¤å…·ä½“æ¥æºï¼‰',
            'trading_signals': 'ğŸ’¹ æ¥æºï¼šæœªçŸ¥ | äº¤æ˜“ä¿¡å·ç³»ç»Ÿï¼ˆéœ€ç¡®è®¤å…·ä½“æ¥æºï¼‰'
        };

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/telegram/notification-config');
                const data = await response.json();
                
                if (data.success) {
                    config = data.data;
                    renderToggles();
                } else {
                    showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“å¼€å…³
        function renderToggles() {
            // æ¸²æŸ“é‡å¤§äº‹ä»¶å¼€å…³
            const majorEventsContainer = document.getElementById('majorEventsToggles');
            majorEventsContainer.innerHTML = '';
            
            // æ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼ï¼šmajor_events æˆ– events
            const majorEvents = config.major_events || config.events || {};
            Object.keys(majorEvents).forEach(eventKey => {
                const event = majorEvents[eventKey];
                const item = createToggleItem(
                    `events.${eventKey}`,
                    event.name,
                    event.enabled
                );
                majorEventsContainer.appendChild(item);
            });

            // æ¸²æŸ“å…¶ä»–ç³»ç»Ÿå¼€å…³
            const otherSystemsContainer = document.getElementById('otherSystemsToggles');
            otherSystemsContainer.innerHTML = '';
            
            const otherSystems = [
                { key: 'extreme_tracking', data: config.extreme_tracking },
                { key: 'support_resistance', data: config.support_resistance },
                { key: 'alert_system', data: config.alert_system },
                { key: 'trading_signals', data: config.trading_signals }
            ];

            otherSystems.forEach(system => {
                if (system.data) {
                    const item = createToggleItem(
                        system.key,
                        system.data.name,
                        system.data.enabled
                    );
                    otherSystemsContainer.appendChild(item);
                }
            });
        }

        // åˆ›å»ºå¼€å…³é¡¹
        function createToggleItem(dataKey, label, enabled) {
            const item = document.createElement('div');
            item.className = 'toggle-item';
            
            const labelDiv = document.createElement('div');
            
            // ä¸»æ ‡ç­¾
            const labelSpan = document.createElement('div');
            labelSpan.className = 'toggle-label';
            labelSpan.textContent = label;
            labelDiv.appendChild(labelSpan);
            
            // æ·»åŠ æè¿°ä¿¡æ¯
            const description = systemDescriptions[dataKey];
            if (description) {
                const descSpan = document.createElement('div');
                descSpan.className = 'toggle-description';
                descSpan.textContent = description;
                labelDiv.appendChild(descSpan);
            }
            
            const switchLabel = document.createElement('label');
            switchLabel.className = 'toggle-switch';
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.checked = enabled;
            input.dataset.key = dataKey;
            
            const slider = document.createElement('span');
            slider.className = 'slider';
            
            switchLabel.appendChild(input);
            switchLabel.appendChild(slider);
            
            item.appendChild(labelDiv);
            item.appendChild(switchLabel);
            
            return item;
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            try {
                // æ”¶é›†æ‰€æœ‰å¼€å…³çŠ¶æ€
                const inputs = document.querySelectorAll('input[type="checkbox"]');
                
                inputs.forEach(input => {
                    const keys = input.dataset.key.split('.');
                    const checked = input.checked;
                    
                    if (keys.length === 2 && keys[0] === 'events') {
                        // é‡å¤§äº‹ä»¶ï¼ˆä½¿ç”¨eventså­—æ®µï¼‰
                        if (config.events && config.events[keys[1]]) {
                            config.events[keys[1]].enabled = checked;
                        } else if (config.major_events && config.major_events[keys[1]]) {
                            // å…¼å®¹æ—§æ ¼å¼
                            config.major_events[keys[1]].enabled = checked;
                        }
                    } else {
                        // å…¶ä»–ç³»ç»Ÿ
                        if (config[keys[0]]) {
                            config[keys[0]].enabled = checked;
                        }
                    }
                });

                // å‘é€åˆ°æœåŠ¡å™¨
                const response = await fetch('/api/telegram/notification-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('âœ… è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼', 'success');
                } else {
                    showMessage('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.textContent = message;
            msgDiv.className = 'status-message ' + type;
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®
        window.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>
